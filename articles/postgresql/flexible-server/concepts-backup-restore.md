---
title: 在 Azure Database for PostgreSQL 灵活服务器中进行备份和还原
description: 了解使用 Azure Database for PostgreSQL 灵活服务器进行备份和还原的概念
author: sr-msft
ms.author: srranga
ms.service: postgresql
ms.topic: conceptual
ms.date: 09/22/2020
ms.openlocfilehash: f5c0e8ae52d2af25c41550df1c59680d47360477
ms.sourcegitcommit: aba63ab15a1a10f6456c16cd382952df4fd7c3ff
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 04/25/2021
ms.locfileid: "107987841"
---
# <a name="backup-and-restore-in-azure-database-for-postgresql---flexible-server"></a>在 Azure Database for PostgreSQL 灵活服务器中进行备份和还原

> [!IMPORTANT]
> Azure Database for PostgreSQL 灵活服务器以预览版提供

备份是任何业务连续性策略不可或缺的部分。 它们有助于保护数据免于意外损坏或删除。 Azure Database for PostgreSQL 灵活服务器会自动备份服务器，并将备份保留长达 35 天。 还原时，你可指定你想要还原到的日期和时间（在保持期内）。 还原和恢复所需的总时间取决于数据库文件的大小和要执行的恢复量。 

### <a name="backup-process-in-flexible-server"></a>灵活服务器中的备份过程
第一次快照备份在创建灵活服务器后立即进行计划。 然后，对数据文件执行每日快照备份。 备份存储在区域内的区域冗余存储中。 事务日志（预写式日志 (WAL)）也会连续存档，以便你可还原到上次提交的事务。 可以通过这些数据和日志备份将服务器还原到所配置的备份保留期中的任意时间点。 所有备份都使用 AES 256 位加密进行加密。

如果数据库配置有高可用性，则从主副本执行每日快照，从备用副本执行连续日志备份。

> [!IMPORTANT]
>不会在已停止的服务器上执行备份。 但是，当数据库由用户启动或在 7 天后自动启动，则会恢复备份。

这些备份只能用于灵活服务器中的还原操作。 如果要将数据导出或导入到灵活服务器，请使用[转储并还原](../howto-migrate-using-dump-and-restore.md)方法。


### <a name="backup-retention"></a>备份保留期

备份是根据服务器的备份保持期设置保留的。 可指定一个 7 到 35 天的保留期。 默认保持期为 7 天。 可在服务器创建过程中设置保持期，也可稍后更新它。 即使对于已停止的服务器，也会保留备份。

备份保持期控制可往回检索多长时间的时间点还原，因为它基于可用备份。 从恢复的角度来看，备份保留期也可以视为恢复时段。 在备份保持期间内执行时间点还原所需的所有备份都保留在备份存储中。 例如，如果备份保持期设置为 7 天，则可认为恢复时段是最近 7 天。 在这种情况下，将保留在过去 7 天内还原和恢复服务器所需的所有数据和日志。 


### <a name="backup-storage-cost"></a>备份存储成本

灵活服务器最高提供 100% 的已预配服务器存储作为备份存储，不收取任何额外费用。 超出的备份存储使用量按每月每 GB 标准收费。 例如，如果为服务器预配了 250 GiB 的存储，则有 250 GiB 不额外收费的备份存储容量。 如果每日备份使用量为 25 GiB，则最多可有 10 天的免费备份存储。 超出 250 GiB 的备份存储消耗按[定价模型](https://azure.microsoft.com/pricing/details/postgresql/)收费。

可使用 Azure 门户中的“已使用的备份存储”指标来监视服务器占用的备份存储。 “已使用的备份存储”指标表示根据为服务器设置的备份保留期保留的所有数据库备份和日志备份占用的存储总和。  无论数据库的总大小如何，如果服务器上的事务性活动繁重，都会导致备份存储使用率增加。

控制备份存储成本的主要方法是设置适当的备份保留期，并选择正确的备份冗余选项以满足恢复目标。

> [!IMPORTANT]
> 灵活服务器目前不支持异地冗余备份。

## <a name="point-in-time-restore-overview"></a>时间点还原概述

在灵活服务器中，执行时间点还原后，会通过灵活服务器在源服务器所在区域中的备份创建新的服务器。 它在创建时，使用源服务器在定价层、计算的代、vCore 数、存储大小、备份保持期和备份冗余选项方面的配置。 此外，还会从源服务器继承标记和设置，例如 VNET 和防火墙设置。 

 > [!IMPORTANT]
> 如果要还原配置了区域冗余高可用性的灵活服务器，则还原的服务器将配置为不具有高可用性，并且与主服务器位于同一区域中。 

 ### <a name="restore-process"></a>还原过程

首先，将物理数据库文件从快照备份还原到服务器的数据位置。 这会自动选择并还原所需时间点之前进行的相应备份。 然后，使用 WAL 文件开始恢复过程，使数据库处于一致状态。 

 例如，假设在每晚 11 点执行备份。 如果还原点适用于 2020 年 8 月 15 日上午 10:00，则将还原 2020 年 8 月 14 日的每日备份。 将使用 8 月 24 日晚上 11 点到 8 月 25 日上午 10 点之间的事务日志备份来恢复该数据库，直到 2020 年 8 月 25 日上午 10 点为止。 

 请参阅[这些步骤](./how-to-restore-server-portal.md)来还原数据库服务器。

> [!IMPORTANT]
> 灵活服务器中的还原操作会创建新的数据库服务器，并且不会覆盖现有的数据库服务器。

多种情况下可以使用时间点还原。 例如，用户意外删除了数据、删除了重要的表或数据库，或者应用程序因为缺陷而意外地使用错误数据覆盖了正确数据。 由于事务日志的持续备份，你将能够还原到最近一个事务。

可在最新还原点和自定义还原点之间进行选择。

-   最新还原点（当前）：默认选项，利用该选项可将服务器还原到最新时间点。 

-   **自定义还原点**：通过此选项，可在为此灵活服务器定义的保持期内选择任何时间点。 默认情况下，UTC 中的最近时间是自动选择的；如果你想要还原到最近提交的事务来进行测试，那么最近时间非常有用。 可选择性地挑选其他日期和时间。 

预估的恢复时间取决于若干因素，包括数据库大小、要处理的事务日志量、网络带宽，以及在同一区域同时进行恢复的数据库总数。 整个恢复时间通常需要几分钟到几小时。


> [!IMPORTANT]
> 已删除的服务器 **无法** 还原。 如果删除服务器，则属于该服务器的所有数据库也会被删除且不可恢复。 为了防止服务器资源在部署后遭意外删除或意外更改，管理员可以利用[管理锁](../../azure-resource-manager/management/lock-resources.md)。

## <a name="perform-post-restore-tasks"></a>执行还原后任务

还原数据库后，可执行以下任务，来让你的用户和应用程序进行备份和运行：

-   如果需要使用新的服务器来替换原始服务器，请将客户端和客户端应用程序重定向到新服务器。

-   对于要进行连接的用户，请确保设置适当的服务器级防火墙规则和 VNet 规则。 不会从源服务器复制这些规则。
  
-   还原的服务器的计算可根据需要进行纵向扩展/缩减。

-   确保设置适当的登录名和数据库级权限。

-   视情况配置警报。
  
-  如果已还原配置了高可用性的数据库，并且想要配置具有高可用性的已还原服务器，则可以按照[步骤](./how-to-manage-high-availability-portal.md)进行操作。


## <a name="next-steps"></a>后续步骤

-   了解[业务连续性](./concepts-business-continuity.md)
-   了解[区域冗余高可用性](./concepts-high-availability.md)
-   了解[如何还原](./how-to-restore-server-portal.md)