---
title: 在 Azure Database for PostgreSQL 灵活服务器中进行备份和还原
description: 了解使用 Azure Database for PostgreSQL 灵活服务器进行备份和还原的概念
author: sr-msft
ms.author: srranga
ms.service: postgresql
ms.topic: conceptual
ms.date: 07/30/2021
ms.openlocfilehash: 8c6f3ebaa72457d93e4b3e491656f494511bd994
ms.sourcegitcommit: 0046757af1da267fc2f0e88617c633524883795f
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/13/2021
ms.locfileid: "121745150"
---
# <a name="backup-and-restore-in-azure-database-for-postgresql---flexible-server"></a>在 Azure Database for PostgreSQL 灵活服务器中进行备份和还原

> [!IMPORTANT]
> Azure Database for PostgreSQL 灵活服务器以预览版提供

备份是任何业务连续性策略不可或缺的部分。 它们有助于保护数据免于意外损坏或删除。 Azure Database for PostgreSQL 灵活服务器会自动备份服务器，并将备份保留长达 35 天。 还原时，你可指定你想要还原到的日期和时间（在保持期内）。 还原和恢复所需的总时间取决于数据库文件的大小和要执行的恢复量。 

### <a name="backup-process-in-flexible-server"></a>灵活服务器中的备份过程
第一次快照备份在创建灵活服务器后立即进行计划。 然后，对数据文件执行每日快照备份。 备份存储在区域内的区域冗余存储中。 事务日志（预写式日志 (WAL)）也会连续存档，以便你可还原到上次提交的事务。 可以通过这些数据和日志备份将服务器还原到所配置的备份保留期中的任意时间点。 所有备份都使用 AES 256 位加密进行加密。

如果数据库配置有高可用性，则从主副本执行每日快照，从备用副本执行连续日志备份。

> [!IMPORTANT]
>不会在已停止的服务器上执行备份。 但是，当数据库由用户启动或在 7 天后自动启动，则会恢复备份。

这些备份只能用于灵活服务器中的还原操作。 如果要将数据导出或导入到灵活服务器，请使用[转储并还原](../howto-migrate-using-dump-and-restore.md)方法。


### <a name="backup-retention"></a>备份保留期

备份是根据服务器的备份保持期设置保留的。 可指定一个 7 到 35 天的保留期。 默认保持期为 7 天。 可在服务器创建过程中设置保持期，也可稍后更新它。 即使对于已停止的服务器，也会保留备份。

备份保持期控制可往回检索多长时间的时间点还原，因为它基于可用备份。 从恢复的角度来看，备份保留期也可以视为恢复时段。 在备份保持期间内执行时间点还原所需的所有备份都保留在备份存储中。 例如，如果备份保持期设置为 7 天，则可认为恢复时段是最近 7 天。 在这种情况下，将保留在过去 7 天内还原和恢复服务器所需的所有数据和日志。 


### <a name="backup-storage-cost"></a>备份存储成本

灵活服务器最高提供 100% 的已预配服务器存储作为备份存储，不收取任何额外费用。 超出的备份存储使用量按每月每 GB 标准收费。 例如，如果为服务器预配了 250 GiB 的存储，则有 250 GiB 不额外收费的备份存储容量。 如果每日备份使用量为 25 GiB，则最多可有 10 天的免费备份存储。 超出 250 GiB 的备份存储消耗按[定价模型](https://azure.microsoft.com/pricing/details/postgresql/)收费。

可使用 Azure 门户中的“已使用的备份存储”指标来监视服务器占用的备份存储。 “已使用的备份存储”指标表示根据为服务器设置的备份保留期保留的所有数据库备份和日志备份占用的存储总和。  无论数据库的总大小如何，如果服务器上的事务性活动繁重，都会导致备份存储使用率增加。

控制备份存储成本的主要方法是设置适当的备份保留期，并选择正确的备份冗余选项以满足恢复目标。

> [!IMPORTANT]
> 灵活服务器目前不支持异地冗余备份。

## <a name="point-in-time-restore-overview"></a>时间点还原概述

在灵活服务器中，执行时间点还原后，会通过灵活服务器在源服务器所在区域中的备份创建新的服务器。 它在创建时，使用源服务器在定价层、计算的代、vCore 数、存储大小、备份保持期和备份冗余选项方面的配置。 此外，还会从源服务器继承标记和设置，例如 VNET 和防火墙设置。 

 > [!IMPORTANT]
> 如果要还原配置了区域冗余高可用性的灵活服务器，则还原的服务器将配置为不具有高可用性，并且与主服务器位于同一区域中。 

 ### <a name="restore-process"></a>还原过程

首先，将物理数据库文件从快照备份还原到服务器的数据位置。 这会自动选择并还原所需时间点之前进行的相应备份。 然后，使用 WAL 文件开始恢复过程，使数据库处于一致状态。 

 例如，假设在每晚 11 点执行备份。 如果还原点适用于 2020 年 8 月 15 日上午 10:00，则将还原 2020 年 8 月 14 日的每日备份。 将使用 8 月 24 日晚上 11 点到 8 月 25 日上午 10 点之间的事务日志备份来恢复该数据库，直到 2020 年 8 月 25 日上午 10 点为止。 

 请参阅[这些步骤](./how-to-restore-server-portal.md)来还原数据库服务器。

> [!IMPORTANT]
> 灵活服务器中的还原操作会创建新的数据库服务器，并且不会覆盖现有的数据库服务器。

多种情况下可以使用时间点还原。 例如，用户意外删除了数据、删除了重要的表或数据库，或者应用程序因为缺陷而意外地使用错误数据覆盖了正确数据。 由于事务日志的持续备份，你将能够还原到最近一个事务。

可在最新还原点和自定义还原点之间进行选择。

-   最新还原点（当前）：默认选项，利用该选项可将服务器还原到最新时间点。 

-   **自定义还原点**：通过此选项，可在为此灵活服务器定义的保持期内选择任何时间点。 默认情况下，UTC 中的最近时间是自动选择的；如果你想要还原到最近提交的事务来进行测试，那么最近时间非常有用。 可选择性地挑选其他日期和时间。 

预估的恢复时间取决于若干因素，包括数据库大小、要处理的事务日志量、网络带宽，以及在同一区域同时进行恢复的数据库总数。 整个恢复时间通常需要几分钟到几小时。

如果在 VNET 中配置了服务器，可将其还原到同一 VNET 或不同的 VNET。 但是，无法还原到用于公共访问的位置。 同样，如果为服务器配置了用于公共访问的位置，则无法还原到用于专用访问的位置。


> [!IMPORTANT]
> 已删除的服务器 **无法** 还原。 如果删除服务器，则属于该服务器的所有数据库也会被删除且不可恢复。 为了防止服务器资源在部署后遭意外删除或意外更改，管理员可以利用[管理锁](../../azure-resource-manager/management/lock-resources.md)。

## <a name="perform-post-restore-tasks"></a>执行还原后任务

还原数据库后，可执行以下任务，来让你的用户和应用程序进行备份和运行：

-   如果需要使用新的服务器来替换原始服务器，请将客户端和客户端应用程序重定向到新服务器。

-   对于要进行连接的用户，请确保设置适当的服务器级防火墙规则和 VNet 规则。 不会从源服务器复制这些规则。
  
-   还原的服务器的计算可根据需要进行纵向扩展/缩减。

-   确保设置适当的登录名和数据库级权限。

-   视情况配置警报。
  
-  如果已还原配置了高可用性的数据库，并且想要配置具有高可用性的已还原服务器，则可以按照[步骤](./how-to-manage-high-availability-portal.md)进行操作。

## <a name="frequently-asked-questions"></a>常见问题

### <a name="backup-related-questions"></a>备份相关问题

* Azure 如何处理服务器的备份？
 
    默认情况下，Azure Database for PostgreSQL 允许自动备份整个服务器（包含创建的所有数据库），且保留期默认为 7 天。 数据库的每日增量快照会被执行。 日志 (WAL) 文件会持续存档至 Azure BLOB。

* 是否可将这些自动备份配置为长期保留？
  
    否。 目前，我们仅支持最长保留 35 天。 你可以执行手动备份，然后使用这些备份来满足长期保留要求。

* 如何手动备份 Postgres 服务器？
  
    可按[此处](https://www.postgresql.org/docs/current/app-pgdump.html)所述，使用 PostgreSQL 工具 pg_dump 手动创建备份。 例如，可以参阅此[升级/迁移文档](../howto-migrate-using-dump-and-restore.md)，其中的内容同样适用于备份。 若要将 Azure Database for PostgreSQL 备份到 Blob 存储，请参阅技术社区博客[将 Azure Database for PostgreSQL 备份到 Blob 存储](https://techcommunity.microsoft.com/t5/azure-database-for-postgresql/backup-azure-database-for-postgresql-to-a-blob-storage/ba-p/803343)。 

* 服务器的备份时段是什么？我能否自定义它？
  
    备份时段本质上由 Azure 管理，无法自定义。 第一次完整快照备份在创建服务器后立即进行计划。 后续的快照备份是每天进行一次的增量备份。

* 我的备份是否加密？
  
    是的。 在查询执行过程中创建的所有 Azure Database for PostgreSQL 数据、备份和临时文件都使用 AES 256 位加密进行加密。 存储加密始终处于启用状态，无法禁用。 

* 是否可以在服务器中还原单个/数个数据库？
  
    不直接支持还原单个/数个数据库或表。 但是，需要将整个服务器还原到新服务器，然后提取所需的表或数据库并将其导入服务器。

* 备份正在进行时，我的服务器是否可用？
    是的。 备份是使用快照执行的联机操作。 快照操作只需几秒钟，不会影响生产工作负载，可确保服务器的高可用性。 

* 为服务器设置维护时段时，是否需要考虑备份时段？
  
    否。 备份作为托管服务的一部分在内部触发，对托管维护时段没有影响。

* 我的自动备份存储在何处，如何管理其保留期？
  
    Azure Database for PostgreSQL 会自动创建服务器备份，并自动将其存储在支持多个局部区域的 Azure 区域中的区域冗余存储内，或存储在尚不支持多个局部区域的 Azure 区域中的本地冗余存储内。 无法导出这些备份文件。 备份仅可用于将服务器还原到某个时间点。 默认的备份保留期为七天。 可以选择性地将备份保留期配置为最长 35 天。

* 如何在启用了高可用性的服务器中执行备份？
  
    灵活服务器的数据卷是使用主服务器中的托管磁盘增量快照进行备份的。 WAL 备份是从主服务器或备用服务器执行的。

* 如何验证是否在我的服务器上执行了备份？

    验证有效备份可用性的最佳方法是执行定期时间点还原，并确保备份有效且可还原。 不会向最终用户公开备份操作或文件。

* 在哪里可以查看备份使用情况？
  
    在 Azure 门户中的“监视”下，单击“指标”可以找到“备份使用情况指标”，可在其中监视备份总使用量。

* 如果删除服务器，我的备份会发生什么情况？
  
    如果删除服务器，则属于该服务器的所有备份也会被删除且不可恢复。 为了防止服务器资源在部署后遭意外删除或意外更改，管理员可以利用管理锁。

* 如何为已停止的服务器保留备份？

    不会对已停止的服务器执行任何新备份。 停止服务器时的（在保留时段内的）所有旧备份都将保留到服务器重新启动，服务器重新启动之后，活动服务器的备份保留期由其备份保留时段控制。

* 备份是如何计费的？
  
    灵活服务器最高提供 100% 的已预配服务器存储作为备份存储，不收取任何额外费用。 超出的备份存储使用量根据定价模型按每月每 GB 标准收费。 除了直接影响使用的备份存储总量的服务器上的事务活动之外，备份存储计费还受所选的备份保留期和备份冗余选项的控制。

* 对已停止的服务器是如何计费的？
  
    服务器实例已停止时，不会执行新的备份。 你需要为预配的存储和备份存储（在指定保留时段内存储的备份）付费。 免费备份存储仅限于预配数据库的大小，对于任何超额的备份数据，都将按备份价格收费。

* 我为服务器配置了区域冗余高可用性。你们是否会将备份数量算作两个，因此向我收费两次？
  
    否。 无论是在高可用性服务器还是非高可用性服务器上，都只会维护一组备份副本，因此只会向你收费一次。

### <a name="restore-related-questions"></a>还原相关问题

* 如何还原我的服务器？

    Azure 对所有服务器均支持时间点还原，使用户能够使用 Azure 门户、Azure CLI 和 API 还原到最新还原点或自定义还原点。 

    若要从使用 pg_dump 之类的工具手动创建的备份还原服务器，可以先创建一个灵活服务器，然后使用 [pg_restore](https://www.postgresql.org/docs/current/app-pgrestore.html) 将数据库还原到该服务器。

* 是否可以还原到同一 Azure 区域中的另一个可用性区域？
  
    是的。 如果你所在的 Azure 区域支持多个可用性区域，则备份将存储在 ZRS 帐户中，可供你还原到另一个可用性区域。 

* 执行时间点还原需要多长时间？为何我的还原花费了很多时间？
  
    从快照执行数据还原操作与数据大小无关，但是，需要应用日志（要重放的事务活动）的恢复过程所需的时间可能因所请求日期/时间的前一次备份以及要处理的日志量而异。 这一点适用于同一区域中的还原或还原到不同区域的情况。 
 
* 如果我还原启用了高可用性的服务器，是否会自动为还原服务器配置高可用性？
  
    否。 服务器将作为单实例灵活服务器还原。 还原完成后，可以选择性地为该服务器配置高可用性。

* 我在 VNET 中配置了服务器。是否可以还原到另一个 VNET？
  
    是的。 在还原时，请选择要还原到的其他 VNET。

* 是否可将公共访问服务器还原到 VNET，或反之？

    否。 我们目前不支持跨公共访问和专用访问还原服务器。

* 如何跟踪还原操作？
  
    目前无法跟踪还原操作。 可以监视活动日志，以查看操作是正在进行还是已完成。


## <a name="next-steps"></a>后续步骤

-   了解[业务连续性](./concepts-business-continuity.md)
-   了解[区域冗余高可用性](./concepts-high-availability.md)
-   了解[如何还原](./how-to-restore-server-portal.md)