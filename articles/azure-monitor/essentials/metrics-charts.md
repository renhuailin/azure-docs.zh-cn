---
title: Azure 指标资源管理器的高级功能
description: 了解 Azure 指标资源管理器的高级用法。
author: vgorbenko
services: azure-monitor
ms.topic: conceptual
ms.date: 06/30/2020
ms.author: vitalyg
ms.openlocfilehash: bd0fef05913c66f767cb81e3c999fda4edaa8c21
ms.sourcegitcommit: 7d63ce88bfe8188b1ae70c3d006a29068d066287
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 07/22/2021
ms.locfileid: "114456517"
---
# <a name="advanced-features-of-the-azure-metrics-explorer"></a>Azure 指标资源管理器的高级功能

> [!NOTE]
> 本文假定你熟悉 Azure Monitor 的 Azure 指标资源管理器的基本功能。 如果你是新用户，希望了解如何创建第一个指标图表，请参阅[指标资源管理器入门](./metrics-getting-started.md)。

在 Azure Monitor 中，[指标](data-platform-metrics.md)是随着时间的推移收集和存储的一系列度量值和计数。 指标可以是标准（也称为“平台”）指标，也可以是自定义指标。 

标准指标由 Azure 平台提供， 反映 Azure 资源的运行状况和使用情况统计信息。 

## <a name="resource-scope-picker"></a>资源范围选取器
使用资源范围选取器，你可以查看单个资源和多个资源的指标。 以下部分介绍如何使用资源范围选取器。 

### <a name="select-a-single-resource"></a>选择单个资源
从 Azure Monitor 菜单或从资源的菜单的“监视”部分选择“指标”    。 然后选择“选择范围”以打开范围选取器。 

使用范围选取器选择要查看其指标的资源。 如果从资源的菜单中打开了 Azure 指标资源管理器，则该范围应已填充完毕。 

![屏幕截图，显示如何打开资源范围选取器。](./media/metrics-charts/scope-picker.png)

对于某些资源，一次只能查看一个资源的指标。 在“资源类型”菜单中，这些资源位于“所有资源类型”部分。 

![屏幕截图，显示单个资源。](./media/metrics-charts/single-resource-scope.png)

选择资源后，会看到包含该资源的所有订阅和资源组。

![屏幕截图，显示可用资源。](./media/metrics-charts/available-single-resource.png)

> [!TIP]
> 如果需要同时查看多个资源的指标的功能，或查看整个订阅或资源组的指标的功能，请选择“投票赞成”。

选好之后，请选择“应用”。

### <a name="view-metrics-across-multiple-resources"></a>查看多个资源的指标
某些资源类型可以查询多个资源的指标。 这些资源必须位于相同的订阅和位置中。 可以在“资源类型”菜单顶部找到这些资源类型。 

有关详细信息，请参阅[选择多个资源](./metrics-dynamic-scope.md#select-multiple-resources)。

![屏幕截图，显示跨资源的类型。](./media/metrics-charts/multi-resource-scope.png)

对于兼容多个资源的类型，你可以查询跨订阅或跨多个资源组的指标。 有关详细信息，请参阅[选择资源组或订阅](./metrics-dynamic-scope.md#select-a-resource-group-or-subscription)。

## <a name="multiple-metric-lines-and-charts"></a>多个指标行和图表

在 Azure 指标资源管理器中，可以创建绘制多个指标行的图表或同时显示多个指标图表。 此功能用于：

- 将同一个图中的相关指标关联到一起，了解一个值如何与另一个值相关联。
- 以邻近的方式显示使用不同度量单位的指标。
- 直观地聚合和比较来自多个资源的指标。

例如，假设你有 5 个存储帐户，想知道它们一起使用了多少空间。 你可以创建一个（堆积的）面积图表，以便显示特定时间点的各个值以及所有值的总计。

### <a name="multiple-metrics-on-the-same-chart"></a>同一图表上的多个指标

若要在同一个图表中查看多个指标，请首先[创建新的图表](./metrics-getting-started.md#create-your-first-metric-chart)。 然后选择“添加指标”。 通过同样的步骤在同一图表上添加另一指标。

> [!NOTE]
> 通常，图表不应混合那些使用不同度量单位的指标。 例如，应避免将一个使用毫秒的指标与另一个使用千字节的指标混合使用。 还应避免混合使用尺度差别很大的指标。 
>
> 在这些情况下，请考虑改用多个图表。 在指标资源管理器中，选择“新建图表”以创建新的图表。

![显示多个指标的屏幕截图。](./media/metrics-charts/multiple-metrics-chart.png)

### <a name="multiple-charts"></a>多个图表

若要使用另一指标创建另一图表，请选择“新建图表”。

若要对多个图表重新排序或将其删除，请选择省略号 ( **...** ) 按钮以打开图表菜单。 然后，选择“上移”、“下移”或“删除”。

![显示多个图表的屏幕截图。](./media/metrics-charts/multiple-charts.png)

## <a name="time-range-controls"></a>时间范围控件

除了使用[时间选取器面板](metrics-getting-started.md#select-a-time-range)来更改时间范围外，还可以使用图表区中的控件进行平移和缩放。
### <a name="pan"></a>平移

若要平移，请单击图表边缘的向左和向右箭头。  这会将选定的时间范围前后移动图表的时间跨度的一半。  例如，如果你正在查看过去 24 小时，单击左箭头将导致时间范围转换为一天半至 12 小时前。

大多数指标支持 93 天的保留期，但一次只能查看 30 天。  使用平移控件，可以查看过去 30 天的内容，并可以一次轻松后退 15 天，以查看保留期的剩余部分。

![动态 gif 显示左平移和右平移控件。](./media/metrics-charts/metrics-pan-controls.gif)

### <a name="zoom"></a>缩放

你可以在图表上单击并拖动以放大图表中的某个部分。  缩放将按照你选择的范围更新图表的时间范围，并且如果将时间粒度设置为“自动”，将选择较小的时间粒度。  新时间范围将应用于指标中的所有图表。

![显示指标缩放功能的动态 gif。](./media/metrics-charts/metrics-zoom-control.gif)

## <a name="aggregation"></a>聚合

将指标添加到图表时，指标资源管理器会自动应用默认聚合。 默认设置在基本方案中是合理的。 但是，你可以使用另一聚合来获得有关此指标的更多见解。 

在图表上使用不同的聚合之前，应了解指标资源管理器处理它们的方式。 指标是在一段时间内捕获的一系列度量（或“指标值”）。 绘制图表时，所选指标的值将基于时间粒度进行单独聚合。 

请使用指标资源管理器的[时间选取器面板](./metrics-getting-started.md#select-a-time-range)选择时间粒度的大小。 如果没有显式选择时间粒度，则默认使用当前选择的时间范围。 确定时间粒度后，在每个时间粒度期间捕获的指标值会聚合在图表上，每个时间粒度一个数据点。

例如，假设图表显示“服务器响应时间”指标。 它针对“过去 24 小时”的时间跨度使用“平均值”聚合。  在本示例中：

- 如果时间粒度设置为 30 分钟，则会基于 48 个聚合数据点绘制图表。 即，折线图连接图表绘图区域中的 48 个点（24 小时 x 每小时 2 个数据点）。 每个数据点表示在每个相关的 30 分钟时间段内发生的服务器请求的所有捕获响应时间的平均值。
- 如果将时间粒度切换成 15 分钟，你将获得 96 个聚合数据点。  也就是说，你将获得 24 小时 x 每小时 4 个数据点。

指标资源管理器有五个基本的统计聚合类型：总和、计数、最小值、最大值和平均值。 “总和”聚合有时称为“总计”聚合 。 对于许多指标，指标资源管理器会隐藏不相关且无法使用的聚合。 

有关指标聚合工作原理的深入讨论，请参阅 [Azure Monitor 指标聚合和显示说明](metrics-aggregation-explained.md)。

* **总和**：在聚合间隔期间捕获的所有值的总和。

    ![“总和”请求的屏幕截图。](./media/metrics-charts/request-sum.png)

* **计数**：在聚合间隔期间捕获的度量数。 
    
    当捕获的指标的值始终为 1 时，计数聚合等于总和聚合。 当指标跟踪不同事件的计数，并且每个度量表示一个事件时，这种情况很常见。 每当一个新请求到达时，代码都会发出一个指标记录。

    ![“计数”请求的屏幕截图。](./media/metrics-charts/request-count.png)

* **Average**：在聚合间隔期间捕获的指标值的平均值。

    ![“平均值”请求的屏幕截图。](./media/metrics-charts/request-avg.png)

* **最小值**：在聚合间隔期间捕获的最小值。

    ![“最小值”请求的屏幕截图。](./media/metrics-charts/request-min.png)

* **最大值**：在聚合间隔期间捕获的最大值。

    ![“最大值”请求的屏幕截图。](./media/metrics-charts/request-max.png)

## <a name="filters"></a>筛选器

可以将筛选器应用到其指标有多个维度的图表。 例如，假设有一个具有“响应类型”维度的“事务计数”指标。 此维度指示来自事务的响应成功了还是失败了。 如果在此维度上进行筛选，则会看到只绘制成功（或失败）事务的图表线条。 

### <a name="add-a-filter"></a>添加筛选器

1. 在图表上方选择“添加筛选器”。

2. 选择要筛选的维度（属性）。

   ![该屏幕截图显示了可筛选的维度（属性）。](./media/metrics-charts/028.png)

3. 选择要对维度（属性）应用的运算符。 默认运算符为 =（等于）

   ![显示可与筛选器结合使用的运算符的屏幕截图。](./media/metrics-charts/filter-operator.png)

4. 选择在绘制图表时要应用于筛选器的维度值（本示例显示筛选出了成功的存储事务）：

   ![屏幕截图，显示已筛选的成功的存储事务。](./media/metrics-charts/029.png)

5. 选择筛选值后，在“筛选选择器”之外单击将其关闭。 现在图表将显示失败的存储事务数：

   ![屏幕截图，显示已失败的存储事务数。](./media/metrics-charts/030.png)

6. 可以重复步骤 1-5 将多个筛选器应用于相同的图表。


## <a name="metric-splitting"></a>指标拆分

可以按维度拆分指标，将指标的不同部分进行直观比较。 拆分还有助于标识某个维度的无关段。

### <a name="apply-splitting"></a>应用拆分

1. 在图表上方选择“应用拆分”。
 
   > [!NOTE]
   > 包含多个指标的图表不能使用拆分功能。 此外，一个图表可以有多个筛选器，但只能有一个拆分维度。

2. 选择要用于细分图表的维度：

   ![屏幕截图，显示细分图表所依据的选定维度。](./media/metrics-charts/031.png)

   图表现在显示多个线条，每个维度部分均有一个：

   ![该屏幕截图显示了多个折线图，每个维度部分均有一个。](./media/metrics-charts/segment-dimension.png)
   
3. 选择在按选定维度拆分后要显示的值数限制。 默认限制为 10，如上图所示。 限制范围为 1-50。
   
   ![显示拆分限制（用于限制拆分后的值数）的屏幕截图。](./media/metrics-charts/segment-dimension-limit.png)
   
4. 选择段的排序顺序：升序或降序。 默认选择为降序。
   
   ![显示拆分值排序顺序的屏幕截图。](./media/metrics-charts/segment-dimension-sort.png)

5. 在“分组选择器”之外单击以将其关闭。
   

   > [!NOTE]
   > 若要隐藏与你的方案无关的部分，使图表更易于读取，请在同一个维度上同时使用筛选和拆分。

## <a name="locking-the-range-of-the-y-axis"></a>锁定 y 轴的范围

在大值出现小波动的图表中，锁定值轴（y 轴）的范围变得很重要。 

例如，如果成功请求的比例从 99.99% 降到 99.5%，则可能表示服务质量显著降低。 但是，如果使用默认的图表设置，则观察小的数值波动会很困难，甚至不可能实现。 在这种情况下，你可以将图表的最低边界锁定为 99%，使较小的降低幅度变得更明显。 

另一个示例是可用内存的波动。 从技术上来说，这种情况下的值永远不会达到 0。 将范围固定为一个较高的值可以使可用内存的降低更容易被发现。 

若要控制 y 轴范围，请打开图表菜单 (...)。然后，选择“图表设置”以访问高级图表设置。

![屏幕截图，突出显示“图表设置”选项。](./media/metrics-charts/033.png)

修改“Y 轴范围”部分的值，或者选择“自动”恢复为默认值。 
 
 ![突出显示 Y 轴范围部分的屏幕截图。](./media/metrics-charts/034.png)

> [!WARNING]
> 如果图表用于跟踪一段时间内的计数或总和（通过使用计数、总和、最小值或最大值聚合的方式），而你需要锁定这类图表的 y 轴边界，则通常应指定一个固定的时间粒度。 在这种情况下，不应依赖于自动默认设置。 
>
> 之所以选择固定的时间粒度，是因为当用户通过重设浏览器窗口大小或更改屏幕分辨率来自动修改时间粒度时，图表值会发生更改。 时间粒度发生的更改会影响图表的外观，导致当前选择的 y 轴范围失效。

## <a name="line-colors"></a>线条颜色

配置图表后，将从默认调色板自动为图表线条分配颜色。 可以更改这些颜色。

若要更改图表线条的颜色，请选择与图表相对应的图例中的彩色条。 此时会打开颜色选取器对话框。 使用颜色选取器配置线条颜色。

![屏幕截图，显示如何更改颜色。](./media/metrics-charts/035.png)

将图表固定到仪表板时，会保留自定义颜色。 以下部分说明如何固定图表。

## <a name="pinning-to-dashboards"></a>固定到仪表板 

配置图表后，可能需要将其添加到仪表板。 图表固定到仪表板后即可供团队访问。 还可以通过在其他监视遥测的上下文中查看它来获得见解。

若要将配置的图表固定到仪表板，请在图表右上角选择“固定到仪表板”。

![屏幕截图，显示如何将图表固定到仪表板。](./media/metrics-charts/036.png)

## <a name="alert-rules"></a>警报规则

可以使用可视化条件来创建基于指标的警报规则。 新的警报规则会包括图表的目标资源、指标、拆分和筛选器维度。 可以使用警报规则创建窗格修改这些设置。

若要开始，请选择“新建警报规则”。

![屏幕截图，显示以红色突出显示的“新建警报规则”按钮。](./media/metrics-charts/042.png)

此时会打开警报规则创建窗格。 在窗格中，可以看到图表的指标维度。 窗格中的字段已预填充，这有助于你自定义规则。

![屏幕截图，显示规则创建窗格。](./media/metrics-charts/041.png)

有关详细信息，请参阅[创建、查看和管理指标警报](../alerts/alerts-metric.md)。

## <a name="correlate-metrics-to-logs"></a>将指标关联到日志
为了帮助客户对其指标图表中异常情况的根本原因进行诊断，我们创建了“深入查看日志”。 利用“深入查看日志”，客户可以将其指标图表中的峰值与日志和查询关联起来。 

在深入探讨这个体验之前，需要先介绍提供的不同类型的日志和查询。 

| 术语             | 定义  | 
|------------------|-------------|
| 活动日志    | 了解从外部（管理平台）  对订阅中的每个 Azure 资源执行的操作，以及对服务运行状况事件进行的更新。 通过活动日志，可确定订阅中资源上进行的任何写入操作（PUT、POST、DELETE）的“什么操作、谁操作和操作时间”等信息。 每个 Azure 订阅都有一个活动日志。  |   
| 诊断日志   | 深入了解在 Azure 资源（数据平面）内执行的操作，例如，从 Key Vault 获取机密，或向数据库发出请求。 资源日志的内容因 Azure 服务和资源类型而异。 注意：必须由服务提供并由客户启用  | 
| 建议的日志 | 基于方案的查询，客户可利用这些查询来调查其指标资源管理器中的异常情况。  |

目前，“深入查看日志”可用于特选的资源提供程序。 具有完整“深入查看日志”体验的资源提供程序为： 

* Application Insights 
* 自动缩放 
* 应用服务  
* 存储  

下面是 Application Insights 资源提供程序的示例体验。

![App Insights“指标”边栏选项卡中失败的请求的峰值](./media/metrics-charts/drill-into-log-ai.png)

若要诊断失败的请求的峰值，请单击“深入查看日志”。

![“深入查看日志”下拉列表的屏幕截图](./media/metrics-charts/drill-into-logs-dropdown.png)

单击“失败”选项就会出现“自定义故障”边栏选项卡，其中提供了失败的操作、数量最多的异常类型和依赖项。 

![App Insights“失败”边栏选项卡的屏幕截图](./media/metrics-charts/ai-failure-blade.png)

### <a name="common-problems-with-drill-into-logs"></a>“深入查看日志”的常见问题

* 日志和查询已禁用 - 若要查看建议的日志和查询，必须将诊断日志路由到 Log Analytics。 请阅读[此文档](./diagnostic-settings.md)以了解如何执行此操作。 
* 只提供活动日志 -“深入查看日志”功能只适用于特选的资源提供程序。 在默认情况下提供的是活动日志。 

 
## <a name="troubleshooting"></a>故障排除

如果在图表上看不到任何数据，请查看以下故障排除信息：

* 筛选器应用到窗格中的所有图表。 将焦点放在某个图表上时，请确保未在其他图表上设置会排除所有数据的筛选器。

* 若要在不同的图表上设置不同的筛选器，请在不同的边栏选项卡中创建图表。 然后将图表保存为独立的收藏项。 可以根据需要将这些图表固定到仪表板，以便集中查看。

* 如果根据指标未定义的属性对图表进行细分，则图表不显示任何内容。 请尝试清除分段（拆分），或选择其他属性。

## <a name="next-steps"></a>后续步骤

若要使用指标创建可操作的仪表板，请参阅[创建自定义 KPI 仪表板](../app/tutorial-app-dashboards.md)。
