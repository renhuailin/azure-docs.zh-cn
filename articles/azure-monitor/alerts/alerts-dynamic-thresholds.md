---
title: 在 Azure Monitor 中创建具有动态阈值的警报
description: 使用基于机器学习的动态阈值创建警报
author: yanivlavi
ms.author: yalavi
ms.topic: conceptual
ms.date: 01/04/2021
ms.openlocfilehash: 4761550c3d08b66fc949c9b6e2950dc08278eea8
ms.sourcegitcommit: b11257b15f7f16ed01b9a78c471debb81c30f20c
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 06/08/2021
ms.locfileid: "111592225"
---
# <a name="metric-alerts-with-dynamic-thresholds-in-azure-monitor"></a>Azure Monitor 中具有动态阈值的指标警报

具有动态阈值的指标警报检测功能利用高级机器学习 (ML) 来学习指标的历史行为，并识别可能指示存在服务问题的模式和异常。 它支持简单 UI 和大规模操作，可让用户通过 Azure 资源管理器 API 以完全自动化的方式配置警报规则。

创建警报规则后，仅当受监视指标的行为不符合预期时（根据定制的阈值来确定），才会触发该规则。

随时欢迎向 <azurealertsfeedback@microsoft.com> 发送反馈，我们很乐意听取你的意见。

## <a name="why-and-when-is-using-dynamic-condition-type-recommended"></a>使用建议的动态条件类型的原因和时机

1. 可缩放的警报 - 动态阈值预警规则可以一次为数百个指标系列创建量身定制的阈值，同时为单个指标定义预警规则提供同样的方便。 它们可让你创建和管理更少的警报。 可以使用 Azure 门户或 Azure 资源管理器 API 来创建它们。 处理指标维度或者应用到多个资源（例如所有订阅资源）时，可缩放的方法特别有用。 [详细了解如何使用模板配置具有动态阈值的指标警报](./alerts-metric-create-templates.md)。

1. 智能识别指标模式 - 使用 ML 技术，我们可以自动检测指标模式，并适应指标随时间的变化，这往往包括季节性（每小时/每天/每周）。 不断适应指标的行为，并根据指标与模式之间的偏差发出警报可以缓解识别每个指标的“适当”阈值的压力。 动态阈值中使用的机器学习算法旨在防止出现不能提供预期模式的干扰性（低精度）阈值或宽泛性（低召回率）阈值。

1. 直观配置 - 借助动态阈值，可以使用简要概念来设置指标警报，减少了对掌握指标的广泛领域知识的需求。

## <a name="how-to-configure-alerts-rules-with-dynamic-thresholds"></a>如何配置具有动态阈值的警报规则？

可以通过 Azure Monitor 中的“指标警报”配置具有动态阈值的警报。 [详细了解如何配置指标警报](alerts-metric.md)。

## <a name="how-are-the-thresholds-calculated"></a>如何计算阈值？

动态阈值持续学习指标系列的数据，并尝试使用一组算法和方法来为此数据建模。 它会检测数据中的模式（例如每小时/每天/每周等季节性），并且能够处理干扰性指标（例如计算机 CPU 或内存），以及离散度较低的指标（例如可用性和误差率）。

如果与选择的阈值之间有偏差，则表示指标行为存在异常。

> [!NOTE]
> 动态阈值可以检测每小时、每天或每周模式的周期性。 可能无法检测到其他模式（如每两小时一次或每半周一次）的周期性。 若要检测周周期性，至少需要三周的历史数据。 

## <a name="what-does-sensitivity-setting-in-dynamic-thresholds-mean"></a>动态阈值中的“敏感度”设置是指什么？

警报阈值敏感度是一个高级概念，用于控制触发警报所要实现的指标行为的偏差量。
无需具备指标的领域知识（例如静态阈值）就能使用此选项。 可用选项包括：

- 高 - 阈值比较严格，并且与指标系列模式接近。 警报规则将在偏差最小时触发，因此会生成更多的警报。
- 中 – 不太严格且比较均衡的阈值，生成的警报比使用高敏感度（默认设置）时更少。
- 低 – 阈值比较宽松，与指标系列模式的偏差更大。 只会在偏差较大时触发警报规则，因此生成的警报较少。

## <a name="what-are-the-operator-setting-options-in-dynamic-thresholds"></a>动态阈值中的“运算符”设置选项有哪些？

动态阈值警报规则可以使用相同的警报规则，基于指标行为的上限和下限创建定制的阈值。
可以选择要在符合以下三种条件之一时触发的警报：

- 大于阈值上限或低于阈值下限（默认条件）
- 大于阈值上限
- 低于阈值下限。

## <a name="what-do-the-advanced-settings-in-dynamic-thresholds-mean"></a>动态阈值中的高级设置是指什么？

**失败时段** - 动态阈值还允许配置“触发警报之前的违规次数”，即，系统在引发警报之前，在特定时间范围内所要出现的最小偏离次数（默认时间范围是在 20 分钟内出现 4 次偏离）。 用户可以配置失败时段，并通过更改失败时段和时间范围，来选择要针对哪些指标发出警报。 此功能可以减少暂时性高峰生成的警报干扰。 例如：

若要在问题持续 20 分钟（给定时间段为 5 分钟时连续 4 次）时触发警报，请使用以下设置：

![失败时段设置为 20 分钟内持续出现问题，在给定的 5 分钟时间段内连续出现 4 次](media/alerts-dynamic-thresholds/0008.png)

若要在过去 30 分钟（时间段为 5 分钟）内有 20 分钟出现违反动态阈值的情况下触发警报，请使用以下设置：

![失败时段设置为在过去 30 分钟内有 20 分钟出现问题，时间段为 5 分钟](media/alerts-dynamic-thresholds/0009.png)

**忽略此前的数据** - 用户还可以选择性地定义一个开始日期，从此日期开始，系统应开始计算阈值。 一个典型的用例是资源过去在测试模式下运行，现在模式已提升，以便为生产工作负荷提供服务，在这种情况下，应忽略任何指标在测试阶段的行为。

## <a name="how-do-you-find-out-why-a-dynamic-thresholds-alert-was-triggered"></a>如何找出触发动态阈值警报的原因？

可以在警报视图中浏览触发的警报实例，方法是单击电子邮件或短信中的链接，或者通过浏览器在 Azure 门户中查看警报视图。 [详细了解警报视图](./alerts-overview.md#alerts-experience)。

警报视图显示：

- 触发动态阈值警报时的所有指标详细信息。
- 触发警报的期间的图表，其中包括在该时间点使用的动态阈值。
- 能够提供关于动态阈值警报和警报视图体验的反馈，这可以改进未来的检测。

## <a name="will-slow-behavior-changes-in-the-metric-trigger-an-alert"></a>指标中的慢速行为变更是否会触发警报？

很有可能并非如此。 动态阈值适合检测重大偏差，而不适合检测逐渐形成的问题。

## <a name="how-much-data-is-used-to-preview-and-then-calculate-thresholds"></a>需要使用多少数据来预览再计算阈值？

首次创建警报规则时，将根据足够的历史数据计算图表中显示的阈值，以计算小时或每日季节性模式（10 天）。 创建警报规则后，动态阈值会使用所有所需的可用历史数据，并会根据新数据不断学习和调整，以使阈值更加准确。 这意味着在计算之后，图表还将显示每周模式。

## <a name="how-much-data-is-needed-to-trigger-an-alert"></a>触发警报需要多少数据？

如果你有新资源或缺少指标数据，则动态阈值将不会在三天或至少 30 个样本的指标数据可用之前触发警报，以确保阈值准确。
对于具有足够指标数据的现有资源，动态阈值可以立即触发警报。

## <a name="dynamic-thresholds-best-practices"></a>动态阈值最佳做法

动态阈值可以应用于大多数平台和 Azure Monitor 中的自定义指标，而且它已针对常用应用程序和基础结构指标进行了优化。
以下各项是有关如何使用动态阈值针对这些指标中的某一些配置警报的最佳做法。

### <a name="dynamic-thresholds-on-virtual-machine-cpu-percentage-metrics"></a>针对虚拟机 CPU 百分比指标的动态阈值

1. 在 [Azure 门户](https://portal.azure.com)中单击“监视”。 “监视”视图将所有监视设置和数据合并到一个视图中。

2. 依次单击“警报”、“+ 新建警报规则”。 

    > [!TIP]
    > 大多数资源边栏选项卡的资源菜单中的“监视”下面也包含“警报”，同样可从中创建警报。  

3. 在加载的上下文窗格中单击“选择目标”，选择要触发警报的目标资源。 使用“订阅”和“虚拟机”资源类型下拉列表查找要监视的资源。  也可以使用搜索栏查找资源。

4. 选择目标资源之后，单击“添加条件”。

5. 选择“CPU 百分比”。

6. （可选）通过调整 **期间** 和 **聚合** 来优化指标。 建议不要对此指标类型使用“最大值”聚合类型，因为它不是具有代表性的行为。 对于“最大值”聚合类型，静态阈值可能更合适。

7. 随后会该指标在显示过去 6 小时的图表。 定义警报参数：
    1. **条件类型** - 选择“动态”选项。
    1. **敏感度** - 选择中/低敏感度，以减少警报干扰。
    1. **运算符** - 选择“大于”，除非行为表示应用程序使用情况。
    1. **频率** - 请考虑根据警报的业务影响进行降低。
    1. **故障期间**（高级选项）- 回退窗口应当至少为 15 分钟。 例如，如果该期间设置为五分钟，则故障期间应当至少为三分钟或更长时间。

8. 指标图表将显示基于最新数据计算得出的阈值。

9. 单击“Done”（完成） 。

10. 填写“警报详细信息”，例如“警报规则名称”、“说明”和“严重性”。   

11. 通过选择现有操作组或创建新的操作组，将一个操作组添加到警报中。

12. 单击“完成”保存指标警报规则。 

> [!NOTE]
> 通过门户创建的指标警报规则将在目标资源所在的同一个资源组中创建。

### <a name="dynamic-thresholds-on-application-insights-http-request-execution-time"></a>针对 Application Insights HTTP 请求执行时间的动态阈值

1. 在 [Azure 门户](https://portal.azure.com)中单击“监视”。 “监视”视图将所有监视设置和数据合并到一个视图中。

2. 依次单击“警报”、“+ 新建警报规则”。 

    > [!TIP]
    > 大多数资源边栏选项卡的资源菜单中的“监视”下面也包含“警报”，同样可从中创建警报。  

3. 在加载的上下文窗格中单击“选择目标”，选择要触发警报的目标资源。 使用“订阅”和“Application Insights”资源类型下拉列表查找要监视的资源。  也可以使用搜索栏查找资源。

4. 选择目标资源之后，单击“添加条件”。

5. 选择“HTTP 请求执行时间”。

6. （可选）通过调整 **期间** 和 **聚合** 来优化指标。 建议不要对此指标类型使用“最大值”聚合类型，因为它不是具有代表性的行为。 对于“最大值”聚合类型，静态阈值可能更合适。

7. 随后会该指标在显示过去 6 小时的图表。 定义警报参数：
    1. **条件类型** - 选择“动态”选项。
    1. **运算符** - 选择“大于”，以减少针对持续时间内的改进触发的警报。
    1. **频率** - 请考虑根据警报的业务影响进行降低。

8. 指标图表将显示基于最新数据计算得出的阈值。

9. 单击“Done”（完成） 。

10. 填写“警报详细信息”，例如“警报规则名称”、“说明”和“严重性”。   

11. 通过选择现有操作组或创建新的操作组，将一个操作组添加到警报中。

12. 单击“完成”保存指标警报规则。 

> [!NOTE]
> 通过门户创建的指标警报规则将在目标资源所在的同一个资源组中创建。

## <a name="interpreting-dynamic-threshold-charts"></a>解释动态阈值图表

下面是一个图表，其中显示了一个指标和它的动态阈值限制，以及当值超出允许的阈值时触发的一些警报。

![详细了解如何配置指标警报](media/alerts-dynamic-thresholds/threshold-picture-8bit.png)

使用以下信息解释上一张图表。

- **蓝线** - 一段时间内实际测量的指标。
- **蓝色阴影区域** - 显示指标的允许范围。 只要指标值停留在此范围内，就不会出现警报。
- **蓝点** - 如果左键单击图表的一部分，然后将鼠标悬停在蓝线上，则会看到光标下出现一个蓝点，显示单个聚合指标值。
- **带有蓝点的弹出窗口** - 显示测量的指标值（蓝点）和允许范围的上限值和下限值。  
- **带有黑色圆圈的红点** - 显示超出允许范围的第一个指标值。 这是触发指标警报并将该警报置于活动状态的值。
- **红点** - 指示超出允许范围的其他度量值。 它们不会触发其他指标警报，但该警报会保持活动状态。
- **红色区域** - 显示指标值超出允许范围的时间。 只要随后的测量值超出允许范围，该警报就会保持活动状态，但不会触发新警报。
- **红色区域结束** - 当蓝线回到允许值内时，红色区域停止，度量值线变蓝。 在带有黑色轮廓的红点设置为“已解决”时触发的指标警报的状态。
