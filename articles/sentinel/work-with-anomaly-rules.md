---
title: 在 Azure Sentinel 中使用异常情况检测分析规则 | Microsoft Docs
description: 本文介绍如何在在 Azure Sentinel 中查看、创建、管理、访问以及微调异常情况检测分析规则。
services: sentinel
cloud: na
documentationcenter: na
author: yelevin
manager: rkarlin
ms.assetid: ''
ms.service: azure-sentinel
ms.subservice: azure-sentinel
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: how-to
ms.date: 04/28/2021
ms.author: yelevin
ms.openlocfilehash: 43af18f508a0e9b4239dedb793a3de9565ee5f03
ms.sourcegitcommit: 0046757af1da267fc2f0e88617c633524883795f
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/13/2021
ms.locfileid: "121747130"
---
# <a name="work-with-anomaly-detection-analytics-rules-in-azure-sentinel"></a>在 Azure Sentinel 中使用异常情况检测分析规则

> [!IMPORTANT]
>
> - 异常规则目前提供预览版。 请参阅 [Microsoft Azure 预览版的补充使用条款](https://azure.microsoft.com/support/legal/preview-supplemental-terms/)，了解适用于 beta 版、预览版或其他尚未正式发布的 Azure 功能的其他法律条款。

## <a name="view-soc-ml-anomaly-rule-templates"></a>查看 SOC-ML 异常规则模板

Azure Sentinel 的 [SOC-ML 异常功能](soc-ml-anomalies.md)提供[内置异常模板](detect-threats-built-in.md#anomaly)，具有开箱即用的即时价值。 这些异常模板是使用数千个数据源和数百万个事件开发而成，非常可靠，而且该项功能还能够让你在用户界面中轻松更改异常的阈值和参数。 异常规则必须在激活后才能生成异常，你可以在“日志”部分的“异常”表中找到这些异常 。

1. 从 Azure Sentinel 导航菜单中，选择“分析”。

1. 从“分析”边栏选项卡，选择“规则模板”选项卡 。

1. 筛选异常模板列表：

    1. 单击“规则类型”筛选器，然后单击下方出现的下拉列表。

    1. 取消标记“全选”，然后标记“异常”。

    1. 如有必要，单击下拉列表顶部以收回列表，然后单击“确定”。

## <a name="activate-anomaly-rules"></a>激活异常规则

当单击其中一个规则模板时，你将会在细节窗格中看到以下信息以及“创建规则”按钮：

- “描述”：说明异常的工作原理及其所需的数据。

- “数据源”：指示为执行分析而需要引入的日志的类型。

- “策略”：指异常涵盖的 MITRE ATT&CK 框架策略。

- “参数”：指异常的可配置属性。

- “阈值”：指可配置值，该值指示在创建异常前，事件必须达到的异常程度。

- “规则频率”：指查找异常的日志处理作业之间经过的时间。

- “异常版本”：显示规则使用的模板版本。 若要更改已处于活动状态的规则使用的版本，则必须重新创建该规则。

- “上次更新模板的时间”：指更改异常版本的日期。

请完成以下步骤，以激活规则：

1. 选择尚未标记“正在使用”的规则模板。 单击“创建规则”按钮，打开规则创建向导。

    每个规则模板的向导略有不同，但其中包含三个步骤或选项卡：“常规”、“配置”以及“查看并创建”  。

    你不能更改向导中的任何值；而且，必须先创建并激活规则。

1. 在各选项卡间循环切换，等待“查看并创建”选项卡上出现“通过验证”这则消息，然后选择“创建”按钮。

    你只能从每个模板创建一项活动规则。 完成向导后，系统将在“活动规则”选项卡中创建活动异常规则，并且（“规则模板”选项卡中的）模板将被标记“正在使用”。

    > [!NOTE]
    > 假设所需数据可用，新规则可能仍需最多 24 小时才会显示在“活动规则”选项卡中。若要查看新规则，请选择“活动规则”选项卡，然后按上文筛选规则模板列表的方式进行筛选。

激活异常规则后，检测到的异常将存储在 Azure Sentinel 工作区“日志”部分的“异常”表中 。

每个异常规则都有一个训练期，并且异常会在相应训练期结束后才会出现在异常表中。 你可以在每个异常规则的“描述”中找到训练期。

## <a name="assess-the-quality-of-anomalies"></a>评估异常质量

若要了解异常规则的执行情况，可以查看过去 24 小时内使用规则创建的异常示例。 

1. 从 Azure Sentinel 导航菜单中，选择“分析”。

1. 在“分析”边栏选项卡中，检查是否有选中“活动规则”选项卡。

1. 筛选异常规则列表（如上文所述）。

1. 选择要评估的规则，并将其名称从细节窗格顶部复制到右侧。

1. 从 Azure Sentinel 导航菜单中选择“日志”。

1. 如果顶部弹出“查询”库，请关闭该库。

1. 选择“日志”边栏选项卡左窗格中的“表”选项卡 。

1. 将“时间范围”筛选规则设置为“过去 24 小时”。

1. 复制下面的 Kusto 查询，并将其粘贴到查询窗口（其中显示“在此键入查询或…”）：

    ```kusto
    Anomalies 
    | where AnomalyTemplateName contains "________________________________"
    ```
    将上面复制的规则名称粘贴到引号之间的下划线上。

1. 单击 **“运行”** 。 

当收到一些结果后，即可开始评估异常的质量。 如果没有收到结果，可尝试延长时间范围。

展开每个异常的结果，然后展开“AnomalyReasons”字段。 此字段将提供触发异常的具体原因。

异常的“合理性”或“有用性”可能取决于环境条件，但异常规则产生过多异常的常见原因是阈值过低。

## <a name="tune-anomaly-rules"></a>优化异常规则

虽然异常规则专为最大限度提高开箱即用的效率而设计，但每一种情况都有其独特性，因此有时需要优化异常规则。

你无法编辑原始活动规则，因此必须先复制活动异常规则，然后自定义副本。

原始异常规则将继续运行，直到你禁用或删除该规则。

此设置经专门设计，目的是可以让你比较原始配置与新配置生成的不同结果。 系统默认禁用所有重复的规则。 对于任何给定异常规则，你只能创建一个自定义副本。 创建第二个副本的尝试将会以失败告终。

1. 若要更改异常规则的配置，请在“活动规则”选项卡中选择该异常规则。

1. 右键单击规则行上的任意位置，或左键单击行末尾的省略号 (...)，然后单击“复制”。

1. 规则新副本的规则名称中将带有后缀“ - Customized”。 若要实际自定义该规则，请选择该规则，然后单击“编辑”。

1. 该规则将在“分析规则”向导中打开。 你可在此更改该规则的参数及其阈值。 可更改的参数因每种异常类型和算法而异。

    你可以在“结果预览”窗格中预览相关更改的结果。 单击结果预览中的异常 ID，即可查看 ML 模型识别该异常的原因。

1. 启用自定义规则来生成结果。 有些更改可能需要重新运行规则，因此你必须等到重新运行完成后，再返回“日志”页检查相关结果。 自定义异常规则默认在外部测试（测试）模式下运行。 原始规则默认继续在生产模式下运行。

1. 若要比较结果，请返回到日志中的“异常”表，[像之前一样评估新规则](#assess-the-quality-of-anomalies)，并且只在“AnomalyTemplateName”列查找包含原始规则名称以及追加“ - Customized”后缀的重复规则名称的行。

    如果你很满意自定义规则生成的结果，可以返回到“活动规则”选项卡，单击相应自定义规则，单击“编辑”按钮，并在“常规”选项卡上将“外部测试”切换为“生产”。 原始规则将自动更改为“外部测试”，因为你无法同时生产同一规则的两个版本。 

## <a name="next-steps"></a>后续步骤

你已经通过本文档了解如何在 Azure Sentinel 中使用 SOC-ML 异常情况检测分析规则。

- 获取一些有关 [SOC-ML](soc-ml-anomalies.md) 的背景信息。
- 浏览其他[分析规则类型](detect-threats-built-in.md)。
