---
title: Azure 服务总线 - 消息到期时间
description: 本文介绍 Azure 服务总线消息的到期时间和生存时间。 此截止时间过后，将不再传递该消息。
ms.topic: conceptual
ms.date: 07/09/2021
ms.openlocfilehash: ac37096b411df0fa1a52286f82ce421dff459239
ms.sourcegitcommit: b5508e1b38758472cecdd876a2118aedf8089fec
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 07/09/2021
ms.locfileid: "113585458"
---
# <a name="message-expiration-time-to-live"></a>消息过期时间（生存时间）
消息中的有效负载，或者由消息传递给接收方的命令或查询，几乎总是附带了某种形式的应用程序级过期截止时间。 此截止时间过后，便不再传送内容，或不再执行请求的操作。

对于经常在应用程序或应用程序部件部分运行轮次的上下文中使用队列与主题的开发和测试环境，还需要对滞留的测试消息自动进行垃圾回收，使下一轮测试运行能够从新启动。

可以通过设置 time-to-live 系统属性（指定相对持续时间）来控制任何一条消息的过期时间。 在实体中将消息排队后，过期时间即成为一个绝对时刻。 此时，expires-at-utc 属性取值为 enqueued-time-utc **time-to-live。  + ** 如果没有任何客户端在主动侦听，则不强制实施中转消息的生存时间 (TTL) 设置。

在 expires-at-utc 时刻过后，消息将变为不可检索。 到期并不会影响当前锁定进行传递的消息。 仍会正常处理这些消息。 如果锁已过期或者消息被丢弃，则过期时间立即生效。

消息被锁定时，应用程序可以拥有已过期的消息。 应用程序是要继续处理还是选择丢弃消息，则由实施者决定。

极低的 TTL（在毫秒或秒范围内）可能会导致接收方应用程序还没来得及接收消息，而消息已经过期。 请考虑适用于你的应用程序的最高 TTL。

## <a name="entity-level-expiration"></a>实体级过期时间
发送到队列或主题的所有消息均受在实体级别设置的默认到期时间的限制。 也可以在门户中创建消息期间设置默认到期时间，并在以后调整。 默认过期时间是针对发送到未显式设置生存时间的实体的所有消息使用的。 默认过期时间还充当生存时间值的上限。 生存时间过期时间长于默认值的消息在排队之前，会以无提示方式调整为默认消息生存时间值。

> [!NOTE]
> - 如果没有另外指定，则中转消息的默认生存时间值为有符号 64 位整数的最大可能值。
> - 对于消息传送实体（队列和主题），服务总线标准层和高级层的默认到期时间也是有符号 64 位整数的最大可能值。 对于基本层，默认（也是最大）到期时间为 14 天 。
> - 如果主题指定的 TTL 比订阅指定的 TTL 小，则应用主题 TTL。

可以选择将过期的消息移动到[死信队列](service-bus-dead-letter-queues.md)中。 可以通过编程方式或使用 Azure 门户来配置此设置。 如果保持禁用该选项，将会丢弃已过期的消息。 可以通过评估由中转站存储在用户属性部分中的 [dead-letter reason](service-bus-dead-letter-queues.md#moving-messages-to-the-dlq) 属性，将已移到死信队列的已过期消息与其他死信消息区分开来。 

在前面所述的例子中，消息已被防止过期并被锁定；如果在实体上设置了相应的标志，则锁被丢弃或过期时，会将该消息移到死信队列。 但是，如果已成功解决该消息，因而认为应用程序已成功处理该消息，则不会移动该消息，尽管它在名义上已过期。

生存时间与过期时自动（和根据事务）加入死信队列的组合是一种极为有用的工具，让我们确信在到达期限时，能够检索在期限范围内提供给一个或一组处理程序的作业进行处理。

例如，假设某个网站需要在规模受限的后端上可靠执行作业，并且偶尔会遇到流量高峰，或者需要受到隔离，以防止该后端在某段时间遇到可用性问题。 在一般情况下，所提交用户数据的服务器端处理程序会将信息推入队列，随后在回复队列中接收确认已成功处理事务的回复。 如果出现流量高峰并且后端处理程序无法及时处理其积压工作项，则已过期的作业会返回到死信队列中。 可以告知交互用户请求的操作所花费的时间比平时稍长，然后可将请求放到不同队列的处理路径，并通过电子邮件将其中的最终处理结果发送给用户。 


## <a name="temporary-entities"></a>临时实体

可将服务总线队列、主题和订阅创建为临时实体，在指定的时间段内未使用这些实体时，系统会自动将其删除。
 
在动态创建实体并且由于测试或调试运行中断，导致用后不会清理实体的开发和测试方案中，自动清理功能十分有用。 当应用程序创建动态实体（例如回复队列）用于在 Web 服务器进程或者生存期相对较短的对象（对象实例消失时难以可靠清理这些实体）中接收响应时，此功能也很有用。

此功能是使用命名空间上的“空闲时自动删除”属性启用的。 此属性设置为自动删除某个实体之前，该实体必须处于空闲（未使用）状态的持续时间。 此属性的最小值为 5 分钟。
 
## <a name="idleness"></a>空闲

下面是被视为实体（队列、主题和订阅）空闲的一些情况：

- 队列
    - 无发送  
    - 无接收  
    - 无队列更新  
    - 无计划的消息  
    - 无浏览/速览 
- 主题  
    - 无发送  
    - 无主题更新  
    - 无计划的消息 
- 订阅
    - 无接收  
    - 无订阅更新  
    - 无添加到订阅的新规则  
    - 无浏览/速览  
 

## <a name="next-steps"></a>后续步骤

若要了解有关服务总线消息传送的详细信息，请参阅以下主题：

* [服务总线队列、主题和订阅](service-bus-queues-topics-subscriptions.md)
* [服务总线队列入门](service-bus-dotnet-get-started-with-queues.md)
* [如何使用服务总线主题和订阅](service-bus-dotnet-how-to-use-topics-subscriptions.md)
