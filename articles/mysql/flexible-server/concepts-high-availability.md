---
title: 通过 Azure Database for MySQL - 灵活服务器实现零冗余高可用性
description: Azure Database for MySQL - 灵活服务器中零冗余高可用性的概念性概述。
author: SudheeshGH
ms.author: sunaray
ms.service: mysql
ms.topic: conceptual
ms.date: 08/26/2021
ms.openlocfilehash: 95cc91298945c50174f1edec6ca766e3f7df59c8
ms.sourcegitcommit: df2a8281cfdec8e042959339ebe314a0714cdd5e
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 09/28/2021
ms.locfileid: "129153722"
---
# <a name="high-availability-in-azure-database-for-mysql---flexible-server-preview"></a>Azure Database for MySQL 灵活服务器预览版中的高可用性

[!INCLUDE[applies-to-mysql-flexible-server](../includes/applies-to-mysql-flexible-server.md)]

> [!IMPORTANT] 
> Azure Database for MySQL 灵活服务器当前以公共预览版提供。

Azure Database for MySQL 灵活服务器预览版支持为高可用性 (HA) 配置自动故障转移。 高可用性解决方案旨在确保提交的数据永远不会由于故障而丢失，且数据库不会成为软件体系结构中的单一故障点。 配置高可用性后，灵活服务器会自动预配和管理备用副本。 高可用性有有两种体系结构模型：

* 区域冗余高可用性。 此选项是跨多个可用性区域实现基础结构完全隔离和冗余的首选选项。 它提供最高级别的可用性，但需要你配置跨区域的应用程序冗余。 如果希望实现最高级别可用性以防可用性区域中出现任何基础结构故障，并且可接受整个可用性区域中的延迟，则首选区域冗余高可用性。 只能在创建服务器时启用此选项。 区域冗余高可用性在[部分 Azure 区域](./overview.md#azure-regions)中可用，这些地理区域支持多个[可用性区域](../../availability-zones/az-overview.md)并且提供[区域冗余高级文件共享](../..//storage/common/storage-redundancy.md#zone-redundant-storage)。

* 相同区域高可用性。 要实现网络延迟较低的基础结构冗余，此选项是首选选项，因为主服务器和备用服务器将位于同一可用性区域中。 它提供高可用性，且无需跨区域配置应用程序冗余。 如果希望在网络延迟最低的单个可用性区域中实现最高级别可用性，则首选相同区域高可用性。 相同区域高可用性在所有 [Azure 区域](./overview.md#azure-regions)中可用，在这些区域中可以使用 Azure Database for MySQL - 灵活服务器。  

## <a name="zone-redundant-ha-architecture"></a>区域冗余高可用性体系结构
 
部署具有区域冗余高可用性的服务器时，将创建两个服务器： 
- 一个主服务器，在一个可用性区域中
- 一个备用副本服务器，位于同一 Azure 区域的另一个可用区中，与主服务器具有相同配置（计算层级、计算大小、存储大小和网络配置）
 
可以选择主要副本和备用副本的可用性区域。 将备用数据库服务器和备用应用程序放在同一区域中可降低延迟。 这样还能更好地准备灾难恢复情况和“区域关闭”方案。

:::image type="content" source="./media/concepts-high-availability/1-flexible-server-overview-zone-redundant-ha.png" alt-text="显示区域冗余高可用性体系结构的关系图。":::

数据和日志文件托管在[区域冗余存储 (ZRS)](../../storage/common/storage-redundancy.md#redundancy-in-the-primary-region)。 将通过 ZRS 提供的存储级复制将这些文件复制到备用服务器。 如果存在故障转移： 
- 将激活备用副本。 
- 主服务器的二进制日志文件继续应用于备用服务器，使其联机到主服务器上最后提交的事务。 

即使在主服务器不可用时，也可访问 ZRS 中的日志。 这种可用性有助于确保数据不会丢失。 激活备用副本并应用二进制日志后，当前备用副本服务器将承担主服务器的角色。 更新 DNS，以便在客户端重新连接时将客户端连接定向到新的主副本。 故障转移在客户端应用程序中是完全透明的，你无需进行任何操作。 然后，高可用性解决方案会尽可能恢复旧的主服务器，并将其安置为备用服务器。
 
数据库服务器名称用于将应用程序连接到主服务器。 不会公开备用副本信息以供直接访问。 在主服务器的 ZRS 刷新日志文件后，确认提交和写入。 由于 ZRS 存储中使用的是同步复制技术，应用程序的写入和提交延迟可能会增加 5% 到 10%。
 
将在主数据库服务器的区域冗余存储上执行自动备份（快照和日志备份）。

## <a name="same-zone-ha-architecture"></a>同区域高可用性体系结构
 
部署具有同一区域高可用性的服务器时，将在同一区域中创建两台服务器： 
- 主服务器
- 一个备用副本服务器，与主服务器具有相同配置（计算层级、计算大小、存储大小和网络配置） 

备用服务器通过单独的虚拟机（计算）提供基础架构冗余。 由于共置，这种冗余减少了应用程序和数据库服务器之间的故障转移时间和网络延迟。

:::image type="content" source="./media/concepts-high-availability/flexible-server-overview-same-zone-ha.png" alt-text="显示同一区域可用性体系结构的关系图。":::

数据和日志文件托管在[本地冗余存储 (LRS)](../../storage/common/storage-redundancy.md#locally-redundant-storage)。 将通过 LRS 提供的存储级复制将这些文件复制到备用服务器。

如果存在故障转移： 
- 将激活备用副本。 
- 主服务器的二进制日志文件继续应用于备用服务器，使其联机到主服务器上最后提交的事务。 

即使在主服务器不可用时，也可访问 LRS 中的日志。 这种可用性有助于确保数据不会丢失。 激活备用副本并应用二进制日志后，当前备用副本将承担主服务器的角色。 当客户端重新连接时，将更新 DNS 以将连接重定向到新的主副本。 故障转移在客户端应用程序中是完全透明的，你无需进行任何操作。 然后，高可用性解决方案会尽可能恢复旧的主服务器，并将其安置为备用服务器。
 
数据库服务器名称用于将应用程序连接到主服务器。 不会公开备用副本信息以供直接访问。 在主服务器的 LRS 刷新日志文件后，确认提交和写入。 由于主副本和备用副本位于同一区域，因此应用程序服务器和数据库服务器之间的复制延迟时间更短。 当特定可用性区域的依赖基础设施关闭时，同区域设置不会提供高可用性。 在该可用区的所有相关服务重新联机之前，将会有停机时间。
 
将在主数据库服务器的本地冗余存储上执行自动备份（快照和日志备份）。

>[!Note]
>对于区域冗余和相同区域高可用性：
>* 如果发生故障，备用副本接管主服务器角色所需的时间取决于备用副本上的二进制日志应用程序。 因此我们建议在所有表上使用主键以减少故障转移时间。 故障转移时间通常在 60 到 120 秒之间。 
>* 备用服务器不可用于读取或写入操作。 备用服务器处于被动待机状态，可实现快速故障转移。
>* 始终使用完全限定的域名 (FQDN) 连接到主服务器。 避免使用 IP 地址进行连接。 如果发生故障转移，则在主服务器角色和备用服务器角色切换后，DNS A 记录可能会更改。 如果在连接字符串中使用了 IP 地址，则该更改将阻止应用程序连接到新的主服务器。

## <a name="failover-process"></a>故障转移过程 
 
### <a name="planned-forced-failover"></a>计划内事件：强制故障转移
 
Azure Database for MySQL - 灵活服务器强制故障转移使你能够手动强制故障转移。 此功能可用于测试应用程序方案测试的功能，并有助于你为服务中断做好准备。 

强制故障转移会触发一次故障转移，这会通过更新 DNS 记录将备用副本激活为具有相同数据库服务器名称的主服务器。 原始主服务器将会重启并切换到备用副本。 客户端连接将断开，它们需要重新连接才能恢复操作。 

总体故障转移时间取决于当前工作负荷和最后一个检查点。 通常，预计需要 60 到 120 秒。
 
### <a name="unplanned-automatic-failover"></a>计划外事件：自动故障转移 
 
计划外服务停机可能由软件 bug 或基础架构故障（如计算、网络或存储故障）或影响数据库可用性的停电引起。 如果数据库变得不可用，则到备用副本的复制将被切断，备用副本将被激活为主数据库。 DNS 更新，然后客户端可重新连接到数据库服务器并恢复操作。 

总体故障转移时间预计在 60 到 120 秒之间。 不过，根据发生故障转移时主数据库服务器中的活动（例如大型事务和恢复时间），故障转移可能需要更长时间。

## <a name="monitoring-for-high-availability"></a>监视高可用性
在“概述”页面持续监视和报告高可用性的运行状况。 以下是复制状态：

| **状态** | **说明** |
| :----- | :------ |
| NotEnabled | 未启用区域冗余高可用性。 |
| ReplicatingData | 备用服务器在创建后正在捕获主服务器。 |
| FailingOver | 数据库服务器正在从主服务器故障转移到备用服务器。 |
| Healthy | 区域冗余高可用性处于稳定状态且正常。 |
| RemovingStandby | 用户已删除备用副本，正在进行删除。| 

##  <a name="limitations"></a>限制 
 
在使用高可用性时，请注意以下几项注意事项：
* 只有在创建灵活服务器时才能设置区域冗余高可用性。
* 可突增计算层级不支持高可用性。
* 如果重启主数据库服务器以获取静态参数更改，也会重启备用副本。
* 高可用性服务器不支持只读副本。
* 高可用性服务器不支持数据传入复制。
* 将开启 GTID 模式，因为高可用性解决方案使用 GTID。 检查工作负载是否对[使用 GTID 进行复制有限制](https://dev.mysql.com/doc/refman/5.7/en/replication-gtids-restrictions.html)。  
 
## <a name="frequently-asked-questions-faq"></a>常见问题解答 (FAQ)
 
**是否可以将备用副本用于读取或写入操作？** </br>
备用服务器不可用于读取或写入操作。 备用服务器处于被动待机状态，可实现快速故障转移。</br>
发生故障转移时，是否会丢失数据？</br>
即使在主服务器不可用时，也可访问 ZRS 中的日志。 这种可用性有助于确保数据不会丢失。 激活备用副本并应用二进制日志后，它将采用主服务器的角色。 </br>
故障转移后是否需要采取任何措施？</br>
故障转移对客户端应用程序是完全透明的。 你不必执行任何操作。 应用程序应该只对其连接使用重试逻辑。 </br>
如果没有为备用副本选择特定区域，会发生什么情况？能否稍后再更改区域？</br>
如果未选择区域，则系统会随机选择一个区域。 但不会是用于主服务器的那个区域。 要稍后更改区域，可以在“高可用性”窗格中将“高可用性模式”设置为“已禁用”，然后将其重新设置为“区域冗余”并选择一个区域。   </br>
主服务器和备用副本之间的复制是否同步？</br>
 主服务器与备用服务器之间的复制类似于 MySQL 中的[半同步模式](https://dev.mysql.com/doc/refman/5.7/en/replication-semisync.html)。 提交事务时，不一定要将事务提交到备用服务器。 但是当主服务器不可用时，备用服务器会从主服务器复制所有数据更改，以确保没有数据丢失。</br> 
对于所有计划外故障，是否故障转移到备用副本？</br>
如果数据库崩溃或节点发生故障，将首先将在同一节点上重启灵活服务器 VM。 同时，将触发自动故障转移。 如果在故障转移完成之前灵活服务器 VM 重启成功，则会取消故障转移操作。 确定将哪个服务器用作主要副本取决于首先完成的过程。</br>
使用高可用性时是否会影响性能？</br>
对于区域冗余高可用性，如果应用程序跨网络延迟相对较高（2-4 毫秒）的可用性区域连接到数据库服务器，则延迟可能会降低 5-10%。 对于同区域高可用性，由于主副本和备用副本在同一可用区中，因此复制延迟较低。 当应用程序服务器和数据库服务器位于同一 Azure 可用区时，它们之间的延迟会更小。</br>
高可用性服务器的维护如何发生？</br>
计划内事件（如计算扩展和次要版本升级）同时发生在主服务器和备用服务器上。 可以为高可用性服务器设置[定期维护窗口](./concepts-maintenance.md)，就像你为灵活服务器设置的那样。 停机时间与禁用高可用性时 Azure Database for MySQL 灵活服务器的停机时间相同。 使用故障转移机制来减少高可用性服务器的停机时间是我们的路线图，很快就会推出。 </br>
能否在高可用性服务器执行时间点还原 (PITR)？</br>
你可以为启用了高可用性的 Azure Database for MySQL 灵活的服务器执行 [PITR](./concepts-backup-restore.md#point-in-time-restore)，将其还原到禁用了高可用性的新 Azure Database for MySQL 灵活服务器。 如果源服务器是使用区域冗余高可用性创建的，则可以稍后在还原的服务器上启用区域冗余高可用性或相同区域高可用性。 如果使用相同区域高可用性创建了源服务器，则只能在还原的服务器上启用相同的区域。</br>
创建服务器后，是否可以在服务器上启用高可用性？</br>
可以在创建服务器后启用同域高可用性。 创建服务器时需要启用区域冗余高可用性。</br> 
在创建服务器之后，可以禁用高可用性吗？ </br>
在创建服务器之后可以在服务器上禁用高可用性。 计费将立即停止。  </br>
如何减少停机时间？</br>
即使不使用高可用性，也需要能够减少应用程序的停机时间。 可以在预定维护窗口期间执行服务停机时间（如预定补丁、次要版本升级）或客户启动的操作（如计算扩展）。 为了减轻 Azure 启动的维护任务对应用程序的影响，可以将它们安排在一周中的某一天和时间，以最大限度地减少对应用程序的影响。</br>
可以将只读副本用于支持高可用性的服务器吗？</br>
高可用性服务器不支持只读副本。 此功能已经在我们的路线图中，我们正在努力使其可供使用。</br>
能否将数据传入复制用于高可用性服务器？</br>
高可用性服务器不支持数据传入复制。 但是高可用性服务器的数据传入复制已在我们的路线图中，很快就会推出。 现在，如果要使用数据传入复制进行迁移，则可以执行以下步骤：
1. 创建已启用区域冗余高可用性的服务器。
1. 禁用高可用性。
1. 完成[设置数据传入复制](./concepts-data-in-replication.md)的步骤。  （确保 `gtid_mode` 在源服务器和目标服务器上具有相同设置。）
1. 切换后，删除数据传入复制配置。
1. 启用高可用性。

为了减少停机时间，我可以在服务器重新启动期间或在纵向扩展或横向缩减时故障转移到备用服务器吗？ </br>
目前，执行纵向扩展或纵向缩减操作时，备用服务器和主服务器会同时进行扩展。 因此故障转移没有帮助。 允许先纵向扩展备用数据库，然后进行故障转移，然后纵向扩展主服务器已经在我们的路线图中，但目前尚不支持。</br>


## <a name="next-steps"></a>后续步骤

- 了解[业务连续性](./concepts-business-continuity.md)。
- 了解[区域冗余高可用性](./concepts-high-availability.md)。
- 了解[备份和恢复](./concepts-backup-restore.md)。
