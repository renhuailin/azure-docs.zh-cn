---
title: Azure Database for MySQL 灵活服务器的区域冗余高可用性概述
description: 了解 Azure Database for MySQL 灵活服务器的区域冗余高可用性概念
author: savjani
ms.author: pariks
ms.service: mysql
ms.topic: conceptual
ms.date: 08/10/2021
ms.openlocfilehash: d78bb5aeb111411641508b38bd49a6f5bcbf5374
ms.sourcegitcommit: 2d412ea97cad0a2f66c434794429ea80da9d65aa
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/14/2021
ms.locfileid: "122177849"
---
# <a name="high-availability-concepts-in-azure-database-for-mysql-flexible-server-preview"></a>Azure Database for MySQL 灵活服务器（预览版）中的高可用性概念

[!INCLUDE[applies-to-mysql-flexible-server](../includes/applies-to-mysql-flexible-server.md)]

> [!IMPORTANT] 
> Azure Database for MySQL 灵活服务器当前以公共预览版提供。

Azure Database for MySQL 灵活服务器（预览版）支持为高可用性配置自动故障转移。 配置高可用性后，灵活服务器会自动使用两个不同的选项来预配和管理备用副本

* 区域冗余高可用性：此选项是跨多个可用性区域实现基础结构完全隔离和冗余的首选选项。 它提供最高级别的可用性，但需要你配置跨区域的应用程序冗余。 如果希望实现最高级别可用性以防可用性区域中出现任何基础结构故障，并且可接受整个可用性区域中的延迟，则首选区域冗余高可用性。 区域冗余高可用性在[部分 Azure 地理区域](https://docs.microsoft.com/azure/mysql/flexible-server/overview#azure-regions)中可用，这些地理区域支持多个可用性区域并且提供区域冗余高可用性。

* 相同区域高可用性：要实现网络延迟较低的基础结构冗余，此选项是首选选项，因为主服务器和备用服务器将位于同一可用性区域中。 它提供高可用性，且无需跨区域配置应用程序冗余。 如果希望在网络延迟最低的单个可用性区域中实现最高级别可用性，则首选相同区域高可用性。 相同区域高可用性在所有[提供了灵活服务器的 Azure 区域](https://docs.microsoft.com/azure/mysql/flexible-server/overview#azure-regions)中可用。  

## <a name="zone-redundant-high-availability"></a>区域冗余高可用性

创建启用了区域冗余高可用性的灵活服务器后，数据和日志文件将托管在[区域冗余存储 (ZRS)](../../storage/common/storage-redundancy.md#redundancy-in-the-primary-region) 中。 使用 ZRS 提供的存储级复制，数据和日志文件将以同步方式复制到备用服务器，以确保实现零数据丢失。 故障转移在客户端应用程序中是完全透明的，无需任何用户操作。 故障转移期间，备用服务器的联机恢复依赖于备用服务器上的二进制日志应用程序。 因此，建议在所有表上使用主键以缩短故障转移时间。 备用服务器不能用来执行任何读取或写入操作，而是被动备用，以实现快速故障转移。 故障转移时间通常在 60-120 秒之间。

> [!Note]
> 如果应用程序跨可用性区域连接到数据库服务器，则区域冗余高可用性可能会导致延迟下降 5-10%，其中网络延迟相对较高，约为 2-4 毫秒。 

:::image type="content" source="./media/concepts-high-availability/1-flexible-server-overview-zone-redundant-ha.png" alt-text="区域冗余高可用性":::

### <a name="zone-redundancy-architecture"></a>区域冗余体系结构

主服务器部署在区域和特定的可用性区域中。 选择高可用性时，会自动在“指定的可用性区域”中部署一个与主服务器具有相同配置（包括计算层、计算大小、存储大小和网络配置）的备用副本服务器。 日志数据将同步复制到备用副本，以确保在发生任何故障时都不会丢失任何数据。 将在主数据库服务器的区域冗余存储上执行自动备份（快照和日志备份）。

### <a name="standby-zone-selection"></a>备用区域选择
在区域冗余高可用性方案中，你可以选择备用服务器区域位置。 将备用数据库服务器和备用应用程序共置在同一区域可减少延迟，并让用户能够更好地为灾难恢复情况和“区域关闭”场景做好准备。

## <a name="same-zone-high-availability"></a>相同区域高可用性

创建启用了相同区域高可用性的灵活服务器后，数据和日志文件将托管在[本地冗余存储 (LRS)](https://docs.microsoft.com/azure/storage/common/storage-redundancy#locally-redundant-storage) 中。 使用 LRS 提供的存储级复制，数据和日志文件将以同步方式复制到备用服务器，以确保实现零数据丢失。 备用服务器通过一个单独的虚拟机（计算）提供基础结构冗余，由于共置，这降低了用户应用程序与数据库服务器之间的故障转移时间和网络延迟。 故障转移在客户端应用程序中是完全透明的，无需任何用户操作。 故障转移期间，备用服务器的联机恢复依赖于备用服务器上的二进制日志应用程序。 因此，建议在所有表上使用主键以缩短故障转移时间。 备用服务器不能用来执行任何读取或写入操作，而是被动备用，以实现快速故障转移。 故障转移时间通常在 60-120 秒之间。

借助相同区域高可用性，用户可以将备用服务器放置在与主服务器相同的区域，从而减少主服务器和备用服务器之间的复制延迟。 如果应用程序服务器和数据库服务器位于同一 Azure 可用性区域内，还可以降低它们之间的延迟。

:::image type="content" source="./media/concepts-high-availability/flexible-server-overview-same-zone-ha.png" alt-text="相同区域冗余高可用性":::

## <a name="high-availability-monitoring"></a>高可用性监视
在“概述”页面持续监视和报告 HA 的运行状况。 各种复制状态如下所示：

| **状态** | **说明** |
| :----- | :------ |
| <b>NotEnabled | 区域冗余 HA 未启用 |
| <b>ReplicatingData | 创建备用服务器后，正在捕获主服务器的数据。 |
| <b>FailingOver | 数据库服务器正在从主服务器故障转移到备用服务器。 |
| <b>正常 | 区域冗余 HA 处于稳定状态且正常。 |
| <b>RemovingStandby | 根据用户操作，备用副本正处于删除过程中。| 

## <a name="advantages"></a>优点

下面是使用区域冗余 HA 功能的一些优点： 

- 备用副本将部署在与主服务器完全相同的 VM 配置中，包括 vCore、存储、网络设置（VNET、防火墙）等。
- 可以通过禁用高可用性来删除备用副本。
- 自动备份基于快照，从主数据库服务器执行，并存储在区域冗余存储或本地冗余存储中，具体取决于高可用性选项。
- 发生故障转移时，如果已启用高可用性，Azure Database for MySQL 灵活服务器将自动故障转移到备用副本。 高可用性设置将监视主服务器并使其重新联机。
- 客户端始终连接到主数据库服务器。
- 如果数据库崩溃或节点发生故障，将首先将在同一节点上重启灵活服务器 VM。 同时，将触发自动故障转移。 如果在故障转移完成之前灵活服务器 VM 重启成功，则会取消故障转移操作。
- 可以重启服务器来获取任何静态服务器参数更改。

## <a name="steady-state-operations"></a>稳定状态操作

应用程序使用数据库服务器名称连接到主服务器。 不会公开备用副本信息以供直接访问。 在刷新主服务器的区域冗余存储 (ZRS) 存储中的日志文件后，将会对提交和写入进行确认。 由于 ZRS 存储中使用的是同步复制技术，应用程序可以期待写入和提交时延迟较小。

## <a name="failover-process"></a>故障转移过程 
为保证业务连续性，需要对计划内和计划外事件都提供故障转移过程。 

>[!NOTE]
> 始终使用完全限定的域名 (FQDN) 连接到主服务器，并避免使用 IP 地址进行连接。 在故障转移的情况下，切换主服务器角色和备用服务器角色后，DNS A 记录也可能更改，如果连接字符串中使用了 IP 地址，则这可能会导致应用程序无法连接到新的主服务器。 

### <a name="planned-events---forced-failover"></a>计划内事件 - 强制故障转移

通过 Azure Database for MySQL 强制故障转移可以手动强制故障转移，这样，就可以使用应用程序方案测试功能，并帮助应对任何服务中断。 强制故障转移通过触发故障转移将备用服务器切换为主服务器，这会通过更新 DNS 记录将备用副本激活为具有相同数据库服务器名称的主服务器。 原始主服务器将会重启并切换到备用副本。 客户端连接将断开，它们必须重新连接才能恢复操作。 将根据当前工作负载和最后一个检查点度量总体故障转移时间。 一般情况下，故障转移时间预期为 60-120 秒。 

### <a name="failover-process---unplanned-events"></a>故障转移过程 - 计划外事件
计划外维护停机包括软件 bug 或基础结构故障，例如计算、网络、存储故障或电源中断影响数据库的可用性。 如果数据库不可用，则会断开到备用副本的复制，并将激活备用副本作为主数据库。 DNS 更新，然后客户端可重新连接到数据库服务器并恢复操作。 总体故障转移时间预计为 60-120 秒。 不过，根据发生故障转移时主数据库服务器中的活动（例如大型事务和恢复时间），故障转移可能需要更长时间。

## <a name="schedule-maintenance-window"></a>计划维护时段 

灵活服务器提供维护计划功能，用户可以在一天中选择所需的 30 分钟时段来执行 Azure 维护，例如执行修补或次要版本升级。 对于已配置高可用性的灵活服务器，这些维护活动将首先在备用副本上执行。 

## <a name="point-in-time-restore"></a>时点还原 
由于灵活服务器配置为高可用性同步复制数据，因此备用服务器将与主服务器保持同步更新。 主服务器上的任何用户错误（例如意外删除表或更新错误）都将如实复制到备用副本上。 因此，不能使用备用副本针对此类逻辑错误执行恢复。 要针对这些逻辑错误执行恢复，必须执行时间点还原，还原到发生错误前的时刻。 使用灵活服务器的时间点还原功能，在还原已配置高可用性的数据库时，新数据库服务器将还原为使用用户提供的名称的新灵活服务器。 然后，则可以从数据库服务器中导出对象，并将其导入生产数据库服务器。 同样，如果想要克隆数据库服务器以便进行测试和开发，或者出于任何其他目的想要进行还原，可以选择最新的还原点或自定义还原点。 还原操作将创建单个区域的灵活服务器。

## <a name="mitigate-downtime"></a>减少停机 
不使用区域冗余 HA 功能时，仍需要能够减少应用程序停机。 计划的维护停机，例如计划的修补、次要版本升级或用户启动的操作，可以在计划的维护时段执行。 计划内的维护停机，例如计划的修补、次要版本升级或用户启动的操作（例如缩放计算导致停机）。 要减轻 Azure 启动的维护任务对应用程序造成的影响，可以选择将它们安排在一周中对应用程序影响最小的某天的某个时间执行。 

在计划外停机事件（例如数据库崩溃或服务器故障）期间，将在同一区域内重启受影响的服务器。 虽然很少见，但如果整个区域受到影响，可以在该区域内的另一个区域还原数据库。 

## <a name="things-to-know-with-zone-redundancy"></a>区域冗余重要须知 

在使用区域冗余高可用性时，请注意以下几项注意事项： 

- 高可用性只能在创建灵活服务器时设置。
- 可突发的计算层不支持高可用性。
- 由于是同步复制到另一个可用性区域，所以主数据库服务器可能会遇到写入和提交延迟增加。
- 备用副本不能用于只读查询。
- 根据发生故障转移时主服务器上的活动，可能需要长达 60-120 秒或更长时间才能完成故障转移。
- 重启主数据库服务器来获取静态参数更改也会重启备用副本。
- 不支持为区域冗余高可用性服务器配置读取副本。
- 在管理的维护时段不能自动配置客户启动的管理任务。
- 计划内事件（例如缩放计算和次要版本升级）将同时在主服务器和备用副本上进行。 


## <a name="next-steps"></a>后续步骤

- 了解[业务连续性](./concepts-business-continuity.md)
- 了解[区域冗余高可用性](./concepts-high-availability.md)
- 了解[备份和恢复](./concepts-backup-restore.md)