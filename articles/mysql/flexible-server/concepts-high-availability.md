---
title: Azure Database for MySQL 灵活服务器的区域冗余高可用性概述
description: 了解 Azure Database for MySQL 灵活服务器的区域冗余高可用性概念
author: SudheeshGH
ms.author: sunaray
ms.service: mysql
ms.topic: conceptual
ms.date: 08/26/2021
ms.openlocfilehash: 4a8f7d5bd10c21b14c8935bf0a44040501ebeb90
ms.sourcegitcommit: dcf1defb393104f8afc6b707fc748e0ff4c81830
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/27/2021
ms.locfileid: "123109183"
---
# <a name="high-availability-concepts-in-azure-database-for-mysql-flexible-server-preview"></a>Azure Database for MySQL 灵活服务器（预览版）中的高可用性概念

[!INCLUDE[applies-to-mysql-flexible-server](../includes/applies-to-mysql-flexible-server.md)]

> [!IMPORTANT] 
> Azure Database for MySQL 灵活服务器当前以公共预览版提供。

Azure Database for MySQL 灵活服务器（预览版）支持为高可用性配置自动故障转移。 高可用性解决方案旨在确保提交的数据永远不会由于故障而丢失，且数据库不会成为软件体系结构中的单一故障点。 配置高可用性后，灵活服务器会自动预配和管理备用副本。 有两种高可用性体系结构模型：

* **区域冗余高可用性 (HA)** ：此选项是跨多个可用性区域实现基础结构完全隔离和冗余的首选选项。 它提供最高级别的可用性，但需要你配置跨区域的应用程序冗余。 如果希望实现最高级别可用性以防可用性区域中出现任何基础结构故障，并且可接受整个可用性区域中的延迟，则首选区域冗余高可用性。 区域冗余高可用性仅在创建服务器时启用。 区域冗余高可用性在[部分 Azure 区域](./overview.md#azure-regions)中可用，这些地理区域支持多个[可用性区域](../../availability-zones/az-overview.md)并且提供[区域冗余高级文件共享](../..//storage/common/storage-redundancy.md#zone-redundant-storage)。

* **相同区域高可用性 (HA)：** 要实现网络延迟较低的基础结构冗余，此选项是首选选项，因为主服务器和备用服务器将位于同一可用性区域中。 它提供高可用性，且无需跨区域配置应用程序冗余。 如果希望在网络延迟最低的单个可用性区域中实现最高级别可用性，则首选相同区域高可用性。 相同区域高可用性在所有 [Azure 区域](./overview.md#azure-regions)中可用，在这些区域中可以创建 Azure Database for MySQL 灵活服务器。  

## <a name="zone-redundancy-high-availability-architecture"></a>区域冗余高可用性体系结构
 
部署具有区域冗余高可用性选项的服务器时，会在一个可用性区域中创建主服务器，在同一 Azure 区域的另一个可用性区域中创建具有相同配置的主服务器（计算层、计算大小、存储大小和网络配置）的备用副本服务器。 可以为主副本和备用副本指定所选的可用性区域。 将备用数据库服务器和备用应用程序共置在同一区域可减少延迟，并让用户能够更好地为灾难恢复情况和“区域关闭”场景做好准备。

:::image type="content" source="./media/concepts-high-availability/1-flexible-server-overview-zone-redundant-ha.png" alt-text="区域冗余高可用性":::

数据和日志文件托管在[区域冗余存储 (ZRS)](../../storage/common/storage-redundancy.md#redundancy-in-the-primary-region)。 使用 ZRS 提供的存储级复制，将数据和日志文件复制到备用服务器。 如果存在故障转移，则会激活备用副本，并且主服务器的二进制日志文件将继续应用于备用服务器，以使其联机到主服务器上最后提交的事务。 使用 ZRS 中的日志，即使在主服务器不可用时，也可以访问日志，这有助于确保零数据丢失。 激活备用副本并应用二进制日志后，当前备用副本服务器将采用主服务器的角色。 更新 DNS，以便在客户端重新连接时将客户端连接定向到新的主副本。 故障转移在客户端应用程序中是完全透明的，无需任何用户操作。 然后，高可用性解决方案会尽可能恢复旧的主服务器，并将其安置为备用服务器。
 
应用程序使用数据库服务器名称连接到主服务器。 不会公开备用副本信息以供直接访问。 在刷新主服务器的区域冗余存储 (ZRS) 存储中的日志文件后，将会对提交和写入进行确认。 由于 ZRS 存储中使用的是同步复制技术，应用程序可以期待写入和提交时延迟降低 5-10%。
 
将在主数据库服务器的区域冗余存储上执行自动备份（快照和日志备份）。

## <a name="same-zone-high-availability-architecture"></a>相同区域高可用性体系结构
 
部署具有相同区域高可用性选项的服务器时，会在同一区域中创建主服务器和备用副本服务器，该服务器具有与主服务器相同的配置（计算层、计算大小、存储大小和网络配置）。 备用服务器通过一个单独的虚拟机（计算）提供基础结构冗余，由于共置，这降低了用户应用程序与数据库服务器之间的故障转移时间和网络延迟。

:::image type="content" source="./media/concepts-high-availability/flexible-server-overview-same-zone-ha.png" alt-text="相同区域冗余高可用性":::

数据和日志文件托管在[本地冗余存储 (LRS)](../../storage/common/storage-redundancy.md#locally-redundant-storage)。 使用 ZRS 提供的存储级复制，将数据和日志文件复制到备用服务器。

如果存在故障转移，则会激活备用副本，并且主服务器的二进制日志文件将继续应用于备用服务器，以使其联机到主服务器上最后提交的事务。 使用 LRS 中的日志，即使在主服务器不可用时，也可以访问日志，这有助于确保零数据丢失。 激活备用副本并应用二进制日志后，当前备用副本将采用主服务器的角色。 当客户端重新连接时，将更新 DNS 以将连接重定向到新的主副本。 故障转移在客户端应用程序中是完全透明的，无需任何用户操作。 然后，高可用性解决方案会尽可能恢复旧的主服务器，并将其安置为备用服务器。
 
应用程序使用数据库服务器名称连接到主服务器。 不会公开备用副本信息以供直接访问。 在刷新主服务器的本地冗余存储 (LRS) 存储中的日志文件后，将会对提交和写入进行确认。 由于在同一区域上有主副本和备用副本，复制滞后时间较低，并且它会降低应用程序服务器和数据库服务器之间的延迟（若置于同一 Azure 可用性区域中）。 对于特定的可用性区域，同一区域设置不会为依赖基础结构关闭的方案提供高可用性。   将出现一段故障时间，直到所有从属服务都为该可用性区域重新联机。
 
将在主数据库服务器的本地冗余存储上执行自动备份（快照和日志备份）。

>[!Note]
>对于区域冗余和相同区域高可用性，
>* 发生故障时，备用副本接管主服务器角色的时间取决于备用副本上的二进制日志应用程序。 因此，建议在所有表上使用主键以缩短故障转移时间。 故障转移时间通常在 60-120 秒之间。 
>* 备用服务器不能用来执行任何读取或写入操作，而是被动备用，以实现快速故障转移。
>* 始终使用完全限定的域名 (FQDN) 连接到主服务器，并避免使用 IP 地址进行连接。 在故障转移的情况下，切换主服务器角色和备用服务器角色后，DNS A 记录也可能更改，如果连接字符串中使用了 IP 地址，则这可能会导致应用程序无法连接到新的主服务器。

## <a name="failover-process"></a>故障转移过程 
 
### <a name="planned---forced-failover"></a>计划内事件 - 强制故障转移
 
Azure Database for MySQL 灵活服务器强制故障转移使你能够手动强制执行故障转移，这样，就可以使用应用程序方案测试功能，并帮助应对任何服务中断。 强制故障转移通过触发故障转移将备用服务器切换为主服务器，这会通过更新 DNS 记录将备用副本激活为具有相同数据库服务器名称的主服务器。 原始主服务器将会重启并切换到备用副本。 客户端连接将断开，它们必须重新连接才能恢复操作。 将根据当前工作负载和最后一个检查点度量总体故障转移时间。 一般情况下，故障转移时间预期为 60-120 秒。
 
### <a name="unplanned--automatic-failover"></a>计划外事件 - 自动故障转移 
 
计划外的故障时间包括：软件 bug 或基础结构故障（例如，计算、网络、存储故障或电源中断影响数据库的可用性）。 如果数据库不可用，则会断开到备用副本的复制，并将激活备用副本作为主数据库。 DNS 更新，然后客户端可重新连接到数据库服务器并恢复操作。 总体故障转移时间预计为 60-120 秒。 不过，根据发生故障转移时主数据库服务器中的活动（例如大型事务和恢复时间），故障转移可能需要更长时间。

## <a name="high-availability-monitoring"></a>高可用性监视
在“概述”页面持续监视和报告 HA 的运行状况。 各种复制状态如下所示：

| **状态** | **说明** |
| :----- | :------ |
| <b>NotEnabled | 区域冗余 HA 未启用 |
| <b>ReplicatingData | 创建备用服务器后，正在捕获主服务器的数据。 |
| <b>FailingOver | 数据库服务器正在从主服务器故障转移到备用服务器。 |
| <b>正常 | 区域冗余 HA 处于稳定状态且正常。 |
| <b>RemovingStandby | 根据用户操作，备用副本正处于删除过程中。| 

##  <a name="limitations"></a>限制 
 
在使用高可用性时，请注意以下几项注意事项：
* 区域冗余高可用性只能在创建灵活服务器时进行设置。
* 可突发的计算层不支持高可用性。
* 重启主数据库服务器来获取静态参数更改也会重启备用副本。
* 不支持为区域冗余高可用性服务器配置读取副本。
* 高可用性服务器不支持数据传入复制 
* 当高可用性解决方案使用 GTID 时，将 GTID 模式设置为“开”。 确认工作负载[对使用 GTID 的复制是否存在局限或限制](https://dev.mysql.com/doc/refman/5.7/en/replication-gtids-restrictions.html)。  
 
## <a name="frequently-asked-questions-faqs"></a>常见问题解答 (FAQ)
 
**是否可以将备用副本用于读取或写入操作？** </br>
备用服务器不能用来执行任何读取或写入操作，而是被动备用，以实现快速故障转移。</br>
**发生故障转移时，是否会丢失任何数据？**</br>
使用 ZRS 中的日志，即使在主服务器不可用时，也可以访问日志，这有助于确保零数据丢失。 激活备用副本并应用二进制日志后，它将采用主服务器的角色。 </br>
**故障转移后，用户是否需要执行任何操作？**</br>
故障转移在客户端应用程序中是完全透明的，无需任何用户操作。 应用程序应该只为其连接实施重试逻辑。 </br>
**如果没有为备用副本选择特定区域，会发生什么情况？能否稍后再更改它？**</br>
如果未选择区域，它将随机选择一个区域（除用于主服务器的区域以外）。 若要稍后再更改区域，可以将高可用性模式设置为“已禁用”，然后将其从“高可用性”边栏选项卡中选择的区域重新设置为“区域冗余”。</br>
**主服务器和备用副本之间的复制是否同步？**</br>
 主服务器和备用副本之间的复制解决方案可视为类似于 MySQL 中的[半同步模式](https://dev.mysql.com/doc/refman/5.7/en/replication-semisync.html)。 提交一个事务时，不需要提交到备用事务。  但当主要副本不可用时，我们可以确保备用副本可以复制主站点所做的所有数据更改，确保零数据丢失。</br> 
**出现所有计划外故障时，是否故障转移到备用副本？**</br>
如果数据库崩溃或节点发生故障，将首先将在同一节点上重启灵活服务器 VM。 同时，将触发自动故障转移。 如果在故障转移完成之前灵活服务器 VM 重启成功，则会取消故障转移操作。 无论哪个所需时间较短，都将被视为决定主要副本和备用副本的选项。</br>
**使用高可用性解决方案时，是否会对性能产生任何影响？**</br>
如果应用程序跨可用性区域连接到数据库服务器，则区域冗余高可用性可能会导致延迟下降 5-10%，其中网络延迟</br> 相对较高，约为 2-4 毫秒。 对于同一区域的高可用性，由于在同一区域上有主副本和备用副本，复制滞后时间较低，并且它会降低应用程序服务器和数据库服务器之间的延迟（若置于同一 Azure 可用性区域中）。</br>
**高可用性服务器的维护如何发生？**</br>
计划内事件（例如缩放计算和次要版本升级）将同时在主服务器和备用副本上进行。 可以为高可用性服务器设置[定期维护窗口](./concepts-maintenance.md)，就像你为灵活服务器设置的那样。 它的故障时间与禁用高可用性的 Azure Database for MySQL 灵活服务器的故障时间相同。 使用故障转移机制来减少高可用性服务器的故障时间，很快将在路线图中提供该功能。 </br>
**能否在高可用性服务器执行时间点还原 (PITR)？**</br>
你可以为启用了高可用性的 Azure Database for MySQL 灵活的服务器执行 [PITR](./concepts-backup-restore.md#point-in-time-restore)，将其还原到禁用了高可用性的新 Azure Database for MySQL 灵活服务器。 如果源服务器是使用区域冗余高可用性创建的，则可以稍后在还原的服务器上启用区域冗余高可用性或相同区域高可用性。 如果使用相同区域高可用性创建了源服务器，则只能在还原的服务器上启用相同的区域。</br>
**是否可以在创建服务器后为其启用高可用性？**</br>
可以在创建服务器后启用相同区域高可用性，但区域冗余服务器高可用性选项只能在创建时选择。</br> 
**是否可以在创建服务器后禁用其高可用性？** </br>
创建服务器后，可以禁用高可用性并立即停止计费  </br>
**如何减少故障时间？**</br>
不使用高可用性功能时，仍需要能够减少应用程序故障时间。 可以在计划性维护时段中计划服务故障时间（例如计划性修补、次要版本升级）或用户启动的操作（例如大规模计算），因为它们会带来故障时间。 要减轻 Azure 启动的维护任务对应用程序造成的影响，可以选择将它们安排在一周中对应用程序影响最小的某天的某个时间执行。</br>
**是否具备适用于启用了高可用性的服务器的只读副本？**</br>
目前启用了高可用性的服务器不支持只读副本。 但我们已将适用于高可用性服务器的只读副本加入路线图，正在努力使此功能可用。</br>
**能否将数据传入复制用于高可用性服务器？**</br>
高可用性服务器目前不支持复制数据。 但我们已将适用于高可用性服务器的数据传入副本加入路线图，正在努力使此功能可用。 目前，如果想使用数据传入复制功能进行迁移，可以执行以下步骤
* 创建已启用区域冗余高可用性的服务器
* 禁用高可用性
* 按照文章来[设置数据传入复制](./concepts-data-in-replication.md)（确保源和目标服务器上的 GTID_Mode 具有相同的设置。）
* 切换后，删除数据传入复制配置
* 启用高可用性

**能否在服务器重启或纵向扩展/缩减期间故障转移到备用服务器，以减少停机时间？** </br>
当前在执行纵向扩展/缩减操作时，会同时缩放备用服务器和主服务器，因此，故障转移不会有帮助，但是可以先纵向扩展备用服务器，接着是路线图中的主服务器故障转移和纵向扩展，但目前尚不支持。</br>


## <a name="next-steps"></a>后续步骤

- 了解[业务连续性](./concepts-business-continuity.md)
- 了解[区域冗余高可用性](./concepts-high-availability.md)
- 了解[备份和恢复](./concepts-backup-restore.md)