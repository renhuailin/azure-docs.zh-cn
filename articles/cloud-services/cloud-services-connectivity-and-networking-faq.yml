### YamlMime:FAQ
metadata:
  title: 连接和网络问题
  description: 本文列出了一些关于 Microsoft Azure 云服务连接性和网络的常见问题解答。
  ms.topic: article
  ms.service: cloud-services
  ms.date: 10/14/2020
  author: hirenshah1
  ms.author: hirshah
  ms.reviewer: mimckitt
  ms.custom: 
  ms.openlocfilehash: cdb0c407db3405b9ced14ca22b221b5ef120d81e
  ms.sourcegitcommit: d11ff5114d1ff43cc3e763b8f8e189eb0bb411f1
  ms.translationtype: HT
  ms.contentlocale: zh-CN
  ms.lasthandoff: 08/25/2021
  ms.locfileid: "122823217"
title: Azure 云服务（经典）的连接和网络问题：常见问题 (FAQ)
summary: >
  [!INCLUDE [Cloud Services (classic) deprecation announcement](includes/deprecation-announcement.md)]


  本文包括一些关于 [Azure 云服务](https://azure.microsoft.com/services/cloud-services)连接性和网络问题的常见问题解答。 有关大小信息，请参阅[云服务 VM 大小页](cloud-services-sizes-specs.md)。


  [!INCLUDE [support-disclaimer](../../includes/support-disclaimer.md)]
sections:
- name: 忽略
  questions:
  - question: >
      无法在多 VIP 云服务中保留 IP
    answer: >
      首先，请确保已打开想要为其保留 IP 的虚拟机实例。 其次，请确保为过渡和生产部署使用保留的 IP。 *请勿* 在部署升级过程中更改设置。
  - question: >
      设置了 NSG 时，如何使用远程桌面？
    answer: >
      将规则添加到 NSG，允许端口 **3389** 和 **20000** 上的流量。 远程桌面使用端口 **3389**。 云服务实例经过负载均衡，因此无法直接控制要连接到哪个实例。 *RemoteForwarder* 和 *RemoteAccess* 代理管理远程桌面协议 (RDP) 流量，允许客户端发送 RDP cookie 和指定要连接到的单个实例。 *RemoteForwarder* 和 *RemoteAccess* 代理要求打开端口 **20000**（如果你具有 NSG，此端口可能已被阻止）。
  - question: >
      是否可以 ping 云服务？
    answer: >
      否，不能通过使用正常 "ping"/ICMP 协议 ping 云服务。 通过 Azure 负载均衡器不允许使用 ICMP 协议。


      若要测试连接性，我们建议执行端口 ping 操作。 当 Ping.exe 使用 ICMP 时，其他工具（如 PSPing、Nmap 和 telnet）允许你测试到特定 TCP 端口的连接性。


      有关详细信息，请参阅[使用端口 ping 而不是 ICMP 来测试 Azure VM 连接性](/archive/blogs/mast/use-port-pings-instead-of-icmp-to-test-azure-vm-connectivity)。
  - question: >
      如何防止接收来自未知 IP 地址的数千次点击，这些 IP 地址是否会对云服务造成某种形式的恶意攻击？
    answer: >
      Azure 实现多层网络安全性，以保护其平台服务免受分布式拒绝服务 (DDoS) 攻击。 Azure DDoS 防御系统是 Azure 持续监视过程的一部分，通过渗透测试不断改进。 该 DDoS 防御系统的设计不仅可以抵御外部的攻击，还可以承受其他 Azure 租户的攻击。 有关详细信息，请参阅 [Azure 网络安全](https://download.microsoft.com/download/C/A/3/CA3FC5C0-ECE0-4F87-BF4B-D74064A00846/AzureNetworkSecurity_v3_Feb2015.pdf)。


      还可以创建一个启动任务来选择性地阻止某些特定 IP 地址。 有关详细信息，请参阅[阻止特定 IP 地址](cloud-services-startup-tasks-common.md#block-a-specific-ip-address)。
  - question: >
      当尝试 RDP 到我的云服务实例时，我收到消息：“此用户帐户已过期。”
    answer: "当绕过 RDP 设置中配置的到期日期时，你可能会收到“此用户帐户已过期”的错误消息。 你可以按照以下步骤从门户更改到期日期：\n\n1. 登录到 [Azure 门户](https://portal.azure.com)，导航到云服务并选择“远程桌面”  选项卡。\n\n2. 选择“生产”  或“暂存”  部署槽位。\n\n3. 更改“到期日期”字段中的日期，然后保存配置。 \n\n你现在应能够 RDP 到你的计算机了。\n"
  - question: >
      为什么 Azure 负载均衡器不平均地均衡流量？
    answer: >
      有关内部负载均衡器工作原理的信息，请参阅 [Azure 负载均衡器新分发模式](https://azure.microsoft.com/blog/azure-load-balancer-new-distribution-mode/)。


      使用的分发算法是将流量映射到可用服务器的 5 元组（源 IP、源端口、目标 IP、目标端口和协议类型）哈希。 它仅在传输会话内部提供粘性。 同一 TCP 或 UDP 会话中的数据包将被定向到经过负载均衡的终结点后面的同一数据中心 IP (DIP) 实例。 客户端从同一源 IP 关闭并重新打开连接或发起新会话时，源端口会更改，并导致流量定向到其他 DIP 终结点。
  - question: >
      如何将发往云服务的默认 URL 的传入流量重定向到自定义 URL？
    answer: >
      可以使用 IIS 的 URL 重写模块将传入到云服务的默认 URL（例如 \*.cloudapp.net）的流量重定向到某个自定义 DNS 名称/URL。 由于默认情况下，URL 重写模块在 Web 角色上已启用，并且其规则是在应用程序的 web.config 中配置的，因此无论重新启动/重置映像，URL 重写模块都始终在 VM 上可用。有关详细信息，请参阅：


      - [为 URL 重写模块创建重写规则](/iis/extensions/url-rewrite-module/creating-rewrite-rules-for-the-url-rewrite-module)

      - [删除默认链接](https://stackoverflow.com/questions/32286487/azure-website-how-to-remove-default-link?answertab=votes#tab-top)
  - question: >
      如何阻止/禁用发往云服务的默认 URL 的传入流量？
    answer: >
      可以阻止发往云服务的默认 URL/名称（例如 \*）的传入流量。 在云服务定义 (*.csdef) 文件中的站点绑定配置下将主机头设置为自定义 DNS 名称（例如 www\.MyCloudService.com），如下所示：


      ```xml

      <?xml version="1.0" encoding="utf-8"?>

      <ServiceDefinition name="AzureCloudServicesDemo" xmlns="http://schemas.microsoft.com/ServiceHosting/2008/10/ServiceDefinition" schemaVersion="2015-04.2.6">
          <WebRole name="MyWebRole" vmsize="Small">
              <Sites>
                  <Site name="Web">
                  <Bindings>
                      <Binding name="Endpoint1" endpointName="Endpoint1" hostHeader="www.MyCloudService.com" />
                  </Bindings>
                  </Site>
              </Sites>
              <Endpoints>
                  <InputEndpoint name="Endpoint1" protocol="http" port="80" />
              </Endpoints>
              <ConfigurationSettings>
                  <Setting name="Microsoft.WindowsAzure.Plugins.Diagnostics.ConnectionString" />
              </ConfigurationSettings>
          </WebRole>
      </ServiceDefinition>

      ```


      因为通过 csdef 文件强制实施了此主机标头绑定，所以，只能通过自定义名称“www.MyCloudService.com”访问该服务。 发往“*.cloudapp.net”域的所有传入请求都将失败。 如果在服务中使用了自定义 SLB 探测或内部负载均衡器，则阻止服务的默认 URL/名称可能会干扰探测行为。
  - question: >
      如何确保云服务面向公众的 IP 地址永不改变？
    answer: >
      若要确保云服务面向公众的 IP 地址（也称 VIP）永不改变，以便它通常可由少数特定的客户端批准，我们建议你设置一个与之关联的保留 IP。 否则，如果删除了部署，则会从订阅解除分配由 Azure 提供的虚拟 IP。 为使 VIP 交换操作成功，需要为生产槽和暂存槽设置单独的保留 IP。 如果缺少这些 IP，交换操作会失败。 请根据以下文章来保留 IP 地址并将其与云服务进行关联：


      - [保留现有云服务的 IP 地址](/previous-versions/azure/virtual-network/virtual-networks-reserved-public-ip#reserve-the-ip-address-of-an-existing-cloud-service)

      - [使用服务配置文件将保留 IP 关联到云服务](/previous-versions/azure/virtual-network/virtual-networks-reserved-public-ip#associate-a-reserved-ip-to-a-cloud-service-by-using-a-service-configuration-file)


      只要有多个实例用于你的角色，将 RIP 与云服务进行关联就应该不会导致任何停机时间。 另外，还可以将 Azure 数据中心的 IP 范围添加到允许列表。 可以在 [Microsoft 下载中心](https://www.microsoft.com/en-us/download/details.aspx?id=41653)找到所有 Azure IP 范围。


      此文件包含 Azure 数据中心使用的 IP 地址范围（包括计算、SQL 和存储范围）。 每周都将发布更新的文件，反映当前已部署的范围和任何即将对 IP 范围进行的更改。 数据中心至少在一周后才会使用文件中显示的新范围。 请每周下载新的 xml 文件，并在网站上执行必要的更改以正确地标识 Azure 中运行的服务。 Azure ExpressRoute 用户可能会注意到，此文件用于在每个月第一周更新 Azure 空间的 BGP 播发。
  - question: >
      如何将 Azure 资源管理器虚拟网络与云服务一起使用？
    answer: >
      不能将云服务置于 Azure 资源管理器虚拟网络中。 可以通过对等互连将 Azure 资源管理器虚拟网络与经典部署虚拟网络连接起来。 有关详细信息，请参阅[虚拟网络对等互连](../virtual-network/virtual-network-peering-overview.md)。
  - question: >
      如何获取云服务使用的公共 IP 列表？
    answer: >-
      可以使用以下 PS 脚本来获取订阅下的云服务公共 IP 列表


      ```powershell

      $services = Get-AzureService  | Group-Object -Property ServiceName


      foreach ($service in $services)

      {
          "Cloud Service '$($service.Name)'"

          $deployment = Get-AzureDeployment -ServiceName $service.Name
          "VIP - " +  $deployment.VirtualIPs[0].Address
          "================================="
      }

      ```
