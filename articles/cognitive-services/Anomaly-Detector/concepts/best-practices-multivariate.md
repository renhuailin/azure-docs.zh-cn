---
title: 使用异常检测器多变量 API 的最佳做法
titleSuffix: Azure Cognitive Services
description: 使用异常检测器多变量 API 将异常检测应用于时序数据的最佳做法。
services: cognitive-services
author: mrbullwinkle
manager: nitinme
ms.service: cognitive-services
ms.subservice: anomaly-detector
ms.topic: conceptual
ms.date: 04/01/2021
ms.author: mbullwin
keywords: 异常检测, 机器学习, 算法
ms.openlocfilehash: 4114771276f4fec6dfef0e953ef9f52e165db510
ms.sourcegitcommit: 6ea4d4d1cfc913aef3927bef9e10b8443450e663
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 07/05/2021
ms.locfileid: "113297311"
---
# <a name="best-practices-for-using-the-anomaly-detector-multivariate-api"></a>使用异常检测器多变量 API 的最佳做法

本文将提供有关使用多变量异常检测器 (MVAD) API 时要遵循的建议做法的指导。 在本教程中，你将：

> [!div class="checklist"]
> * **API 用法**：了解如何使用 MVAD 而不出错。
> * **数据工程**：了解如何最好地利用数据，从而提高 MVAD 的准确度。
> * **常见错误**：了解如何避免客户遇到的常见错误。
> * **常见问题解答**：了解常见问题的解答。

## <a name="api-usage"></a>API 用法

请按照本部分中的说明进行操作，以避免在使用 MVAD 时出现错误。 如果仍然出现错误，请参阅[错误代码的完整列表](./troubleshoot.md)获取说明及解决方法。

[!INCLUDE [mvad-input-params](../includes/mvad-input-params.md)]

[!INCLUDE [mvad-data-schema](../includes/mvad-data-schema.md)]


## <a name="data-engineering"></a>数据工程

现在，你可以通过 MVAD API 运行代码，而不会出现任何错误。 为了提高模型准确度，可以执行哪些操作？

### <a name="data-quality"></a>数据质量

* 当模型从历史数据中学习正常模式时，训练数据应表示系统的整体正常状态。 如果训练数据中的异常过多，模型会很难学习这些类型的模式。 异常比率的经验阈值为 1% 及以下，表示准确度高。
* 一般而言，训练数据的缺失值比率应低于 20%。 缺少数据过多可能会导致自动填充值（通常是线性值或常量值）被视为正常模式并被模型学习。 这可能会导致将实际（未缺失）数据点检测为异常。
    然而，在某些情况下，高缺失比率是可以接受的。 例如，如果一个组中有两个变量（时间序列），则使用 `Outer` 模式来对齐它们的时间戳。 一种具有分钟粒度，另一种具有小时粒度。 这样每小时变量本质上至少有 59 / 60 = 98.33% 的缺失数据点。 在这种情况下，如果唯一可用的值（未缺失）通常不会有太大波动，则可以使用该值填充每小时变量。

### <a name="data-quantity"></a>数据数量

* MVAD 的基础模型包含数百万个参数。 它需要最少数量的数据点来学习一组最优参数。 经验法则是，需要为每个变量提供 15,000 个或更多数据点（时间戳）来训练模型，从而获得高准确度。 通常，训练数据越多，准确度越高。 但是，如果你还未积累那么多数据，我们仍鼓励你用较少的数据进行试验，然后确定受影响的准确度是否仍可接受。
* 每次调用推理 API 时，都需要确保源数据文件包含刚刚足够的数据点。 通常是 `slidingWindow` + 真正需要用于推理结果的数据点数。 例如，在流式处理中，每次要对一个新的时间戳进行推理时，数据文件只能包含前导 `slidingWindow` 加一个数据点；然后，可以继续使用相同数量的数据点（`slidingWindow` + 1）但向“右”侧移动一步，来创建另一个 zip 文件并将其提交以进行另一个推理作业。  

    位于前导滑动窗口之后或之前的所有数据不会对推理结果产生任何影响，只可能会导致性能降级。位于前导滑动窗口下面的任何数据可能导致 `NotEnoughInput` 错误。


### <a name="timestamp-round-up"></a>时间戳向上舍入

在一组变量（时序）中，每个变量都可能是从一个独立的源收集的。 不同变量的时间戳可能彼此不一致，并且各自具有已知的频率。 下面是一个简单的示例。

Variable-1

| timestamp | 值 |
| --------- | ----- |
| 12:00:01  | 1.0   |
| 12:00:35  | 1.5   |
| 12:01:02  | 0.9   |
| 12:01:31  | 2.2   |
| 12:02:08  | 1.3   |

Variable-2

| timestamp | 值 |
| --------- | ----- |
| 12:00:03  | 2.2   |
| 12:00:37  | 2.6   |
| 12:01:09  | 1.4   |
| 12:01:34  | 1.7   |
| 12:02:04  | 2.0   |

这里是从两个传感器收集的两个变量，传感器每隔 30 秒发送一个数据点。 但是，传感器不会严格按均匀的频率发送数据点，而是有时提前，有时延后发送。 由于 MVAD 会考虑不同变量之间的关联，因此必须正确对齐时间戳，以便指标能够正确反映系统状况。 在以上示例中，变量 1 和变量 2 的时间戳必须按其频率正确“舍入”，然后才能对齐。

我们来看看未预先处理这些时间戳会发生什么情况。 如果将 `alignMode` 设置为 `Outer`（意味着联合两个集），则合并表将为

| timestamp | Variable-1 | Variable-2 |
| --------- | -------- | -------- |
| 12:00:01  | 1.0      | `nan`    |
| 12:00:03  | `nan`    | 2.2      |
| 12:00:35  | 1.5      | `nan`    |
| 12:00:37  | `nan`    | 2.6      |
| 12:01:02  | 0.9      | `nan`    |
| 12:01:09  | `nan`    | 1.4      |
| 12:01:31  | 2.2      | `nan`    |
| 12:01:34  | `nan`    | 1.7      |
| 12:02:04  | `nan`    | 2.0      |
| 12:02:08  | 1.3      | `nan`    |

`nan` 指示缺失值。 显然，这不是你预期的合并表。 变量 1 和变量 2 交错，MVAD 模型无法提取有关变量之间的关联的信息。 如果将 `alignMode` 设置为 `Inner`，则合并表将为空，因为变量 1 和变量 2 中没有共同的时间戳。

因此，变量 1 和变量 2 的时间戳应进行预先处理（舍入为最接近的 30 秒时间戳），那么新时序将为

Variable-1

| timestamp | 值 |
| --------- | ----- |
| 12:00:00  | 1.0   |
| 12:00:30  | 1.5   |
| 12:01:00  | 0.9   |
| 12:01:30  | 2.2   |
| 12:02:00  | 1.3   |

Variable-2

| timestamp | 值 |
| --------- | ----- |
| 12:00:00  | 2.2   |
| 12:00:30  | 2.6   |
| 12:01:00  | 1.4   |
| 12:01:30  | 1.7   |
| 12:02:00  | 2.0   |

现在，合并表更为合理。

| timestamp | Variable-1 | Variable-2 |
| --------- | -------- | -------- |
| 12:00:00  | 1.0      | 2.2      |
| 12:00:30  | 1.5      | 2.6      |
| 12:01:00  | 0.9      | 1.4      |
| 12:01:30  | 2.2      | 1.7      |
| 12:02:00  | 1.3      | 2.0      |

时间戳接近的不同变量的值已对齐良好，MVAD 模型现在可以提取关联信息。

## <a name="common-pitfalls"></a>常见错误

除了[错误代码表](./troubleshoot.md)，我们还从跟你一样的客户那里了解到一些使用 MVAD API 时的常见错误。 此表将帮助你避免这些问题。

| 错误 | 结果 |说明和解决方案 |
| --------- | ----- | ----- |
| 训练数据和/或推理数据中的时间戳未进行向上舍入，以与每个变量各自的数据频率保持一致。 | 推理结果的时间戳与预期不符：时间戳太少或太多。  | 请参阅[时间戳向上舍入](#timestamp-round-up)。  |
| 训练数据中的异常数据点太多 | 由于模型在训练期间将异常数据点视为正常模式，因此模型准确度受到负面影响。 | 从经验上看，将异常比率保持在 **1%** 或以下将有所帮助。 |
| 训练数据太少 | 模型准确度受到影响。 | 从经验上看，在训练一个 MVAD 模型时，每个变量需要 15,000 个或更多数据点（时间戳），才能保持较高的准确度。|
| 将 `isAnomaly`=`true` 的所有数据点视为异常 | 假正太多 | 应同时使用 `isAnomaly` 和 `severity`（或 `score`）筛选出不严重的异常情况，并（选择性地）使用分组来检查异常情况的持续时间，以消除随机干扰。 请参阅下面的[常见问题解答](#faq)部分，了解 `severity` 与 `score` 的差异。  |
| 将子文件夹压缩到数据文件中，用于训练或推理。 | 在训练和/或推理期间，忽略子文件夹中的 csv 数据文件。 | zip 文件中不允许包含子文件夹。 有关详细信息，请参阅[文件夹结构](#folder-structure)。 |
| 推理数据文件中的数据太多：例如，将所有历史数据压缩在推理数据 zip 文件中 | 在尝试将 zip 文件上传到 Azure Blob 以及尝试运行推理时，你可能看不到任何错误，但性能会降级。 | 有关详细信息，请参阅[数据数量](#data-quantity)。 |
| 在尚不支持 MVAD 的 Azure 区域上创建异常检测器资源并调用 MVAD API  | 调用 MVAD API 时，会出现“找不到资源”错误。 | 在预览阶段，MVAD 仅在有限的几个区域中可用。 请将[异常检测器的新增功能](../whats-new.md)加入书签，以随时了解 MVAD 在各个区域的推出情况。 也可以提交 GitHub 问题或通过 AnomalyDetector@microsoft.com 联系我们，以请求提供该工具在特定区域中的推出情况。 |

## <a name="faq"></a>常见问题解答

### <a name="how-does-mvad-sliding-window-work"></a>MVAD 滑动窗口的工作原理是什么？

我们使用两个示例来了解 MVAD 滑动窗口的工作原理。 假设已将 `slidingWindow` 设置为 = 1,440，并且输入数据的粒度为 1 分钟。

* **流式处理方案**：你希望预测在“2021-01-02T00:00:00Z”处的一个数据点是否异常。 `startTime` 和 `endTime` 值将相同（“2021-01-02T00:00:00Z”）。 但是，推理数据源必须至少包含 1,440 + 1 个时间戳。 因为 MVAD 将根据目标数据点（“2021-01-02T00:00:00Z”）之前的前导数据来确定目标是否异常。 在这种情况下，所需前导数据的长度为 `slidingWindow` 或 1,440。 1,440 = 60 * 24，因此输入数据必须从最近的“2021-01-01T00:00:00Z”开始。

* **批处理方案**：你需要预测多个目标数据点。 `endTime` 将晚于 `startTime`。 在这类方案中，推理以“移动窗口”方式执行。 例如，MVAD 将使用从 `2021-01-01T00:00:00Z` 到 `2021-01-01T23:59:00Z`（包含开始和结束数据点）的数据来确定 `2021-01-02T00:00:00Z` 处的数据是否异常。 然后，它会往前移动并使用从 `2021-01-01T00:01:00Z` 到 `2021-01-02T00:00:00Z`（包含开始和结束数据点）的数据来确定 `2021-01-02T00:01:00Z` 处的数据是否异常。 它会以相同方式继续（使用 1,440 个数据点进行比较）直到 `endTime` 指定的最后一个时间戳（或实际的最近时间戳）为止。 因此，推理数据源包含的数据必须从 `startTime` - `slidingWindow` 开始，且理想情况下，包含的总数据量为 `slidingWindow` + (`endTime` - `startTime`)。

### <a name="why-only-accepting-zip-files-for-training-and-inference"></a>为什么只能使用 zip 文件进行训练和推理？

因为在批处理方案中，训练和推理数据的大小会非常大，无法放入 HTTP 请求正文中，因此使用 zip 文件。 这样，用户可以对历史数据执行批量推理，以便进行模型验证或数据分析。

但是，对于流式推理和高频率数据而言，这可能有点不方便。 我们计划添加一个专门为流式推理设计的新 API，这样用户可以在请求正文中传递数据。

### <a name="whats-the-difference-between-severity-and-score"></a>`severity` 与 `score` 有何差异？

通常建议将 `severity` 用作筛选器来筛选出对业务不重要的“异常”。 那些不太重要的异常通常具有相对较低的 `severity` 值或独立的（不连续）高 `severity` 值（例如随机峰值），具体取决于你的方案和数据模式。

如果发现需要使用比 `severity` 阈值更复杂的规则，或发现持续存在的高 `severity` 值，则可能希望使用 `score` 来构建功能更强大的筛选器。 了解 MVAD 如何使用 `score` 来确定异常情况可能会有所帮助：

我们会同时从全局和局部角度来考虑一个数据点是否异常。 如果一个时间戳的 `score` 高于某个阈值，则会将该时间戳标记为异常。 如果 `score` 低于阈值但它在一个段中相对较高，则还是会将它标记为异常。

## <a name="next-steps"></a>后续步骤

* [快速入门：使用异常检测器多变量客户端库](../quickstarts/client-libraries-multivariate.md)。
* [了解支持异常检测器多变量的基础算法](https://arxiv.org/abs/2009.02040)
