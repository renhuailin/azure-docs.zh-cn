---
title: Azure 文件同步云分层策略 | Microsoft Docs
description: 有关日期和卷可用空间策略如何针对不同方案协同工作的详细信息。
author: roygara
ms.service: storage
ms.topic: conceptual
ms.date: 04/13/2021
ms.author: rogarana
ms.subservice: files
ms.openlocfilehash: be07d4b2213599f9d6a5a5d24f2fc17e266c2c87
ms.sourcegitcommit: f6e2ea5571e35b9ed3a79a22485eba4d20ae36cc
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 09/24/2021
ms.locfileid: "128620134"
---
# <a name="cloud-tiering-policies"></a>云分层策略

云分层提供两个策略用于确定哪些文件分层到云：卷可用空间策略和日期策略 。

卷可用空间策略确保服务器终结点所在的本地卷的指定百分比的空间始终可用。

日期策略将 x 天前或更早时间访问的文件分层。 卷可用空间策略将始终优先，如果卷中没有足够的可用空间，从而无法对文件存储日期策略描述的天数，则 Azure 文件同步会替代日期策略并继续将最冷的文件分层，直到符合卷可用空间百分比要求。

## <a name="how-both-policies-work-together"></a>两个策略的协同工作方式

我们将使用一个示例来说明这些策略的工作方式：假设你在 500 GiB 本地卷上配置了 Azure 文件同步，并且从未启用云分层。 下面是文件共享中的文件：

|文件名 |上次访问时间  |文件大小  |存储位置 |
|----------|------------------|-----------|----------|
|文件 1    | 2 天前  | 10 GiB | 服务器和 Azure 文件共享
|文件 2    | 10 天前 | 30 GiB | 服务器和 Azure 文件共享
|文件 3    | 1 年前 | 200 GiB | 服务器和 Azure 文件共享
|文件 4    | 1 年，2 天前 | 130 GiB | 服务器和 Azure 文件共享
|文件 5    | 2 年，1 天前 | 140 GiB | 服务器和 Azure 文件共享

**更改 1：** 你已启用云分层，将卷可用空间策略设置为 20%，并继续禁用日期策略。 使用该配置，云分层可确保 20%（本例中为 100 GiB）的空间在本地计算机上保持可用。 因此，本地缓存的总容量为 400 GiB。 这 400 GiB 将存储本地卷上最近和最频繁访问的文件。

使用此配置时，只会在本地缓存中存储文件 1 到文件 4，将把文件 5 分层。 400 GiB 中只有 370 GiB 可用。 文件 5 为 140 GiB，如果在本地缓存该文件，则将超过 400 GiB 的限制。

**更改 2：** 假设用户访问文件 5。 这会使文件 5 成为共享中最近访问的文件。 因此，文件 5 将存储在本地缓存中，为了符合 400 GiB 限制，文件 4 将分层。 下表显示了文件的存储位置，其中包含以下更新：

|文件名 |上次访问时间  |文件大小  |存储位置 |
|----------|------------------|-----------|----------|
|文件 5    | 2 小时前 | 140 GiB | 服务器和 Azure 文件共享
|文件 1    | 2 天前  | 10 GiB | 服务器和 Azure 文件共享
|文件 2    | 10 天前 | 30 GiB | 服务器和 Azure 文件共享
|文件 3    | 1 年前 | 200 GiB | 服务器和 Azure 文件共享
|文件 4    | 1 年，2 天前 | 130 GiB | Azure 文件共享，本地分层

**更改 3：** 假设更新了策略，使得基于日期的分层策略指定保留天数为 60 天，卷可用空间策略设置为 70%。 现在，本地缓存中最多可以存储 150 GiB。 尽管访问文件 2 的时间距现在不到 60天，但卷可用空间策略将替代日期策略，并且文件 2 将会分层以维护 70% 的本地可用空间。

**更改 4：** 如果将卷可用空间策略更改为 20%，然后在符合云分层策略的情况下，使用 `Invoke-StorageSyncFileRecall` 召回本地驱动器上容纳的所有文件，则该表将如下所示：

|文件名 |上次访问时间  |文件大小  |存储位置 |
|----------|------------------|-----------|----------|
|文件 5    | 1 小时前  | 140 GiB | 服务器和 Azure 文件共享
|文件 1    | 2 天前  | 10 GiB | 服务器和 Azure 文件共享
|文件 2    | 10 天前 | 30 GiB | 服务器和 Azure 文件共享
|文件 3    | 1 年前 | 200 GiB | Azure 文件共享，本地分层
|文件 4    | 1 年，2 天前 | 130 GiB | Azure 文件共享，本地分层

在这种情况下，文件 1、2 和 5 将会在本地缓存，而文件 3 和 4 会进行分层。 由于日期策略为 60 天，因此，即使卷可用空间策略允许本地最多使用 400 GiB，也会对文件 3 和 4 进行分层。

> [!NOTE]
> 当客户将卷可用空间策略更改为较小的值（例如从 20% 更改为 10%）或将日期策略更改为较大的值（例如从 20 天更改为 50天）时，文件不会自动召回。

## <a name="multiple-server-endpoints-on-a-local-volume"></a>本地卷上的多个服务器终结点

可以在单个本地卷上为多个服务器终结点启用云分层。 对于此配置，应为同一卷上的所有服务器终结点设置相同量的卷可用空间。 如果为同一卷上的多个服务器终结点设置不同的卷可用空间策略，则将优先应用最大的卷可用空间百分比。 这称为“有效卷可用空间策略”。 例如，如果同一本地卷上有三个服务器终结点，一个设置为 15%，另一个设置为 20%，第三个服务器终结点设置为 30%，当可用空间不足 30% 时，它们都会开始对最冷的文件进行分层。

## <a name="next-steps"></a>后续步骤

- [监视云分层](file-sync-monitor-cloud-tiering.md)
