---
title: 选择 Azure 文件同步云分层策略 | Microsoft Docs
description: 有关在选择 Azure 文件同步云分层策略时要记住的事项的详细信息。
author: roygara
ms.service: storage
ms.topic: conceptual
ms.date: 04/13/2021
ms.author: rogarana
ms.subservice: files
ms.openlocfilehash: 211bdb3bfd71774677e072d739f5b559c3d9f5b3
ms.sourcegitcommit: 98308c4b775a049a4a035ccf60c8b163f86f04ca
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 06/30/2021
ms.locfileid: "113112880"
---
# <a name="choose-cloud-tiering-policies"></a>选择云分层策略

本文为选择和调整云分层策略的用户提供了指导。 阅读本文之前，请确保了解云分层的工作原理。 有关云分层基础知识，请参阅[了解 Azure 文件同步云分层](file-sync-cloud-tiering-overview.md)。 有关包含示例的云分层策略深入说明，请参阅 [Azure 文件同步云分层策略](file-sync-cloud-tiering-policy.md)。

## <a name="limitations"></a>限制
- Windows 系统卷上不支持云分层。

- 如果有卷级别 FSRM 配额，仍可启用云分层。 设置 FSRM 配额后，调用的可用空间查询 API 会根据配额设置自动报告卷上的可用空间。 

### <a name="minimum-file-size-for-a-file-to-tier"></a>要进行分层的文件的最小文件大小

对于代理版本 9 和更高版本，要进行分层的文件的最小文件大小基于文件系统群集大小。 符合云分层条件的最小文件大小按群集大小的 2 倍进行计算，最小为 8 KB。 下表基于卷群集大小说明了可以进行分层的最小文件大小：

|卷群集大小（字节） |此大小或更大的文件可以进行分层  |
|----------------------------|---------|
|4 KB 或更小 (4096)      | 8 KB    |
|8 KB (8192)                 | 16 KB   |
|16 KB (16384)               | 32 KB   |
|32 KB (32768)               | 64 KB   |
|64 KB (65536)    | 128 KB  |
|128 KB (131072) | 256 KB |
|256 KB (262144) | 512 KB |
|512 KB (524288) | 1 MB |
|1 MB (1048576) | 2 MB |
|2 MB (2097152) | 4 MB |

Azure 文件同步代理版本 12 支持最大为 2 MB 的群集大小，但对于更大的大小，云分层不起作用。

Windows 使用的所有文件系统都基于群集大小（也称为分配单元大小）组织硬盘。 群集大小表示可用于保存文件的最小磁盘空间量。 当文件大小不是群集大小的偶数倍时，必须使用额外空间来保存文件 - 最大为群集大小的下一个倍数。

采用 Windows Server 2012 R2 和更高版本的 NTFS 卷支持 Azure 文件同步。 下表介绍了使用 Windows Server 2019 创建新 NTFS 卷时的默认群集大小。

|卷大小    |Windows Server 2019             |
|---------------|--------------------------------|
|7 MB – 16 TB   | 4 KB                |
|16TB – 32 TB   | 8 KB                |
|32TB – 64 TB   | 16 KB               |
|64TB – 128 TB  | 32 KB               |
|128TB – 256 TB | 64 KB（早期最大值） |
|256 TB – 512 TB| 128 KB              |
|512 TB – 1 PB  | 256 KB              |
|1 PB – 2 PB    | 512 KB              |
|2 PB - 4 PB    | 1024 KB             |
|4 PB - 8 PB    | 2048 KB（最大大小）  |
|> 8 TB         | 不支持       |

创建卷时，可以使用其他群集大小手动格式化卷。 如果卷源自较早版本的 Windows，则默认群集大小也可能有所不同。 [本文提供了有关默认群集大小的更多详细信息。](https://support.microsoft.com/help/140365/default-cluster-size-for-ntfs-fat-and-exfat) 即使选择了小于 4 KB 的群集大小，作为可以进行分层的最小文件大小的 8 KB 限制仍然适用。 （即使在技术上，群集大小的 2 倍小于 8 KB。）

绝对最小值的原因在于 NTFS 存储极小文件（1 KB 到 4 KB 大小的文件）的方式。 根据卷的其他参数，小文件可能完全不存储在磁盘上的群集中。 将此类文件直接存储在卷的主文件表或“MFT 记录”中可能会更加高效。 云分层重分析点始终存储在磁盘上，恰好占用一个群集。 对此类小文件进行分层可能会导致未节省空间。 极端情况下，可能会导致在启用了云分层后使用更多空间。 为防范这种情况，对于 4 KB 或更小的群集大小，云分层将进行分层的文件的最小大小为 8 KB。 

## <a name="selecting-your-initial-policies"></a>选择初始策略

通常，在服务器终结点上启用云分层时，应为每个单独服务器终结点创建一个本地虚拟驱动器。 通过隔离服务器终结点可以更轻松地了解云分层的工作情况，并相应地调整策略。 但是，即使在同一驱动器上有多个服务器终结点，Azure 文件同步仍可发挥作用，有关详细信息，请参阅[本地卷上的多个服务器终结点](file-sync-cloud-tiering-policy.md#multiple-server-endpoints-on-a-local-volume)部分。 还建议在首次启用云分层时，将日期策略保持为已禁用状态，将卷可用空间策略保持为大约 10% 到 20%。 对于大多数文件服务器卷，20% 卷可用空间通常是最佳选项。

为简单起见并且清楚地了解项目的分层方式，建议主要调整卷可用空间策略，并将日期策略保持为已禁用状态（除非需要）。 建议这样做是因为大多数客户发现，用尽可能多的热文件填充本地缓存并将其余文件分层到云会非常有价值。 但是，如果要主动释放本地磁盘空间，并且知道在日期策略中指定的天数后访问的服务器终结点中的文件不需要保留在本地，则日期策略可能会很有用。 设置日期策略可释放宝贵的本地磁盘容量，供相同卷上的其他终结点缓存更多文件。

设置策略后，监视流出量并相应地调整两个策略。 建议在 Azure Monitor 中通过应用程序指标专门查看“云分层召回大小”和“应用程序的云分层召回大小” 指标。 若要了解如何监视流出量，请参阅[监视云流出量](file-sync-monitor-cloud-tiering.md)。

## <a name="adjusting-your-policies"></a>调整策略

如果从 Azure 中经常召回的文件量大于所需量的量，则你拥有的热文件可能比你在本地服务器卷上保存文件所需的空间要多。 如果可能，请增加本地卷大小，并/或以较小增量减小卷可用空间策略百分比。 将卷可用空间百分比减小太多也可能会产生负面影响。 数据集的更高流失率需要更多可用空间 -对于新文件和召回“冷”文件。 分层开始时的延迟最多为一小时，随后需要处理时间，这便是为何应始终在卷上有足够闲空间。

使更多数据保留在本地留意味着降低流出量成本，因为从 Azure 召回的文件变少；但还需要较大的本地存储量，这需要自己支付费用。 

调整卷可用空间策略时，应保留在本地的数据量取决于以下因素：带宽、数据集的访问模式和预算。 使用低带宽连接时，可能需要更多本地数据，以确保对用户的延迟最小。 反之，可以给定时间段内的变动率为依据。 例如，如果确定 1-TB 数据集每月大约有 10% 发生变化或获主动访问，建议在本地保留 100 GB，以免频繁召回文件。 如果卷为 2 TB，建议在本地保留 5%（或 100 GB）；也就是说，剩余 95% 是卷可用空间百分比。 不过，应添加缓冲区，以将变动率更高的时间段考虑在内 – 也就是说，从较高的卷可用空间百分比入手，以后再根据需要进行调整。

## <a name="standard-operating-procedures"></a>标准操作过程

- 首次通过 Azure 文件同步迁移到 Azure 文件存储时，云分层依赖于初始上传
- 云分层会每六十分钟检查一次是否符合卷可用空间和日期策略
- 在迁移文件时对 Robocopy 上使用 /LFSM 开关，会使文件可以进行同步和云分层，以在初始上传过程中腾出空间 
- 如果在构造热度地图之前进行分层，则文件会按上次修改时间戳进行分层

## <a name="next-steps"></a>后续步骤

* [规划 Azure 文件同步部署](file-sync-planning.md)
