---
title: 不可变的 Blob 存储 - Azure 存储
description: Azure 存储提供对 Blob 对象存储的 WORM（一次写入，多次读取）支持，可让用户根据指定的时间间隔，以不可擦除、不可修改的状态存储数据。
services: storage
author: tamram
ms.service: storage
ms.topic: conceptual
ms.date: 06/18/2021
ms.author: tamram
ms.reviewer: hux
ms.subservice: blobs
ms.openlocfilehash: 776c16174ad4b6c0ef3d138188d43041dd1649f4
ms.sourcegitcommit: 7d63ce88bfe8188b1ae70c3d006a29068d066287
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 07/22/2021
ms.locfileid: "114440236"
---
# <a name="store-business-critical-blob-data-with-immutable-storage"></a>使用不可变的存储来存储业务关键型 Blob 数据

Azure Blob 存储的不可变存储可让用户以 WORM（一次写入，多次读取）状态存储业务关键型数据对象。 此状态可以根据用户指定的时间间隔使数据保持不可擦除且不可修改的状态。 在保留时间间隔期间内，可以创建和读取 Blob，但不能对其进行修改或删除。 不可变存储适用于所有 Azure 区域中的常规用途 v1、常规用途 v2、高级块 blob 和旧 blob 帐户。

有关如何使用 Azure 门户、PowerShell 或 Azure CLI 来设置和清除法定保留或如何创建基于时间的保留策略的信息，请参阅[为 Blob 存储设置和管理不可变性策略](storage-blob-immutability-policies-manage.md)。

> [!IMPORTANT]
> 对于启用了分层命名空间功能的帐户中的 Azure Blob 存储，不可变存储目前为预览版。
> 有关 beta 版本、预览版或尚未正式发布的版本的 Azure 功能所适用的法律条款，请参阅 [Microsoft Azure 预览版的补充使用条款](https://azure.microsoft.com/support/legal/preview-supplemental-terms/)。
>
>
> 若要注册预览版，请参阅[此表单](https://forms.microsoft.com/Pages/ResponsePage.aspx?id=v4j5cvGGr0GRqy180BHbR2EUNXd_ZNJCq_eDwZGaF5VUOUc3NTNQSUdOTjgzVUlVT1pDTzU4WlRKRy4u)。

## <a name="about-immutable-blob-storage"></a>关于不可变的 Blob 存储

不可变存储可以帮助医疗保健组织、金融机构和相关行业（&mdash;尤其是证券公司&mdash;）安全存储数据。 不可变存储还可以在任何场景中防止关键数据遭到修改或删除。

典型的应用程序包含：

- **法规遵从**：Azure Blob 存储的不可变存储可帮助组织达到 SEC 17a-4(f)、CFTC 1.31(d)、FINRA 和其他法规要求。 可以通过 [Microsoft 服务信任门户](https://aka.ms/AzureWormStorage)下载 Cohasset Associates 制定的技术白皮书，其中详述了不可变存储如何满足这些法规要求。 [Azure 信任中心](https://www.microsoft.com/trustcenter/compliance/compliance-overview)包含有关我们的合规认证的详细信息。

- **安全的文档保留**：Azure Blob 存储的不可变存储确保用户（包括具有帐户管理特权的用户）无法修改或删除数据。

- **法定保留**：Azure Blob 存储的不可变存储允许用户以防篡改状态存储对诉讼或商业用途而言非常重要的敏感信息，可将这些信息存储所需的一段时间，然后将其删除。 此功能并不局限于法律用例，而且还可将它视为基于事件的保留或企业锁定机制，满足企业根据事件触发器或政策保护数据的需求。

不可变存储支持以下功能：

- **[基于时间的保留策略支持](#time-based-retention-policies)** ：用户可以设置策略，按指定的时间间隔存储数据。 设置基于时间的保留策略后，可以创建和读取 Blob，但不能修改或删除 Blob。 保留期过后，可以删除但不能覆盖 Blob。

- **[法定保留策略支持](#legal-holds)** ：如果保留时间间隔未知，用户可以设置法定保留来存储不可变数据，直至法定保留得以清除。  设置法定保留策略后，可以创建和读取 Blob，但不能修改或删除 Blob。 每个法定保留都与一个用户定义的用作标识符字符串的字母数字标记（例如案例 ID、事件名称等）相关联。 

- **支持所有 Blob 层**：WORM 策略独立于 Azure Blob 存储层，将应用到所有层：热层、冷层和存档层。 用户可将工作负荷的数据转换为最具成本效益的层，同时保持数据的不可变性。

- **容器级配置**：用户可在容器级别配置基于时间的保留策略和法定保留标记。 通过使用简单的容器级设置，用户可以创建并锁定基于时间的保留策略、扩展保留时间间隔、设置并清除法定保留，等等。 这些策略将应用到容器中的所有 Blob，不管是现有的还是新的 Blob。 对于启用了 HNS 的帐户，这些策略也适用于容器中的所有目录。

- **审核日志记录支持**：每个容器包含一个策略审核日志。 该日志显示针对锁定的基于时间的保留策略执行的最多七个基于时间的保留命令，并且包含用户 ID、命令类型、时间戳和保留时间间隔。 对于法定保留，日志包含用户 ID、命令类型、时间戳和法定保留标记。 根据 SEC 17a-4(f) 法规准则，此日志的保留时间就是策略的生存时间。 [Azure 活动日志](../../azure-monitor/essentials/platform-logs-overview.md)显示所有控制平面活动的更全面日志；同时，启用 [Azure 资源日志](../../azure-monitor/essentials/platform-logs-overview.md)可以保留和显示数据平面操作。 由用户负责根据法规要求或其他要求永久存储这些日志。

## <a name="how-it-works"></a>工作原理

Azure Blob 存储的不可变存储支持两类 WORM 或不可变策略：基于时间的保留和法定保留。 在容器上应用基于时间的保留策略或法定保留时，所有现有的 Blob 会在 30 秒内转为不可变的 WORM 状态。 所有上传到受该策略保护的容器的新 Blob 也会转为不可变状态。 所有 Blob 转为不可变状态后，将确认不可变策略，并且不允许在不可变容器中执行任何覆盖或删除操作。 对于启用了 HNS 的帐户，不能重命名 Blob 或将其移到其他目录。

如果容器中的任何 Blob 受到法定保留策略或锁定的基于时间的策略的保护，则也不允许删除容器和存储帐户。 法定保留策略会防止删除 Blob、容器和存储帐户。 锁定的和未锁定的基于时间的策略会防止在指定的时间删除 Blob。 仅当容器中至少有一个 Blob 时，未锁定和锁定的基于时间的策略才会防止删除容器。 只有具有锁定的基于时间的策略的容器才能防止删除存储帐户；具有未锁定的基于时间的策略的容器不提供存储帐户删除保护与合规性。

下图显示了基于时间的保留策略和法定保留在有效时如何防止写入操作和删除操作。

:::image type="content" source="media/storage-blob-immutable-storage/worm-diagram.png" alt-text="此图显示了保留策略和法定保留如何防止写入操作和删除操作":::

若要详细了解如何设置和锁定基于时间的保留策略，请参阅[为 Blob 存储设置和管理不可变性策略](storage-blob-immutability-policies-manage.md)。

## <a name="time-based-retention-policies"></a>基于时间的保留策略

> [!IMPORTANT]
> 根据 SEC 17a-4(f) 和其他法规符合性要求，基于时间的保留策略必须处于锁定状态才能确保 Blob 既兼容又不可变（不可写入和删除）。 Microsoft 建议将策略锁定合理的时间，通常不到 24 小时。 已应用的基于时间的保留策略的初始状态为“未锁定”，在此状态下可以先测试该功能，并在锁定之前对策略进行更改。 虽然“解锁”状态提供不变性保护，但除非是短期功能试用，否则不建议使用“解锁”状态。
>
> 一旦基于时间的保留策略处于锁定状态，就不能将该策略删除，但允许延长有效保留期限，最多延迟五次。 保持期不能减少。

在容器上应用基于时间的保留策略时，容器中的所有 Blob 都会保持在不可变的状态，其持续时间就是有效保留期。 Blob 的有效保持期就是 Blob **创建时间** 和用户指定的保留时间间隔之间的差异。 由于用户可以延长保留时间间隔，因此不可变存储使用用户指定的保留时间间隔的最新值来计算有效保留期。

例如，假设用户创建了一个基于时间的保留策略，将保留时间间隔设置为五年。 一年前，在该容器中创建了现有的 Blob _testblob1_；因此，_testblob1_ 的有效保留期为四年。 将新 Blob _testblob2_ 上传到容器后，_testblob2_ 的有效保留期为五年（从其创建时间开始算起）。

根据 SEC 17a-4(f) 和其他法规符合性要求，基于时间的未锁定保留策略只建议用于功能测试，而通常情况下策略必须处于锁定状态。

以下限制适用于保留策略：

- 对于存储帐户，具有锁定的基于时间的不可变策略的最大容器数为 10,000。
- 最小保留时间间隔为 1 天。 最大值为 146,000 天（400 年）。
- 对于容器而言，为了延长锁定的基于时间的不可变策略的保留时间间隔而可执行的最大编辑次数为 5。
- 对于容器而言，将针对锁定策略最多保留七个基于时间的保留策略审核日志。

### <a name="allow-protected-append-blobs-writes"></a>允许受保护的追加 Blob 写入

追加 Blob 由数据块组成，并针对审核和日志记录方案所需的数据追加操作进行了优化。 按照设计，追加 Blob 只允许将新块添加到 Blob 末尾。 无论是否不可变，基本上都不允许修改或删除追加 Blob 中的现有块。 若要详细了解追加 Blob，请参阅[关于追加 Blob](/rest/api/storageservices/understanding-block-blobs--append-blobs--and-page-blobs#about-append-blobs)。

仅基于时间的保留策略具有 `allowProtectedAppendWrites` 设置，该设置允许将新块写入追加 Blob，同时维持不可变性保护和符合性。 在启用此设置的情况下，你可以直接在受策略保护的容器中创建追加 Blob，并使用 AppendBlock API 继续向现有追加 Blob 的末尾添加新数据块。 只能添加新块，而不能修改或删除任何现有块。 时间保留不可变性保护仍适用，系统会阻止删除追加 Blob，直到有效的保留期结束。 启用此设置不影响块 Blob 或页 Blob 的不可变性行为。

由于此设置是基于时间的保留策略的一部分，因此在有效保留期内追加 Blob 仍会保持不可变状态。 由于新数据可以在最初创建追加 Blob 之后追加，因此确定保留期的方式略有不同。 有效保留期是追加 Blob 的 **上次修改时间** 和用户指定的保留时间间隔之差。 类似地，当延长保留时间间隔时，不可变存储使用用户指定的保留时间间隔的最新值来计算有效保留期。

例如，假设用户创建了一项基于时间的保留策略，在启用 `allowProtectedAppendWrites` 的同时将保留时间间隔设置为 90 天。 现在，我们在容器中创建了追加 Blob _logblob1_，并会在接下来的 10 天内继续将新日志添加到追加 Blob，因此，_logblob1_ 的有效保留期是从今天开始算起的 100 天（上次追加的时间 + 90 天）。

未锁定的基于时间的保留策略允许随时启用和禁用 `allowProtectedAppendWrites` 设置。 锁定基于时间的保留策略后，不能更改 `allowProtectedAppendWrites` 设置。

法定保留策略无法启用 `allowProtectedAppendWrites`，任何法定保留都会将“allowProtectedAppendWrites”属性设置为 null。 如果在启用 `allowProtectedAppendWrites` 的情况下将法定保留应用于基于时间的保留策略，则 *AppendBlock* API 会失败，除非取消法定保留。

## <a name="legal-holds"></a>法定保留

法律保留是可用于法律调查目的或常规保护策略的临时保留。 每个法定保留策略需要与一个或多个标记相关联。 标记用作命名标识符（例如案例 ID 或事件），用于分类和描述保留的用途。

容器可能会同时有法定保留策略和基于时间的保留策略。 该容器中的所有 Blob 会一直保持不可变状态，直至所有法定保留被清除，即使有效保留期已过。 与之相反，即使所有法定保留已被清除，Blob 也会保持不可变状态，直至有效保留期已过。

以下限制适用于法定保留：

- 对于存储帐户，使用法定保留设置的最大容器数为 10,000。
- 对于某个容器而言，最大法定保留标记数为 10。
- 法定保留标记的最小长度为三个字母数字字符。 最大长度为 23 个字母数字字符。
- 对于容器而言，将根据策略的持续时间最多保留 10 个法定保留策略审核日志。

## <a name="scenarios"></a>方案

下表显示了会因各种不可变方案而禁用的 Blob 存储操作的类型。 有关详细信息，请参阅 [Azure Blob 服务 REST API](/rest/api/storageservices/blob-service-rest-api) 文档。

| 方案 | Blob 状态 | Blob 操作被拒绝 | 容器和帐户保护 |
|--|--|--|--|
| Blob 的有效保留时间间隔尚未到期，并且/或者法定保留已设置 | 不可变：不可删除和写入 | 放置 Blob<sup>1</sup>、放置块<sup>1</sup>、放置块列表<sup>1</sup>、删除容器、删除 Blob、设置 Blob 元数据、放置页、设置 Blob 属性、快照 Blob、增量复制 Blob、追加块<sup>2</sup> | 容器删除操作被拒绝；存储帐户删除操作被拒绝 |
| Blob 的有效保留间隔已过期，且未设置法定保留 | 仅仅不可写入（允许删除操作） | 放置 Blob<sup>1</sup>、放置块<sup>1</sup>、放置块列表<sup>1</sup>、设置 Blob 元数据、放置页、设置 Blob 属性、快照 Blob、增量复制 Blob、追加块<sup>2</sup> | 如果受保护容器中至少存在 1 个 Blob，则容器删除操作将被拒绝；仅拒绝锁定的基于时间的策略的存储帐户删除操作 |
| 未应用 WORM 策略（没有基于时间的保留，也没有法定保留标记） | 可变 | 无 | 无 |

<sup>1</sup> Blob 服务允许这些操作创建新的 Blob 一次。 不允许针对不可变容器中的现有 Blob 路径执行任何后续覆盖操作。

<sup>2</sup> 追加块只能用于基于时间且启用了 `allowProtectedAppendWrites` 属性的保留策略。 有关详细信息，请参阅[允许受保护的追加 Blob 写入](#allow-protected-append-blobs-writes)部分。

> [!IMPORTANT]
> 某些工作负载（如 [SQL Server 备份到 URL](/sql/relational-databases/backup-restore/sql-server-backup-to-url)）可创建 blob，然后将其添加到其中。 如果容器具有有效的基于时间的保留策略或法定保留，则此模式不会成功。

## <a name="pricing"></a>定价

使用此功能不会产生额外的费用。 不可变数据的定价方式与可变数据的定价方式相同。 有关 Azure Blob 存储中的定价详细信息，请参阅 [Azure 存储定价页](https://azure.microsoft.com/pricing/details/storage/blobs/)。

## <a name="faq"></a>常见问题

**你们是否可以提供有关 WORM 合规性的文档？**

是的。 为了表明我们的合规性，Microsoft 一直在与一家领先的独立评估机构 Cohasset Associates 保持合作。该机构专业从事记录管理和信息监管，可以评估不可变的 Blob 存储及其是否符合金融服务行业的相关要求。 经 Cohasset 验证，在用于保留 WORM 状态的基于时间的 Blob 时，不可变 Blob 存储符合 CFTC 规则 1.31(c)-(d)、FINRA 规则 4511 和 SEC 规则 17a-4 的相关存储要求。 Microsoft 以这一套规则为目标，因为这些规则代表了全球最规范的金融机构记录保留准则。 [Microsoft 服务信任中心](https://aka.ms/AzureWormStorage)已提供 Cohasset 的报告。 若要向 Microsoft 请求有关 WORM 不可变性合规性的证明信，请联系 Azure 支持。

**此功能是只适用于块 Blob 和追加 Blob，还是也适用于页 Blob？**

不可变存储可以用于任何 Blob 类型，因为它是在容器级别设置的，但我们建议你将 WORM 用于主要存储块 Blob 和追加 Blob 的容器。 容器中的现有 Blob 将受新设置的 WORM 策略的保护。 但是，需要在 WORM 容器外部创建任何新的页 Blob，然后复制它。 复制到 WORM 容器中后，不再允许对页 Blob 进行更改。 建议不要在存储 VHD（页 Blob）的容器上为任何活动的虚拟机设置 WORM 策略，因为它会锁定 VM 磁盘。 建议在锁定任何基于时间的策略之前，仔细查看文档并测试方案。

**是否需要创建新的存储帐户才能使用此功能？**

不用，可以将不可变存储与任何现有或新创建的常规用途 v1、常规用途 v2、高级块 blob 和旧 blob 帐户配合使用。 支持常规用途 v1 存储帐户，但我们建议升级到常规用途 v2，以便能够利用更多功能。 有关升级现有常规用途 v1 存储帐户的信息，请参阅[升级存储帐户](../common/storage-account-upgrade.md)。

**是否可以同时应用法定保留和基于时间的保留策略？**

是的。容器可以同时有法定保留和基于时间的保留策略；但是，在清除法定保留之前，“allowProtectedAppendWrites”设置不会应用。 该容器中的所有 Blob 会一直保持不可变状态，直至所有法定保留被清除，即使有效保留期已过。 与之相反，即使所有法定保留已被清除，Blob 也会保持不可变状态，直至有效保留期已过。 

**法定保留是否仅用于法律诉讼程序；是否还存在其他使用方案？**

否。法定保留只是非基于时间的保留策略的概括术语。 它并非只用于诉讼相关的程序。 在保留期为未知的情况下，法定保留策略可用于禁用覆盖和删除，以保护重要的企业 WORM 数据。 可将它用作一种企业策略来保护任务关键的 WORM 工作负荷，或者在自定义事件触发器要求使用基于时间的保留策略之前，将它用作一种临时策略。 

**是否可以删除锁定的基于时间的保留策略或法定保留？**

只能从容器中删除未锁定的基于时间的保留策略。 一旦基于时间的保留策略处于锁定状态，就不能将其删除，只能进行有效的保留期延长。 法定保留标记可以删除。 删除所有法定标记以后，就会删除法定保留。

**如果尝试删除某个容器，而该容器具有基于时间的保留策略或法定保留，会发生什么情况？**

如果容器中至少有一个 Blob 具有锁定的或未锁定的基于时间的保留策略，或者容器具有法定保留，则“删除容器”操作将会失败。 仅当容器中没有 Blob 且没有法定保留时，“删除容器”操作才会成功。 

**如果尝试删除的存储帐户有一个容器，而该容器具有基于时间的保留策略或法定保留，会发生什么情况？**

如果至少有一个容器设置了法定保留或者具有 **锁定的** 基于时间的策略，则存储帐户删除操作将会失败。 具有未锁定的基于时间的策略的容器无法防止删除存储帐户。 在删除存储帐户之前，必须先删除所有法定保留，并删除所有 **锁定的** 容器。 有关删除容器的信息，请查看上一个问题。 还可以使用 [Azure 资源管理器锁](../../azure-resource-manager/management/lock-resources.md)为存储帐户应用更多的删除保护。

**当 Blob 处于不可变状态时，是否可以跨不同的 Blob 层（热、冷、存档）来移动数据？**

是的，可以在数据处于合规的不可变状态时使用“设置 Blob 层”命令跨 Blob 层移动数据。 热、冷和存档 Blob 层均支持不可变存储。

**如果我无法付款，但我的保留时间间隔尚未到期，会发生什么情况？**

在未付款的情况下，会根据你与 Microsoft 签署的合同条款与条件应用常规的数据保留策略。 有关一般信息，请参阅 [Microsoft 数据管理](https://www.microsoft.com/en-us/trust-center/privacy/data-management)。 

**你们是否为只想试用此功能的用户提供试用期或宽限期？**

是的。 基于时间的保留策略在首先创建时，将处于未锁定状态。 在这种状态下，可以对保留时间间隔进行所需的更改，例如延长或缩短保留时间间隔，甚至可以删除策略。 策略被锁定后，它将保持锁定状态，直到保留时间间隔到期为止。 此锁定策略可以防止删除和修改保留时间间隔。 我们强烈建议仅在试用的情况下使用未锁定状态，并在 24 小时内锁定策略。 这种做法有助于遵守 SEC 17a-4(f) 及其他法规。

是否可以同时使用软删除和不可变的 blob 策略？

是，前提是合规性要求允许启用软删除。 [Azure Blob 存储的软删除](./soft-delete-blob-overview.md)适用于存储帐户内的所有容器，不考虑法定保留策略或基于时间的保留策略是否有效。 Microsoft 建议在应用任何不可变性策略之前启用软删除，以提供额外的保护。 如果在容器上启用了软删除，然后将不可变性策略添加到容器中，则在软删除保留策略过期后，将永久删除已软删除的任何 blob。 已被软删除的 blob 在软删除保留期内可还原。 尚未软删除的任何 blob 都受到不可变性策略的保护，在不可变策略过期（基于时间的保留）或被删除（法定保留）之后才能被软删除。

**对于启用了 HNS 的帐户，是否可以在 Blob 处于不可变状态时重命名或移动 Blob？**
不可以，名称和目录结构被视为重要的容器级数据，在不可变策略生效后不可对其进行修改。 一般情况下，只能对启用了 HNS 的帐户执行重命名和移动操作。

## <a name="next-steps"></a>后续步骤

- [为 Blob 存储设置和管理不可变性策略](storage-blob-immutability-policies-manage.md)
- [设置规则以自动分层和删除使用生命周期管理的 Blob 数据](storage-lifecycle-management-concepts.md)
- [Azure 存储 Blob 的软删除](./soft-delete-blob-overview.md)
- [使用 Azure 资源管理器锁保护订阅、资源组和资源](../../azure-resource-manager/management/lock-resources.md)
