---
title: 使用增强的前后脚本框架创建数据库一致性快照
description: 了解 Azure 备份如何使用 Azure VM 备份和打包的前后脚本创建数据库一致性快照
ms.topic: conceptual
ms.date: 09/01/2021
ms.custom: devx-track-azurepowershell
ms.openlocfilehash: 5b53a85521188a876b7a0d7368245c9d28910f39
ms.sourcegitcommit: add71a1f7dd82303a1eb3b771af53172726f4144
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 09/03/2021
ms.locfileid: "123439818"
---
# <a name="enhanced-pre-post-scripts-for-database-consistent-snapshot"></a>用于创建数据库一致性快照的增强的前后脚本

Azure 备份服务已提供 [_前后_ 脚本框架](/azure/backup/backup-azure-linux-app-consistent)，使用 Azure 备份实现 Linux VM 中的应用程序一致性。 这包括在创建磁盘快照之前调用前脚本（以静止应用程序），并在快照完成后调用后脚本（用于取消冻结应用程序的命令），使应用程序恢复到正常模式。 客户应创作这些前后脚本，并在 `etc/azure` 目录的 VMSnapshotScriptPluginConfig.json 文件中提供相关信息。 但是，客户担心脚本的创作、调试和维护，并将该工作视为一种开销。 因此，Azure 备份已决定为字幕数据库提供一种增强的前后脚本体验，这样用户就可以每天获取应用程序一致性快照，而无需任何额外的开销。 

下面介绍新的“增强的”前后脚本框架的主要优点。

- 这些前后脚本与备份扩展一起直接安装在 Azure VM 中。 你不需要创作它们，也无需担心从外部位置下载它们。
- 你仍然可以在 [GitHub](https://github.com/Azure/azure-linux-extensions/tree/master/VMBackup/main/workloadPatch/DefaultScripts) 中查看前后脚本的定义/内容。 你可以提交更改，Azure 备份团队将根据需要进行验证、审查和合并，让所有用户都可以受益。
- 此外，你还可以选择通过 [GitHub](https://github.com/Azure/azure-linux-extensions/tree/master/VMBackup/main/workloadPatch/DefaultScripts) 为任何其他数据库添加新的前后脚本。 通过足够的信息和测试，Azure 备份团队可以选择合并它们，并为所有用户提供。
- 这个框架现在非常可靠，可以处理前脚本执行失败或崩溃等情况。 在任何情况下，一定都会调用后脚本以回滚在前脚本中完成的所有更改。
- 该框架还为外部工具提供了一个消息传送通道，用于侦听和准备它们自己针对任何消息/事件的操作计划。

## <a name="support-matrix"></a>支持矩阵

增强的框架下涵盖了以下数据库列表：

- [Oracle（预览版）](/azure/virtual-machines/workloads/oracle/oracle-database-backup-azure-backup)
- MySQL（预览版）

## <a name="prerequisites"></a>必备条件

只需编辑 `/etc/azure` 中的配置文件 workload.conf 并提供连接信息，Azure 备份就可以连接到相关应用程序并执行前脚本和后脚本。 配置文件具有以下参数。

```json
[workload]
# valid values are mysql, oracle
workload_name =
command_path = 
linux_user =
credString = 
ipc_folder = 
timeout =
```

这些参数的解释如下所示。

|参数  |必需  |说明  |
|---------|---------|---------|
|workload_name     |   是      |     将显示必须为其完成应用程序一致性备份的数据库的名称。 当前支持的值为 `oracle` 或 `mysql`。    |
|command_path/configuration_path     |         |   将显示工作负载二进制文件的路径。 如果工作负载二进制文件设置为路径变量，则这不是必填字段      |
|linux_user     |    是     |   将显示有权访问数据库用户登录名的 linux_user 的用户名。 如果未设置此值，则 root 会被视为默认用户。      |
|credString     |         |     这表示用于连接到数据库的凭据字符串。 将显示整个登录名字符串    |
|ipc_folder     |         |   工作负载只能写入某些文件系统路径。 需要在此处提供此文件夹路径，以便前脚本可以将某些状态写入此文件路径。      |
|timeout     |    是     |     这是数据库处于静止状态的最长时间。 默认值为 90 秒。 不建议设置任何小于 60 秒的值    |

> [!NOTE]
> JSON 定义是 Azure 备份服务可根据特定数据库进行修改的模板。 若要了解每个数据库的配置文件，请参阅[每个数据库的详细手动流程](#support-matrix)。

总体而言，使用增强的前后脚本框架的客户体验如下所示：

- 准备数据库环境
- 编辑配置文件
- 触发 VM 备份
- 如有必要，从应用程序一致性恢复点还原 VM、磁盘或文件。

## <a name="build-a-database-backup-strategy"></a>生成数据库备份策略

### <a name="using-snapshots-instead-of-streaming"></a>使用快照，而不使用流式处理

通常，数据库管理员在他们的备份策略中使用流式处理备份（例如完整备份、差异备份或增量备份）和日志。 下面是设计中的一些关键中心点/关注点。

- 性能和成本：每日完整备份 + 日志在还原期间将是最快的，但成本会很高。 加入差异/增量备份会降低成本，但可能会影响还原性能。
- 对数据库/基础结构的影响：流式处理备份的性能取决于基础存储 IOPS 以及当流面向远程位置时可用的网络带宽。
- 可重用性：用于触发不同流式处理备份类型的命令对于每个数据库都是不同的。 因此，脚本不容易被重复使用。 此外，如果使用不同的备份类型，需要了解依赖关系链以维护生命周期。 当然，有些数据库客户端确实会照顾到这些方面，但这意味着备份数据也容易被这些客户端删除。
- 长期保留：完整备份绝对适合长期保留，因为它们可以在任何时间点独立移动和恢复。 快照保留有助于快速还原，从而避免因流式处理备份引起的性能问题。

- 性能和成本：它们通过 Azure VM 备份（也是增量备份）提供即时备份和还原以及快照，因此也具有成本效益。 如果将快照充当还原期间的完整备份，你可能不需要流式处理完整备份和增量备份，并节省操作备份的存储成本。
- 对数据库/基础结构的影响：快照对数据库和基础结构的影响最小。
- 可重用性：只需要了解一个命令，即每个数据库的快照。 不需要依赖关系链。 增强的前脚本负责该命令。
- 短期保留：它们可能不能用于长期保留（由于与基础存储的链接），但最适用于短期保留和每日操作备份。
 
关键要求是确保数据库在快照前后都参与其中，使用正确的命令冻结和解冻数据库，这些是在前后脚本中处理的。

### <a name="log-backup-strategy"></a>日志备份策略

增强的前后脚本框架建立在每天执行一次计划备份的 Azure VM 备份的基础之上。 因此，生产数据库不能接受 RPO 为 24 小时的数据丢失时间段。 此解决方案必须使用日志备份策略进行补充，其中日志备份是显式流式传输出来的。 随着 [blob 上的 NFS](/azure/storage/blobs/network-file-system-protocol-support) 和 [AFS 上的 NFS（预览版）](/azure/storage/files/files-nfs-protocol)的出现，直接在数据库 VM 上装载卷并使用数据库客户端传输日志备份会更容易。 数据丢失时间段（即 RPO）会下降到日志备份的频率。 此外，这些 NFS 目标的性能不必很高，因为如上所述，在获取数据库一致性快照后，可能不需要为操作备份触发常规流式处理（完整和增量备份）。

>[!NOTE]
>增强的前脚本通常会注意在将数据库静止以创建快照之前，将传输中的所有日志事务刷新到日志备份目标。 这意味着快照在恢复期间应该具备数据库一致性和可靠性。

### <a name="recovery-strategy"></a>恢复策略

创建数据库一致性快照并将日志备份流式传输至 NFS 卷后，数据库的恢复策略可以利用 Azure VM 备份的恢复功能，以及在使用数据库客户端的基础上应用日志备份的功能。 下面是恢复策略的一些选项：

- 从数据库一致性恢复点创建新的 VM。 VM 应已有日志装入点并与其连接。 使用数据库客户端运行恢复命令，进行时点恢复。
- 从数据库一致性恢复点创建磁盘。 将其附加到另一个目标 VM。 然后，装载日志目标并使用数据库客户端运行恢复命令以进行时点恢复
- 使用文件恢复选项并生成脚本。 在目标 VM 上运行脚本，并将恢复点附加为 iSCSI 磁盘。 使用数据库客户端在附加磁盘上运行特定于数据库的验证函数，并验证备份数据。 此外，使用数据库客户端导出/恢复几个表/文件，而不是恢复整个数据库。
- 使用跨区域还原功能，在区域性灾难期间从次要配对区域执行上述所有/任何操作。

## <a name="summary"></a>摘要

结合使用数据库一致性快照和采用自定义解决方案备份的日志，可以利用 Azure VM 备份的优势，并重复使用数据库客户端的功能，构建一个性能良好且经济高效的数据库备份解决方案。

