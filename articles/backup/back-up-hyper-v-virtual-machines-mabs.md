---
title: 使用 MABS 备份 Hyper-V 虚拟机
description: 本文介绍使用 Microsoft Azure 备份服务器 (MABS) 来备份和恢复虚拟机的过程。
ms.topic: conceptual
ms.date: 07/09/2021
ms.openlocfilehash: e10bab2af14cdf540b5c5ec9c670e6ccb2c8807a
ms.sourcegitcommit: b5508e1b38758472cecdd876a2118aedf8089fec
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 07/09/2021
ms.locfileid: "113585389"
---
# <a name="back-up-hyper-v-virtual-machines-with-azure-backup-server"></a>使用 Azure 备份服务器备份 Hyper-V 虚拟机

本文介绍如何使用 Microsoft Azure 备份服务器 (MABS) 备份 Hyper-V 虚拟机。

## <a name="supported-scenarios"></a>支持的方案

在以下情况下，MABS 可以备份 Hyper-V 主机服务器上运行的虚拟机：

- 具有本地或直接存储的虚拟机 - 备份托管在具有本地存储或直接连接存储的 Hyper-V 主机独立服务器上的虚拟机。 例如：硬盘驱动器、存储区域网络 (SAN) 设备或网络连接存储 (NAS) 设备。 必须在所有主机上安装 MABS 保护代理。

- 具有 CSV 存储的群集中的虚拟机 - 备份托管在具有群集共享卷 (CSV) 存储的 Hyper-V 群集上的虚拟机。 在每个群集节点上安装 MABS 保护代理。

## <a name="host-versus-guest-backup"></a>主机备份与来宾备份

MABS 可以对 Hyper-V VM 进行主机或来宾级别备份。 在主机级别，MABS 保护代理安装在 Hyper-V 主机服务器或群集上，保护该主机上运行的整个 VM 以及数据文件。   在来宾级别，代理安装在每个虚拟机上，保护该虚拟机上的工作负载。

这两种方法各有利弊：

- 主机级别备份非常灵活，因为无论来宾计算机上运行的 OS 类型是什么，它们都可以正常工作，且其不要求在每个 VM 上都安装 MABS 保护代理。 如果部署主机级别备份，则可以恢复整个虚拟机或者文件和文件夹（项级恢复）。

- 如果要保护虚拟机上运行的特定工作负载，则来宾级别备份很有用。 在主机级别，你可以恢复整个 VM 或特定文件，但该级别不为特定应用程序的上下文中的数据提供恢复。 例如，若要从备份 VM 恢复特定 SharePoint 项，则应对该 VM 进行来宾级别备份。 若要保护直通磁盘上存储的数据，请使用来宾级别备份。 直通可让虚拟机直接访问存储设备，而不需要在 VHD 文件中存储虚拟卷数据。

## <a name="how-the-backup-process-works"></a>备份进程的工作方式

MABS 按如下步骤使用 VSS 执行备份。 为清楚起见，本说明中的步骤会进行编号。

1. 基于 MABS 块的同步引擎会为受保护的虚拟机创建一个初始副本，并确保虚拟机的副本是完整且一致的。

2. 在创建初始副本并对其进行验证后，MABS 使用 Hyper-V VSS 编写器捕获备份。 VSS 编写器提供一组数据一致的磁盘块，这些磁盘块与 MABS 服务器同步。 此方法具备 MABS 服务器的“完整备份”优势，同时最大限度地减少了必须跨网络进行传输的备份数据。

3. 运行 Hyper-V 的服务器上的 MABS 保护代理使用现有的 Hyper-V API 来确定受保护的虚拟机是否也支持 VSS。

   - 如果虚拟机符合联机备份的要求且安装了 Hyper-V 集成服务组件，则 Hyper-V VSS 编写器会将 VSS 请求递归转发到虚拟机上所有 VSS 感知进程。 此操作在虚拟机上未安装 MABS 保护代理的情况下进行。 递归 VSS 请求使得 Hyper-V VSS 编写器可以确保磁盘写入操作保持同步，从而在不丢失数据的情况下捕获 VSS 快照。

     Hyper-V 集成服务组件在虚拟机上的卷影复制服务 (VSS) 中调用 Hyper-V VSS 编写器，确保其应用程序数据处于一致状态。

   - 如果虚拟机不符合联机备份要求，则 MABS 会自动使用 Hyper-V API，在虚拟机捕获数据文件之前暂停虚拟机。

4. 在初始基线副本的虚拟机与 MABS 服务器同步后，对虚拟机资源所做的所有更改都将在新的恢复点中进行捕获。 恢复点表示虚拟机在特定时间的一致状态。 恢复点捕获每天可能至少发生一次。 创建新的恢复点时，MABS 会将块级复制与 Hyper-V VSS 编写器结合使用，以确定在创建上一恢复点后，运行 Hyper-V 的服务器上更改了哪些块。 这些数据块随后会传输到 MABS 服务器，并应用于受保护数据的副本。

5. MABS 服务器在托管恢复数据的卷上使用 VSS，使多个卷影副本可用。 这些卷影副本均可提供单独的恢复。 VSS 恢复点存储在 MABS 服务器上。 在运行 Hyper-V 的服务器上创建的临时副本仅在 MABS 同步期间进行存储。

>[!NOTE]
>
>从 Windows Server 2016 开始，Hyper-V 虚拟硬盘配备了称为“可复原更改跟踪 (RCT)”的内置更改跟踪。 MABS 使用 RCT（Hyper-V 中的本机更改跟踪），可以在发生 VM 故障等情况时减少非常耗时的一致性检查的需求。 与基于 VSS 快照的备份提供的更改跟踪相比，RCT 提供更好的复原能力。 在执行任何一致性检查期间，MABS V3 只会传输更改的数据，因而可以进一步优化网络和存储消耗。

## <a name="backup-prerequisites"></a>备份先决条件

下面是使用 MABS 备份 Hyper-V 虚拟机的先决条件：

|先决条件|详细信息|
|------------|-------|
|MABS 先决条件|- 若要对虚拟机执行项级恢复（恢复文件、文件夹或卷），则需要在 MABS 服务器上启用 Hyper-V 角色（在安装 MABS 期间默认安装 Hyper-V 角色）。 如果只想恢复虚拟机而不进行项级恢复，则不需要该角色。<br />- 你可以在一台 MABS 服务器上保护最多 800 个虚拟机（每个虚拟机 100 GB），也可以允许多个支持更大群集的 MABS 服务器。<br />- MABS 从增量备份中排除页文件，提高虚拟机备份性能。<br />- MABS 可以在与 MABS 服务器相同的域或者在子域或受信任域中备份 Hyper-V 服务器或群集。 如果要在工作组或不受信任的域中备份 Hyper-V，则需要设置身份验证。 对于单个 Hyper-V 服务器，可以使用 NTLM 或证书身份验证。 对于群集，你只能使用证书身份验证。<br />- 不支持在直通磁盘上使用主机级别备份来备份虚拟机数据。 在这种情况下，建议使用主机级别备份来备份 VHD 文件，而使用来宾级别备份来备份主机上不可见的其他数据。<br />   \- 可以备份存储在已删除重复数据的卷上的 VM。|
|Hyper-V VM 先决条件|- 虚拟机上运行的集成组件的版本应与 Hyper-V 主机的版本相同。 <br />- 对于每个虚拟机备份，托管虚拟硬盘文件的卷上都需具有可用空间，以便在备份期间为 Hyper-V 留有足够空间供（AVHD 的）差异磁盘使用。 该空间必须至少等于“初始磁盘大小\*流失率\*备份窗口时间”的计算结果。 如果你在群集上运行多个备份，则需要足够的存储容量以容纳每个使用此计算的虚拟机的 AVHD。<br />- 若要备份位于运行 Windows Server 2012 R2 的 Hyper-V 主机服务器上的虚拟机，则即使虚拟机未连接到任何内容，也应为其指定 SCSI 控制器。 （在 Windows Server 2012 R2 备份中，Hyper-V 主机会在 VM 中装载新的 VHD，然后再将其卸除。 只有 SCSI 控制器可以支持这种情况，因此虚拟机的联机备份需要 SCSI 控制器。  如果没有此设置，在尝试备份虚拟机时，将发出事件 ID 10103。）|
|Linux 先决条件|- 可以使用 MABS 备份 Linux 虚拟机。 仅支持文件一致性快照。|
|通过 CSV 存储备份 VM|- 对于 CSV 存储，请在 Hyper-V 服务器上安装卷影复制服务 (VSS) 硬件提供程序。 请与你的存储区域网络 (SAN) 供应商联系，获取 VSS 硬件提供程序。<br />- 如果单个节点在 CSV 群集中意外关闭，则 MABS 将对在该节点上运行的虚拟机执行一致性检查。<br />- 如果需要重启在 CSV 群集上启用了 BitLocker 驱动器加密的 Hyper-V 服务器，则必须对 Hyper-V 虚拟机运行一致性检查。|
|通过 SMB 存储备份 VM|- 在运行 Hyper-V 的服务器上打开“自动装载”以启用虚拟机保护。<br />   - 禁用 TCP Chimney Offload。<br />- 确保所有 Hyper-V machine$ 帐户对特定的远程 SMB 文件共享都具有完全权限。<br />- 确保在恢复到备用位置期间，所有虚拟机组件的文件路径少于 260 个字符。 如果文件路径不少于 260 个字符，恢复可能会成功，但 Hyper-V 将无法装载虚拟机。<br />- 不支持以下场景：<br />     虚拟机的一些组件位于本地卷上，而一些组件位于远程卷上的部署；存储位置文件服务器的 IPv4 或 IPv6 地址；以及将虚拟机恢复到使用远程 SMB 共享的计算机。<br />- 需要在每个 SMB 服务器上启用文件服务器 VSS 代理服务 - 在“添加角色和功能” > “选择服务器角色” > “文件和存储服务” > “文件服务” > “文件服务” > “文件服务器 VSS 代理服务”中添加它     。|

## <a name="back-up-virtual-machines"></a>备份虚拟机

1. 设置 [MABS 服务器](backup-azure-microsoft-azure-backup.md)和[存储](backup-mabs-add-storage.md)。 设置存储时，请遵循以下存储容量规则。
   - 平均虚拟机大小 - 100 GB
   - 每个 MABS 服务器的虚拟机数量 - 800
   - 800 个 VM 的总大小 - 80 TB
   - 所需的备份存储空间 - 80 TB

2. 在 Hyper-V 服务器或 Hyper-V 群集节点上设置 MABS 保护代理。

3. 在 MABS 管理员控制台中，选择“保护” > “创建保护组”，打开“创建新的保护组”向导  。

4. 在“选择组成员”页上，在要保护的 VM 所在的 Hyper-V 主机服务器中进行选择。 建议将具有相同保护策略的所有 VM 放在一个保护组中。 为有效利用空间，请启用自动归置。 通过自动归置，可在同一磁盘或磁带存储上查找不同保护组中的数据，从而使多个数据源可具有单个副本和恢复点卷。

5. 在“选择数据保护方法”页上，指定保护组名称。 如果要使用 Azure 备份服务将数据备份到 Azure，请选择“我希望使用磁盘进行短期保护”，然后选择“我想要联机保护” 。

6. 在“指定短期目标” > “保持期”中，指定要保留磁盘数据的时长 。 在“同步频率”中，指定数据增量备份的运行频率。 你也可以启用“就在恢复点之前”，而不选择增量备份的时间间隔。 启用此设置后，MABS 会刚好在每个计划恢复点之前运行快速的完整备份。

    > [!NOTE]
    >
    >如果你要保护应用程序工作负载，系统会根据同步频率创建恢复点（前提是应用程序支持增量备份）。 如果其不支持增量备份，则 MABS 将运行快速完整备份而不是增量备份，并根据快速备份计划创建恢复点。<br></br>备份过程不会备份与 VM 关联的检查点。

7. 在“检查磁盘分配”页中，检查为保护组分配的存储池磁盘空间。

   “总数据大小”是要备份的数据大小，“要在 MABS 上预配的磁盘空间”是 MABS 建议用于保护组的空间 。 MABS 根据设置选择理想的备份卷。 但是，你可以在“磁盘分配详细信息”中编辑备份卷选项。 对于工作负荷，请在下拉菜单中选择首选的存储。 编辑时，更改的是“可用磁盘存储”窗格中的“总存储”和“可用存储”值。 预配不足的空间是 MABS 建议添加到卷以便将来继续顺利备份的存储量。

8. 在“选择副本创建方法”页上，指定如何对保护组中的数据执行初始复制。 如果你选择“通过网络自动复制”，我们建议你选择非高峰时间。 如果数据量很大或者网络状态欠佳，请考虑选择“手动”，这需要使用可移动媒体脱机复制数据。

9. 在“一致性检查选项”页上，选择要如何自动执行一致性检查。 你可以启用一项检查，使其仅在副本数据变得不一致时运行，或使其根据计划运行。 如果不想要配置自动一致性检查，可以随时运行手动检查，方法是：右键单击保护组，并选择“执行一致性检查”。

    创建保护组后，数据的初始复制将根据所选方法进行。 初始复制后，每个备份均根据保护组设置运行。 如果需要恢复备份数据，请注意以下事项：

## <a name="back-up-replica-virtual-machines"></a>备份副本虚拟机

如果 MABS 在 Windows Server 2012 R2 或更高版本上运行，你可备份副本虚拟机。 这非常有用，原因如下：

降低备份对运行中的工作负载的影响 - 执行虚拟机备份会在创建快照时产生一些开销。 通过将备份进程卸载到辅助远程站点，运行中的工作负载将不再受备份操作的影响。 这仅适用于备份副本存储在远程站点上的部署。 例如，你可以进行每日备份并在本地存储数据以确保快速还原，而从远程存储的副本虚拟机进行每月或每季度备份以实现长期保留。

节省带宽 - 在典型的远程分支机构/总部部署中，需要适当数量的预配带宽以在站点之间传输备份数据。 如果你创建复制和故障转移策略，则除数据备份策略外，还可以减少通过网络发送的冗余数据量。 通过备份副本虚拟机数据而不是主虚拟机数据，可以节省通过网络发送备份数据的开销。

启用主机托管服务提供商备份 - 可以使用托管数据中心作为副本站点，而无需辅助数据中心。 在这种情况下，主机托管服务提供商 SLA 要求对副本虚拟机进行一致的备份。

副本虚拟机在启动故障转移之前处于关闭状态，且 VSS 无法保证对副本虚拟机进行与应用程序一致的备份。 因此，副本虚拟机的备份仅能实现故障一致性。 如果无法保证故障一致性，则备份将失败，这种情况可能会在以下几种情况下出现：

- 副本虚拟机不正常，处于严重状态。

- 副本虚拟机正在重新同步（处于“正在重新同步”或“需要重新同步”状态）。

- 对于虚拟机，主站点和辅助站点之间的初始复制正在进行或挂起。

- .hrl 日志正在应用到副本虚拟机，或先前在虚拟磁盘上应用 .hrl 日志的操作失败、取消或中断。

- 副本虚拟机正在进行迁移或故障转移

## <a name="recover-backed-up-virtual-machines"></a>恢复已备份的虚拟机

若你可以恢复已备份的虚拟机，可使用恢复向导选择虚拟机和特定恢复点。 若要打开恢复向导并恢复虚拟机，请执行以下操作：

1. 在 MABS 管理员控制台中，键入 VM 的名称，或展开受保护项列表，导航到“所有受保护的 HyperV 数据”，然后选择要恢复的 VM。

2. 在“以下对象的恢复点”窗格中的日历上，选择任意日期来查看可用的恢复点。 然后，在“路径”窗格中，选择要在恢复向导中使用的恢复点。

3. 在“操作”菜单中，选择“恢复”以打开恢复向导 。

    所选的 VM 和恢复点将显示在“复查恢复选择”屏幕中。 选择“下一步”  。

4. 在“选择恢复类型”屏幕上，选择要将数据还原到的位置，然后选择“下一步” 。

    - 恢复到原始实例：恢复到原始实例时，将删除原始 VHD 和所有关联的检查点。 MABS 使用 Hyper-V VSS 编写器将 VHD 和其他配置文件恢复到原始位置。 在恢复过程结束时，虚拟机仍高度可用。
        必须存在资源组才能进行恢复。 如果其不可用，请恢复到备用位置，然后使虚拟机高度可用。

    - 作为虚拟机恢复到任何主机：MABS 支持备用位置恢复 (ALR)，该功能可将受保护的 Hyper-V 虚拟机无缝恢复到不同的 Hyper-V 主机，而不受处理器体系结构的影响。 恢复到群集节点的 Hyper-V 虚拟机不具有高可用性。 如果选择此选项，恢复向导将向你显示一个用于标识目标和目标路径的附加屏幕。
    
        >[!NOTE]
        >如果选择原始主机，则行为与“恢复到原始实例”的行为相同。 原始 VHD 和所有关联的检查点都将被删除。

    - 复制到网络文件夹：MABS 支持项级恢复 (ILR)，这允许你将文件、文件夹、卷和虚拟硬盘 (VHD) 从主机级别备份的 Hyper-V 虚拟机中进行项级恢复，恢复到网络共享或受 MABS 保护的服务器上的卷。 无需在来宾内部安装 MABS 保护代理即可执行项级恢复。 如果选择此选项，恢复向导将向你显示一个用于标识目标和目标路径的附加屏幕。

5. 在“指定恢复选项”中，配置恢复选项，然后选择“下一步” ：

    - 若要通过低带宽恢复 VM，请选择“修改”，启用“网络带宽使用限制” 。 打开限制选项后，可以指定可用的带宽量以及该带宽的可用时间。
    - 如果已配置网络，则选择“启用使用硬件快照的基于 SAN 的恢复”。
    - 如果你希望在恢复过程完成后向你发送电子邮件通知，请选择“恢复完成后发送电子邮件”，然后提供电子邮件地址。

6. 在“摘要”屏幕中，请确保所有详细信息都是正确的。 如果这些详细信息不正确，或者你想要进行更改，请选择“上一步”。 如果对设置满意，请选择“恢复”来启动恢复过程。

7. “恢复状态”屏幕提供有关恢复作业的信息。

## <a name="restore-an-individual-file-from-a-hyper-v-vm"></a>从 Hyper-V VM 还原单个文件 

你可从受保护的 Hyper-V VM 恢复点还原单个文件。 此功能仅适用于 Windows Server VM。 还原单个文件与恢复整个 VM 类似，除了在启动恢复过程之前需要浏览到 VMDK 并找到所需的文件。 若要从 Windows Server VM 恢复单个文件或选择的多个文件： 

>[!Note]
>从 Hyper-V VM 还原单个文件仅适用于 Windows VM 和磁盘恢复点。 

1. 在 MABS 管理员控制台中，选择“恢复”视图。 

1. 使用“浏览”窗格，浏览或筛选以查找要恢复的 VM。 选择 Hyper-V VM 或文件夹后，“以下对象的恢复点”窗格将显示可用的恢复点。 

    ![在“以下对象的恢复点”窗格从 Hyper-v VM 恢复文件](./media/back-up-hyper-v-virtual-machines-mabs/hyper-v-vm-rp-disk.png)

1. 在“以下对象的恢复点”窗格中，使用日历选择包含所需恢复点的日期。 根据备份策略的配置方式，日期可以具有多个恢复点。 选择恢复点的创建日期后，请确保选择正确的“恢复时间”。 如果所选日期包含多个恢复点，请在“恢复时间”下拉菜单中选择所需的恢复点。 选择恢复点后，可恢复项列表会出现在“路径”窗格中。 

1. 若要查找想要恢复的文件，请在“路径”窗格中，双击“可恢复项”列中的项将其打开。 选择想要恢复的文件或文件夹。 若要选择多个项目，请在选择每个项目时，按“Ctrl”键。 使用“路径”窗格搜索出现在“可恢复项”列中的文件或文件夹列表。“搜索以下列表”不会搜索其中的子文件夹。 若要搜索子文件夹，请双击文件夹。 使用“向上”按钮从子文件夹移动到父文件夹。 你可以选择多个项目（文件和文件夹），但它们必须在同一个父文件夹中。 不能在同一个恢复作业中恢复多个文件夹中的项。 

    ![在 Hyper-v VM 中查看恢复选择](./media/back-up-hyper-v-virtual-machines-mabs/hyper-v-vm-rp-disk-ilr-2.png) 

1. 选择要恢复的项后，在管理员控制台工具功能区中，选择“恢复”以打开“恢复向导” 。 在“恢复向导”中，“复查恢复选择”屏幕显示要恢复的所选项目。 

1. 在“指定恢复选项”屏幕上，若要启用网络带宽限制，请选择“修改” 。 若要禁用网络限制，请选择“下一步”。 在此向导屏幕上，无其他选项可用于 VMware VM。 如果选择修改网络带宽限制，请在“限制”对话框中，选择“启用网络带宽使用限制”来打开。 启用后，配置“设置”和“工作计划”。 

1. 在“选择恢复类型”屏幕上，选择“下一步” 。 只能将文件或文件夹恢复到网络文件夹。 

1. 在“指定目标”屏幕上，选择“浏览”，找到用于保存文件或文件夹的网络位置 。 MABS 将创建一个文件夹，所有已恢复的项将复制到其中。 该文件夹的名称前缀为 MABS_day-month-year。 当你选择已恢复文件或文件夹的位置时，提供该位置的详细信息（目标、目标路径和可用空间）。 

    ![指定从 Hyper-v VM 恢复文件的位置](./media/back-up-hyper-v-virtual-machines-mabs/hyper-v-vm-specify-destination.png) 

1. 在“指定恢复选项”屏幕上，选择要应用的安全设置。 你可以选择修改网络带宽使用限制，但默认情况下限制处于禁用状态。 “SAN 恢复”和“通知”也未启用 。 

1. 在“摘要”屏幕上检查设置，然后选择“恢复”来启动恢复过程 。 “恢复状态”屏幕显示恢复操作的进度。 

## <a name="next-steps"></a>后续步骤

[从 Azure 备份服务器恢复数据](./backup-azure-alternate-dpm-server.md)
