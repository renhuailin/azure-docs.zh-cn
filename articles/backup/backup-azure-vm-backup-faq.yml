### YamlMime:FAQ
metadata:
  title: 常见问题解答 - 备份 Azure VM
  description: 本文解答有关使用 Azure 备份服务备份 Azure VM 的常见问题。
  ms.topic: article
  ms.service: backup
  ms.date: 08/19/2021
  ms.openlocfilehash: 2b7ecc95117201d9ab60a39acf1d0f6ae60896a0
  ms.sourcegitcommit: 0770a7d91278043a83ccc597af25934854605e8b
  ms.translationtype: HT
  ms.contentlocale: zh-CN
  ms.lasthandoff: 09/13/2021
  ms.locfileid: "124799294"
title: 常见问题 - 备份 Azure VM
summary: >
  本文解答有关使用 [Azure 备份](./backup-overview.md)服务备份 Azure VM 的常见问题。
sections:
- name: Backup
  questions:
  - question: 哪些 VM 映像可以在创建时启用备份功能？
    answer: >
      创建 VM 时，可以为运行[受支持操作系统](backup-support-matrix-iaas.md#supported-backup-actions)的 VM 启用备份。
  - question: 为什么初始备份需要很长的时间才能完成？
    answer: >
      初始备份始终是完整备份，它取决于数据大小和处理备份的时间。


      若要提高备份性能，请参阅[备份最佳做法](./backup-azure-vms-introduction.md#best-practices)、[备份注意事项](./backup-azure-vms-introduction.md#backup-and-restore-considerations)和[备份性能](./backup-azure-vms-introduction.md#backup-performance)


      增量备份的总备份时间不超过 24 小时，但是，首次备份可能并非如此。
  - question: 备份成本包含在 VM 成本内吗？
    answer: >
      否。 备份成本独立于 VM 的成本。 详细了解 [Azure 备份定价](https://azure.microsoft.com/pricing/details/backup/)。
  - question: 为 VM 启用备份需要哪些权限？
    answer: >
      如果你是 VM 参与者，便可以在 VM 上启用备份。 如果你使用的是自定义角色，则需要具有以下权限才可在 VM 上启用备份：


      - Microsoft.RecoveryServices/Vaults/write

      - Microsoft.RecoveryServices/Vaults/read

      - Microsoft.RecoveryServices/locations/*

      - Microsoft.RecoveryServices/Vaults/backupFabrics/protectionContainers/protectedItems/*/read

      - Microsoft.RecoveryServices/Vaults/backupFabrics/protectionContainers/protectedItems/read

      - Microsoft.RecoveryServices/Vaults/backupFabrics/protectionContainers/protectedItems/write

      - Microsoft.RecoveryServices/Vaults/backupFabrics/backupProtectionIntent/write

      - Microsoft.RecoveryServices/Vaults/backupPolicies/read

      - Microsoft.RecoveryServices/Vaults/backupPolicies/write


      如果恢复服务保管库和 VM 的资源组不同，请确保具有恢复服务保管库资源组的写入权限。
  - question: 按需备份作业是否与计划的备份使用相同的保留计划？
    answer: 否。 为按需备份作业指定保留期。 默认情况下，从门户触发时，该作业会保留 30 天。
  - question: 我最近在一些 VM 上启用了 Azure 磁盘加密。 我的备份是否继续有效？
    answer: >
      提供 Azure 备份访问 Key Vault 所需的权限。 请根据 [Azure 备份 PowerShell](backup-azure-vms-automation.md) 文档的“启用备份”部分中所述，在 PowerShell 中指定权限。
  - question: 我将 VM 磁盘迁移到了托管磁盘。 我的备份是否继续有效？
    answer: 是的，备份可以顺利工作。 无需重新配置任何设置。
  - question: 为何在配置备份向导中看不到我的 VM？
    answer: 该向导只会列出保管库所在的同一区域中的 VM，以及不在备份的 VM。
  - question: 我的 VM 已关闭。 按需备份或计划备份会运行吗？
    answer: 是的。 计算机关闭时，将运行备份。 恢复点标记为崩溃一致。
  - question: 可以取消正在进行的备份作业吗？
    answer: 是的。 可以取消处于“正在创建快照”状态的备份作业。 如果作业正在从快照传输数据，则不能将它取消。
  - question: 我对由 Azure 备份服务创建的资源组（例如 `AzureBackupRG_<geo>_<number>`）启用了锁定。 我的备份是否继续有效？
    answer: >
      如果锁定 Azure 备份服务创建的资源组，则由于还原点的最大数目限制为 18 个，备份会开始失败。


      删除锁定，并从该资源组中清除还原点集合，以使将来的备份成功。 [按照这些步骤](backup-azure-troubleshoot-vm-backup-fails-snapshot-timeout.md#clean-up-restore-point-collection-from-azure-portal)删除还原点集合。
  - question: 我在包含与我的虚拟机相关的所有资源的资源组级别设置了一个锁。 我的备份是否会正常工作？
    answer: Azure 备份以 `AzureBackupRG_<geo>_<number>` 格式创建一个单独的资源组，以存储 ResourcePointCollections 对象。 由于此资源组由服务拥有，因此锁定该资源组会导致备份失败。 锁只能应用于客户创建的资源组。
  - question: Azure 备份是否支持标准 SSD 托管磁盘？
    answer: >
      是的，Azure 备份支持[标准 SSD 托管磁盘](../virtual-machines/disks-types.md#standard-ssd)。
  - question: 可使用支持写入加速器 (WA) 的磁盘备份 VM 吗？
    answer: 快照只能在已启用 WA 的数据磁盘上拍摄，而不能在 OS 磁盘上拍摄。 因此只能保护已启用 WA 的数据磁盘。
  - question: 我有一个安装了写入加速器 (WA) 磁盘和 SAP HANA 的 VM。 我该如何备份？
    answer: >
      Azure 备份可以备份已启用 WA 的数据磁盘。 但是，备份不会提供数据库一致性。


      Azure 备份为 SAP HANA 数据库提供了流式备份解决方案，其 RPO 为 15 分钟。 其通过 SAP 进行了 Backint 认证，利用 SAP HANA 的本机 API 提供本机备份支持。 了解[有关在 Azure VM 中备份 SAP HANA 数据库](./sap-hana-db-about.md)的详细信息。
  - question: 从我在 VM 备份策略中设置的计划备份时间开始，我可以预期的备份开始时间的最大延迟是多少？
    answer: >
      计划备份将在计划备份时间的 2 小时内触发。 例如，如果 100 个 VM 的备份开始时间安排在凌晨 2:00，则最晚到凌晨 4:00，所有 100 个 VM 的备份作业都将运行。 如果计划的备份由于停机而暂停并已恢复或重试，则备份可以在此计划的两小时时限之外启动。
  - question: 每日备份点允许的最短保持期是多久？
    answer: Azure 虚拟机备份策略支持的最短保持期为 7 天，最长为 9999 天。 对少于 7 天的现有 VM 备份策略进行任何修改都需要进行更新，以满足 7 天的最小保留期限。
  - question: 如果更改了 VM 或 VM 资源组名称的大小写，会发生什么情况？
    answer: 如果更改 VM 或 VM 资源组的大小写（更改为大写或小写），备份项名称的大小写不会更改。 但是，这是 Azure 备份的预期行为。 大小写更改不会出现在备份项中，而是在后端更新。
  - question: 能否备份或还原附加到 VM 的选择性磁盘？
    answer: >
      Azure 备份现在支持使用 Azure 虚拟机备份解决方案进行选择性磁盘备份和还原。 有关详细信息，请参阅 [Azure VM 的选择性磁盘备份和还原](selective-disk-backup-restore.md)。
  - question: 如果在备份过程中发生租户更改，是否保留托管标识？
    answer: >
      如果发生[租户更改](/azure/devops/organizations/accounts/change-azure-ad-connection)，则需要禁用并重新启用[托管标识](../active-directory/managed-identities-azure-resources/overview.md)才能重新运行备份。
  - question: Azure 备份是否支持备份从存储装载的 NFS 文件？
    answer: Azure 备份不支持将从存储或任何其他 NFS 服务器装载的 NFS 文件备份到 Linux 或 Windows 计算机。 它只能备份本地附加到 VM 的磁盘。
  - question: 虚拟机备份中存储了哪些 VM 配置？
    answer: 执行还原操作所需的所有 VM 配置均存储在 VM 备份中。 其中包括 VM 加密密钥的加密副本，你可以在还原时对其进行访问。 只能使用密钥保管库对加密副本进行解密。 快照中不捕获临时磁盘和内存状态。
  - question: 是否可以通过 Azure VM 备份标记？ 如果可以，能备份多少个标记？
    answer: Azure 备份可以备份和还原标记（除 NIC 和 IP 以外）。 Azure 备份支持 Azure 资源组的订阅限制，最多可还原 50 个标记。<br><br>有关详细信息，请参阅[订阅限制](../azure-resource-manager/management/azure-subscription-service-limits.md#subscription-limits)。
  - question: 是否可以进行按需（临时）备份而不为 Azure VM 计划备份？
    answer: >
      不行，无法通过禁用计划备份来触发按需备份。
  - question: Azure 备份过程如何为群集节点工作？
    answer: >
      群集中的每个 Azure VM 都被视为单个 Azure VM。 因此，所有备份操作都适用于单个 Azure VM。
  - question: Azure 备份是否会干扰应用程序性能？
    answer: >
      创建 VM 快照需要几分钟，在此阶段对应用程序性能的干扰非常小。 但是，将数据传输到保管库需要几小时；因此建议在非营业时间计划备份。 详细了解[备份和还原的最佳做法](./backup-azure-vms-introduction.md#backup-and-restore-considerations)。
  - question: 添加到 VM 的新磁盘是否会自动备份？
    answer: >
      是的，添加到 VM 的新磁盘会在下一次备份期间自动备份。
- name: 还原
  questions:
  - question: 如何确定是仅还原磁盘还是要还原整个 VM？
    answer: >
      可将 VM 还原视为 Azure VM 的快速创建选项。 此选项会更改磁盘名称、磁盘使用的容器、公共 IP 地址和网络接口名称。 创建 VM 时，更改将维护唯一资源。 VM 不会添加到可用性集。


      若要执行以下操作，可使用还原磁盘选项：


      - 自定义创建的 VM。 例如，更改大小。

      - 添加备份时不存在的配置设置。

      - 控制所创建的资源的命名约定。

      - 将 VM 添加到可用性集。

      - 添加必须使用 PowerShell 或模板进行配置的其他任何设置。
  - question: 升级到托管磁盘后，是否可以还原非托管 VM 磁盘的备份？
    answer: >
      是的，可以使用从非托管磁盘迁移到托管磁盘之前创建的备份。
  - question: 如何将 VM 还原至将它迁移到托管磁盘之前的某个还原点？
    answer: >
      还原过程保持不变。 如果恢复点是 VM 具有非托管磁盘的时间点，则可以[将磁盘还原为非托管磁盘](tutorial-restore-disk.md#unmanaged-disks-restore)。 如果当时 VM 具有托管磁盘，则可以[将磁盘还原为托管磁盘](tutorial-restore-disk.md#managed-disk-restore)。 然后，可以[从这些磁盘创建 VM](tutorial-restore-disk.md#create-a-vm-from-the-restored-disk)。


      [详细了解](backup-azure-vms-automation.md#restore-an-azure-vm)如何在 PowerShell 中执行此操作。
  - question: 如果还原无法创建 VM，还原中包含的磁盘会发生什么情况？
    answer: 如果是托管 VM 还原，则即使 VM 创建失败，也仍会还原磁盘。
  - question: 能否还原已删除的 VM？
    answer: 是的。 即使删除了 VM，也仍可以转到保管库中的相应备份项，然后[从恢复点还原](backup-azure-arm-restore-vms.md#select-a-restore-point)。
  - question: 如何将 VM 还原到相同的可用性集？
    answer: 对于托管磁盘 Azure VM，通过在还原为托管磁盘时在模板中提供选项来允许还原到可用性集。 此模板包含名为“可用性集”的输入参数。
  - question: 我们提高还原速度？
    answer: >
      [即时还原](backup-instant-restore-capability.md)功能有助于更快地备份和从快照即时还原。
  - question: 更改已加密 VM 的密钥保管库设置时会发生什么情况？
    answer: >
      更改已加密 VM 的密钥保管库设置后，备份将继续使用新的详细信息集。 但是，从更改之前的恢复点还原后，必须先在密钥保管库中还原机密，然后才能从中创建 VM。 有关详细信息，请参阅[此文](./backup-azure-restore-key-secret.md)。


      机密/密钥滚动更新等操作不需要此步骤，还原后可使用原来的密钥保管库。
  - question: 在还原后我是否由于 VM 与域控制器的关系被破坏而可以访问 VM？
    answer: >
      是，你可以在还原后由于 VM 与域控制器的关系被破坏而访问 VM。 有关详细信息，请参阅[此文](./backup-azure-arm-restore-vms.md#post-restore-steps)。
  - question: 能否取消正在进行的还原作业？
    answer: 不能，无法取消正在进行的还原作业。
  - question: 为什么还原操作需要很长时间才能完成？
    answer: 总还原时间取决于存储帐户的每秒输入/输出操作次数 (IOPS) 和吞吐量。 如果目标存储帐户加载了其他应用程序读写操作，则总还原时间可能会受到影响。 若要改进还原操作，请选择未加载其他应用程序数据的存储帐户。
  - question: 如何处理“创建新虚拟机”-还原类型与治理策略的冲突？
    answer: >
      Azure 备份使用恢复点中的“附加”磁盘，而不查看你的映像引用或库。 因此，在策略中，可以选中“storageProfile.osDisk.createOption as Attach”，脚本条件将为：


      `if (storageProfile.osDisk.createOption == "Attach") then { exclude <Policy> }`
  - question: 如何将 VM 还原到关机状态？
    answer: >
      若要将 VM 还原到关机状态，可以[创建 VM](./backup-during-vm-creation.md#create-a-vm-with-backup-configured) 或[还原磁盘](./backup-azure-arm-restore-vms.md#restore-disks)，但不能替换现有 VM。 详细了解[可用还原选项](./backup-azure-arm-restore-vms.md#restore-options)。
- name: 管理 VM 备份
  questions:
  - question: 如果修改备份策略，会发生什么情况？
    answer: >
      VM 是使用已修改策略或新策略中的计划和保留设置备份的。


      - 如果延长保留期，则会根据新策略对现有的恢复点进行标记和保留。

      - 如果缩短保留期，则会将恢复点标记为在下一清理作业中删除，随后会将其删除。
  - question: 如何将 Azure 备份备份的 VM 转移到不同的资源组？
    answer: >
      1. 暂时停止备份并保留备份数据。

      2. 若要移动配置了 Azure 备份的虚拟机，请执行以下步骤：

         1. 找到虚拟机的位置。
         2. 找到包含以下命名模式的资源组：`AzureBackupRG_<location of your VM>_1`。 例如 AzureBackupRG_westus2_1
         3. 在 Azure 门户中，查看“显示隐藏的类型”。
         4. 查找类型为 Microsoft.Compute/restorePointCollections 的资源，其命名模式为 `AzureBackup_<name of your VM that you're trying to move>_###########`。
         5. 删除此资源。 此操作仅删除即时恢复点，不删除保管库中的备份数据。
         6. 删除操作完成后，可以移动虚拟机。

      3. 将 VM 移到目标资源组。

      4. 恢复备份。


      可以从执行移动操作之前创建的可用还原点还原 VM。
  - question: 将 VM 移到其他资源组后会出现什么情况？
    answer: >
      将 VM 移到其他资源组后，就 Azure 备份而言，它是一个新的 VM。


      将 VM 移到新的资源组后，可以在同一保管库或其他保管库中重新保护 VM。 由于这对 Azure 备份而言是新 VM，因此将单独对其计费。


      如果需要，旧 VM 的还原点将可用于还原。 如果不需要此备份数据，则可以停止保护具有删除数据的旧 VM。
  - question: 对于可与同一备份策略关联的 VM 数是否有限制？
    answer: 有，可以从门户关联到同一备份策略的 VM 数量限制为 100 个。 我们建议，如果 VM 数超过 100 个，请创建具有相同计划或不同计划的多个备份策略。<br><br>保管库总体配置/修改保护的每日限制值为 1000。
  - question: 如何查看备份的保留设置？
    answer: >
      目前，你可根据分配给 VM 的备份策略来查看备份项 (VM) 级别的保留设置。


      要查看备份的保留设置，一种方法是在 Azure 门户中导航到 VM 的备份项[仪表板](./backup-azure-manage-vms.md#view-vms-on-the-dashboard)。 选择指向其备份策略的链接有助于查看与 VM 关联的全部每日、每周、每月和每年保留点的保留期。


      还可使用[备份资源管理器](./monitor-azure-backup-with-backup-explorer.md)在单一管理平台查看所有 VM 的保留设置。 从任何恢复服务保管库中导航到备份资源管理器，转到“备份项”选项卡，然后选择“高级视图”，查看每个 VM 的详细保留信息。
  - question: 当快照从存储帐户移到保管库时，如何管理传输中加密？
    answer: Azure VM 备份[使用 HTTPS 通信进行传输中加密](guidance-best-practices.md#encryption-of-data-in-transit-and-at-rest)。 数据传输使用 Azure 结构（而不是公共终结点），该结构无需访问 Internet 即可进行 VM 备份。
  - question: 如何禁用“文件恢复”选项？
    answer: >
      [此 API](/rest/api/backup/item-level-recovery-connections/provision) 可预配脚本来调用 iSCSI 连接，以便通过 Azure 备份进行文件恢复。

      - 可以通过排除 API 操作，使用“自定义角色定义”禁用此选项。

      - 还可使用[专用终结点](private-endpoints.md)限制从专用网络中访问 iSCSI 服务器。

      - 还可使用[拒绝分配](../role-based-access-control/deny-assignments.md)功能在整个组织中禁用此选项。
  - question: 我更改了保留策略，该策略生效需要多长时间？
    answer: >
      策略在修改参数（如保留、计划等）之后立即生效。 这适用于从修改后的策略创建的所有新备份。 但是，根据新策略删除恢复点（如果适用）需要 24 小时。
  - question: 执行跨区域还原时，我无法选择次要区域中的虚拟网络、子网或存储帐户。
    answer: >
      需要检查次要区域中的订阅权限。 请通过 [AskAzureBackupTeam@microsoft.com](mailto:AskAzureBackupTeam@microsoft.com) 联系我们以进行订阅注册。
  - question: 如何检查 Azure 备份服务与 Azure VM 之间的流量？
    answer: >
      由于 Azure 资源会处理此流量，因此它不能由外部用户确定。
  - question: Azure 备份中 VM 备份的最小 RPO 和 RTO 是多少？
    answer: RPO：最小 RPO 为 1 天或 24 小时。  <br><br>  RTO：快照存储在存储帐户中。 因此，从即时还原层进行还原是即时的。 此数据随后会传输到恢复服务保管库，该保管库由 Azure 备份服务进行维护，传输和还原需要几小时。
