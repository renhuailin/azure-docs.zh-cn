---
title: 诊断远程桌面图形性能问题 - Azure
description: 本文介绍如何在远程桌面协议会话中使用 RemoteFX 图形计数器诊断 Azure 虚拟桌面中的图形性能问题。
author: Heidilohr
ms.topic: troubleshooting
ms.date: 05/23/2019
ms.author: helohr
manager: femila
ms.openlocfilehash: 86d5aa82aaf51d0d2407799050f92a04a12c4a58
ms.sourcegitcommit: 8bca2d622fdce67b07746a2fb5a40c0c644100c6
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 06/09/2021
ms.locfileid: "111752920"
---
# <a name="diagnose-graphics-performance-issues-in-remote-desktop"></a>诊断远程桌面图形性能问题

为诊断远程会话体验质量的问题，性能监视器的“RemoteFX 图形”部分下已提供计数器。 本文将使用这些计数器帮助你查找并修复在远程桌面协议 (RDP) 会话期间遇到的与图形相关的性能瓶颈。

## <a name="find-your-remote-session-name"></a>查找远程会话名称

将需要远程会话名称来识别图形性能计数器。 请按照此部分中的说明识别每个计数器实例。

1. 从远程会话打开 Windows 命令提示符。
2. 运行 qwinsta 命令并查找你的会话名称。
    - 如果会话托管在多会话虚拟机 (VM) 中：每个计数器实例的后缀与会话名称的后缀具有相同的数字，例如“rdp-tcp 37”。
    - 如果会话托管在支持虚拟图形处理单元 (vGPU) 的 VM 中：每个计数器实例存储在服务器上而不是 VM 中。 计数器实例包含 VM 名称，而不是会话名称中的数字，例如“Win8 Enterprise VM”。

>[!NOTE]
> 虽然计数器名称中包含 RemoteFX，但它们在 vGPU 方案中也包含远程桌面图形。

## <a name="access-performance-counters"></a>访问性能计数器

确定远程会话名称后，请按照以下说明为远程会话收集 RemoteFX 图形性能计数器。

1. 选择“开始” > “管理工具” > “性能监视器”。
2. 在“性能监视器”对话框中展开“监视工具”，选择“性能监视器”，然后选择“添加”。   
3. 在“添加计数器”对话框的“可用计数器”列表中，展开“RemoteFX 图形”部分。 
4. 选择要监视的计数器。
5. 在“选定对象的实例”列表中，选择要为选定计数器监视的特定实例，然后选择“添加”。  若要选择所有可用的计数器实例，选择“所有实例”。
6. 添加计数器后，选择“确定”。

所选性能计数器将随即显示在“性能监视器”屏幕上。

>[!NOTE]
>主机上每个活动会话都具有每个性能计数器的实例。

## <a name="diagnose-issues"></a>诊断问题

图形相关的性能问题通常分为四个类别：

- 帧速率低
- 随机停顿
- 输入延迟高
- 低质量帧

### <a name="addressing-low-frame-rate-random-stalls-and-high-input-latency"></a>解决帧速率低、随机停顿和输入延迟高的问题

首先检查“输出帧数/秒”计数器。 它测量提供给客户端的帧数。 如果此值小于“输入帧数/秒”计数器，则跳过帧。 若要识别瓶颈，请使用“跳过的帧数/秒”计数器。

跳过的帧数/秒”计数器提供三种类型：

- 跳过的帧数/秒(服务器资源不足)
- 跳过的帧数/秒(网络资源不足)
- 跳过的帧数/秒(客户端资源不足)

值较大的任何“跳过的帧数/秒”计数器，都意味着问题与该计数器跟踪的资源有关。 例如，如果客户端没有以服务器提供帧的同一速率对帧进行解码和呈现，则“跳过的帧数/秒(客户端资源不足)”计数器的值将较大。

如果“输出帧数/秒”计数器与“输入帧数/秒”计数器相匹配，但仍注意到异常延迟或停顿，则“平均编码时间”可能是问题所在。 编码是在单一会话 (vGPU) 方案的服务器上和多会话方案的 VM 上发生的同步过程。 “平均编码时间”应低于 33 毫秒。 如果“平均编码时间”低于 33 毫秒，但仍存在性能问题，则正在使用的应用或操作系统可能存在问题。

有关诊断与应用相关的问题的详细信息，请参阅[“用户输入延迟”性能计数器](/windows-server/remote/remote-desktop-services/rds-rdsh-performance-counters/)。

由于 RDP 支持 33 毫秒的“平均编码时间”，因此它支持最多 30 帧/秒的输入帧速率。 请注意，33 毫秒是受支持的最大帧速率。 在许多情况下，用户遇到的帧速率会更低，具体取决于源向 RDP 提供帧的频率。 例如，观看视频等任务要求 30 帧/秒的最大输入帧速率，但低计算密集型任务（例如低频率文档编辑）会使“输入帧数/秒”的值变得更低，而不会降低用户的体验质量。

### <a name="addressing-poor-frame-quality"></a>解决低质量帧问题

使用“帧质量”计数器诊断帧质量问题。 此计数器以源帧质量百分比来表示输出帧的质量。 质量损失可能由 RemoteFX 导致，也可能是图形源本身的问题。 如果 RemoteFX 导致质量损失，则问题可能是缺少网络或服务器资源来发送更高保真的内容。

## <a name="mitigation"></a>缓解措施

如果服务器资源导致瓶颈，请尝试以下方法之一来提高性能：

- 减少每个主机的会话数。
- 增加服务器内存和计算资源。
- 降低连接分辨率。

如果网络资源导致瓶颈，请尝试以下方法之一来增强每个会话的网络可用性：

- 减少每个主机的会话数。
- 使用较高带宽的网络。
- 降低连接分辨率。

如果客户端资源导致瓶颈，请尝试以下方法之一来提高性能：

- 安装最新的远程桌面客户端。
- 增加客户端计算机的内存和计算资源。

> [!NOTE]
> 当前不支持“源帧数/秒”计数器。 目前，“源帧数/秒”计数器将始终显示 0。

## <a name="next-steps"></a>后续步骤

- 若要创建已优化 GPU 的 Azure 虚拟机，请参阅[为 Azure 虚拟桌面环境配置图形处理单元 (GPU) 加速](configure-vm-gpu.md)。
- 如需简要了解如何排查和跟踪升级，请参阅[故障排除概述、反馈和支持](troubleshoot-set-up-overview.md)。
- 若要详细了解服务，请参阅 [Windows 虚拟桌面环境](environment-setup.md)。
