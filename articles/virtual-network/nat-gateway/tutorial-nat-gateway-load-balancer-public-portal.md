---
title: 教程：将 NAT 网关与公共负载均衡器集成 - Azure 门户
titleSuffix: Virtual Network NAT
description: 在本教程中，了解如何使用 Azure 门户将虚拟网络 NAT 网关与公共负载均衡器集成。
author: asudbring
ms.author: allensu
ms.service: virtual-network
ms.subservice: nat
ms.topic: tutorial
ms.date: 03/19/2021
ms.custom: template-tutorial
ms.openlocfilehash: 5ef476f5de715d1f80823bf6d61316c1af406737
ms.sourcegitcommit: 47491ce44b91e546b608de58e6fa5bbd67315119
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/16/2021
ms.locfileid: "122202055"
---
# <a name="tutorial-integrate-a-nat-gateway-with-a-public-load-balancer-using-the-azure-portal"></a>教程：使用 Azure 门户将 NAT 网关与公共负载均衡器集成

在本教程中，您将了解如何将 NAT 网关与公共负载均衡器集成。

默认情况下，Azure 标准负载均衡器是安全的。 通过启用出站 SNAT（源网络地址转换）来显式定义出站连接。 在负载均衡规则或出站规则中启用了 SNAT。 

NAT 网关集成免去了对后端池出站 SNAT 的出站规则的需要。 

在本教程中，你将了解：

> [!div class="checklist"]
> * 创建 Azure 负载均衡器
> * 为 Azure 负载均衡器的后端池创建两个虚拟机
> * 创建 NAT 网关
> * 验证负载均衡器后端池中虚拟机的出站连接

## <a name="prerequisites"></a>先决条件

具有活动订阅的 Azure 帐户。 [免费创建帐户](https://azure.microsoft.com/free/?WT.mc_id=A261C142F)。

## <a name="create-the-virtual-network"></a>创建虚拟网络

在本部分，请创建虚拟网络和子网。

1. 在门户顶部的搜索框中，输入“虚拟网络”。 在搜索结果中，选择“虚拟网络”。

2. 在“虚拟网络”中，选择“+ 创建” 。

3. 在“创建虚拟网络”  的“基本信息”选项卡中输入或选择以下信息  ：

    | **设置**          | **值**                                                           |
    |------------------|-----------------------------------------------------------------|
    | **项目详细信息**  |                                                                 |
    | 订阅     | 选择 Azure 订阅                                  |
    | 资源组   | 选择“新建”。 </br> 在“名称”中输入“TutorPubLBNAT-rg” 。 </br> 选择“确定”。 |
    | **实例详细信息** |                                                                 |
    | 名称             | 输入“myVNet”                                    |
    | 区域           | 选择“(US)美国东部” |

4. 选择“IP 地址”选项卡  ，或选择页面底部的“下一步:  IP 地址”按钮。

5. 在“IP 地址”  选项卡上，输入以下信息：

    | 设置            | 值                      |
    |--------------------|----------------------------|
    | IPv4 地址空间 | 输入“10.1.0.0/16” |

6. 在“子网名称”下，选择词语“默认”。

7. 在“编辑子网”中输入以下信息： 

    | 设置            | 值                      |
    |--------------------|----------------------------|
    | 子网名称 | 输入“myBackendSubnet” |
    | 子网地址范围 | 输入“10.1.0.0/24” |

8. 选择“保存” 。

9. 选择“安全”选项卡。

10. 在“BastionHost”下，选择“启用” 。 输入此信息：

    | 设置            | 值                      |
    |--------------------|----------------------------|
    | Bastion 名称 | 输入“myBastionHost” |
    | AzureBastionSubnet 地址空间 | 输入 **10.1.1.0/27** |
    | 公共 IP 地址 | 选择“新建”。 </br> 对于“名称”，请输入“myBastionIP” 。 </br> 选择“确定”。 |


11. 选择“查看 + 创建”选项卡，或选择“查看 + 创建”按钮。

12. 选择“创建”。

## <a name="create-load-balancer"></a>创建负载均衡器

本部分将创建一个对虚拟机进行负载均衡的区域冗余负载均衡器。 使用区域冗余时，一个或多个可用性区域可能会发生故障，而数据路径可以幸存，但前提是该区域中有一个局部区域保持正常。

在创建负载均衡器的过程中，配置以下内容：

* 前端 IP 地址
* 后端池
* 入站负载均衡规则

1. 在门户顶部的搜索框中，输入“负载均衡器”。 在搜索结果中选择“负载均衡器”。

2. 在“负载均衡器”页上，选择“创建” 。

3. 在“创建负载均衡器”页的“基本信息”选项卡中，输入或选择以下信息： 

    | 设置                 | 值                                              |
    | ---                     | ---                                                |
    | **项目详细信息** |   |
    | 订阅               | 选择订阅。    |    
    | 资源组         | 选择 **TutorPubLBNAT-rg**。 |
    | **实例详细信息** |   |
    | 名称                   | 输入“myLoadBalancer”                                   |
    | 区域         | 选择“(US)美国东部”。                                        |
    | 类型          | 选择“公共”。                                        |
    | SKU           | 保留默认值“标准”。 |
    | 层          | 保留默认值“区域”。 |


4. 在页面底部选择“下一页: 前端 IP 配置”。

5. 在“前端 IP 配置”中，选择“+ 添加前端 IP” 。

6. 在“名称”中输入“LoadBalancerFrontEnd” 。

7. 对于“IP 版本”，请选择“IPv4”或“IPv6”  。

    > [!NOTE]
    > IPv6 目前不支持路由首选项或跨区域负载平衡（全局层）。

8. 选择“IP 类型”的“IP 地址” 。

    > [!NOTE]
    > 有关 IP 前缀的更多详细信息，请参阅 [Azure 公共 IP 地址前缀](../../virtual-network/public-ip-address-prefix.md)。

9. 在“公共 IP 地址”中选择“新建” 。

10. 在“添加公共 IP”的“名称”中输入“myPublicIP”  。

11. 在“可用性区域”中选择“区域冗余” 。

    > [!NOTE]
    > 在提供[可用性区域](../../availability-zones/az-overview.md?toc=%2fazure%2fvirtual-network%2ftoc.json#availability-zones)设置的区域中，可以选择无区域（默认选项）、特定区域或区域冗余。 请根据特定的域故障要求做出选择。 在不提供可用性区域设置的区域中，不会显示此字段。 </br> 有关可用性区域的详细信息，请参阅[可用性区域概述](../../availability-zones/az-overview.md)。

12. 保留“路由首选项”的默认值“Microsoft 网络” 。

13. 选择“确定” 。

14. 选择“添加”  。

15. 在页面底部选择“下一页: 后端池”。

16. 在“后端池”选项卡上，选择“+ 添加后端池” 。

17. 在“添加后端池”的“名称”中输入“myBackendPool”  。

18. 在“虚拟网络”中，选择“myVNet” 。

19. 对于“后端池配置”，请选择“NIC”或“IP 地址”  。

20. 对于“IP 版本”，请选择“IPv4”或“IPv6”  。

21. 选择 **添加** 。

22. 选择页面底部的“下一页: 入站规则”按钮。

23. 在“入站规则”选项卡的“负载均衡规则”中，选择“+ 添加负载均衡规则”  。

24. 在“添加负载均衡规则”中输入或选择以下信息：

    | 设置 | 值 |
    | ------- | ----- |
    | 名称 | 输入“myHTTPRule” |
    | IP 版本 | 根据要求选择“IPv4”或“IPv6” 。 |
    | 前端 IP 地址 | 选择“LoadBalancerFrontEnd”。 |
    | 协议 | 选择“TCP”。 |
    | 端口 | 输入 **80**。 |
    | 后端端口 | 输入 **80**。 |
    | 后端池 | 选择“myBackendPool”。 |
    | 运行状况探测 | 选择“新建”。 </br> 在“名称”中输入“myHealthProbe” 。 </br> 在“协议”中选择“HTTP” 。 </br> 将剩余的字段保留为默认值，然后选择“确定”。 |
    | 会话暂留 | 选择“无”。 |
    | 空闲超时（分钟） | 输入或选择“15”。 |
    | TCP 重置 | 选择“启用”。  |
    | 浮动 IP | 选择“已禁用”。  |
    | 出站源网络地址转换 (SNAT) | 保留默认值“(建议)使用出站规则为后端池成员提供对 Internet 的访问权限。” |

25. 选择 **添加** 。

26. 选择页面底部的“查看 + 创建”蓝色按钮。

27. 选择“创建”。

## <a name="create-virtual-machines"></a>创建虚拟机

在本部分中，您将在两个不同的区域（**区域 1** 和 **区域 2**）中创建两个 VM（**myVM1** 和 **myVM2**）。

这些 VM 将添加到先前创建的负载均衡器的后端池中。

1. 在门户的左上方，选择“创建资源” > “计算” > “虚拟机”  。 
   
2. 在“创建虚拟机”中，在“基本信息”选项卡中键入或选择值：

    | 设置 | 值                                          |
    |-----------------------|----------------------------------|
    | **项目详细信息** |  |
    | 订阅 | 选择 Azure 订阅 |
    | 资源组 | 选择 **TutorPubLBNAT-rg** |
    | **实例详细信息** |  |
    | 虚拟机名称 | 输入“myVM1” |
    | 区域 | 选择“(US)美国东部” |
    | 可用性选项 | 选择“可用性区域” |
    | 可用性区域 | 选择“1” |
    | 映像 | 选择“Windows Server 2019 Datacenter” |
    | Azure Spot 实例 | 保留默认值 |
    | 大小 | 选择 VM 大小或采用默认设置 |
    | **管理员帐户** |  |
    | 用户名 | 输入用户名 |
    | 密码 | 输入密码 |
    | 确认密码 | 重新输入密码 |
    | **入站端口规则** |  |
    | 公共入站端口 | 选择“无” |

3. 选择“网络”选项卡，或选择“下一步: **磁盘”，然后选择“下一步:** 网络”。
  
4. 在“网络”选项卡中，选择或输入：

    | 设置 | 值 |
    |-|-|
    | **网络接口** |  |
    | 虚拟网络 | myVNet |
    | 子网 | myBackendSubnet |
    | 公共 IP | 选择“无”。 |
    | NIC 网络安全组 | 选择“高级”|
    | 配置网络安全组 | 选择“新建”。 </br> 在“创建网络安全组”中，在“名称”中输入“myNSG”  。 </br> 在“入站规则”下，选择“+ 添加入站规则” 。 </br> 在“目标端口范围”中，输入“80” 。 </br> 在“优先级”下，输入“100” 。 </br> 在“名称”中输入“myNSGRule”  </br> 选择“添加” </br> 选择“确定” |
    | **负载均衡**  |
    | 是否将此虚拟机置于现有的负载均衡解决方案之后？ | 选择此复选框。|
    | **负载均衡设置** |
    | 负载均衡选项 | 选择“Azure 负载均衡器”  |
    | 选择负载均衡器 | 选择“myLoadBalancer”  |
    | 选择后端池 | 选择“myBackendPool” |
   
5. 选择“查看 + 创建”。 
  
6. 检查设置，然后选择“创建”。

7. 按照步骤 1 到 7 操作，使用以下值创建一个 VM，所有其他设置均与 **myVM1** 相同：

    | 设置 | VM 2 |
    | ------- | ----- |
    | 名称 |  **myVM2** |
    | 可用性区域 | **2** |
    | 网络安全组 | 选择现有的“myNSG” | 

## <a name="create-nat-gateway"></a>创建 NAT 网关

在本部分中，您将创建一个 NAT 网关，并将其分配给您之前创建的虚拟网络中的子网。

1. 在屏幕的左上方，选择“创建资源”>“网络”>“NAT 网关”，或者在搜索框中搜索“NAT 网关” 。

2. 选择“创建”。 

3. 在“创建网络地址转换(NAT)网关”中，在“基本信息”选项卡中输入或选择以下信息 ：

    | **设置**          | **值**                                                           |
    |------------------|-----------------------------------------------------------------|
    | **项目详细信息**  |                                                                 |
    | 订阅     | 选择 Azure 订阅。                                  |
    | 资源组   | 选择 **TutorPubLBNAT-rg**。 |
    | **实例详细信息** |                                                                 |
    | 名称             | 输入 **myNATGateway**                                    |
    | 区域           | 选择“(US)美国东部”  |
    | 可用性区域 | 选择“无”。 |
    | 空闲超时（分钟） | 输入“10”。 |

4. 选择“出站 IP”选项卡，或者选择“下一步:出站 IP”按钮（位于页面底部） 。

5. 在“出站 IP”选项卡中，输入或选择以下信息：

    | **设置** | **值** |
    | ----------- | --------- |
    | 公共 IP 地址 | 选择“创建新的公共 IP 地址”。 </br> 在“名称”中输入“myNATgatewayIP” 。 </br> 选择“确定”。 |

6. 选择“子网”选项卡，或者选择“下一步:子网”按钮（位于页面底部） 。

7. 在“子网”选项卡中，选择“虚拟网络”下拉列表中的“myVNet”  。

8. 选中 **myBackendSubnet** 旁边的复选框。

9. 选择“查看 + 创建”选项卡，或选择页面底部的“查看 + 创建”按钮 。

10. 选择“创建”。

## <a name="test-nat-gateway"></a>测试 NAT 网关

在本部分中，我们将测试 NAT 网关。 首先，我们将发现 NAT 网关的公共 IP。 然后，我们将连接到测试虚拟机，并通过 NAT 网关验证出站连接。
    
1. 在“概述”屏幕上找到 NAT 网关的公共 IP 地址。 在左侧菜单中选择“所有服务”，选择“所有资源”，然后选择“myPublicIP”。

2. 记下公共 IP 地址：

    :::image type="content" source="./media/tutorial-nat-gateway-load-balancer-public-portal/find-public-ip.png" alt-text="发现 NAT 网关的公共 IP 地址的屏幕截图。" border="true":::

3. 在左侧菜单中选择 **所有服务**，选择 **所有资源**，然后从资源列表中选择位于 **TutorPubLBNAT-rg** 资源组中的 **myVM1**。

4. 在“概述”页上，选择“连接”，然后选择“Bastion”  。

5. 选择蓝色的“使用堡垒”按钮。

6. 输入在 VM 创建过程中输入的用户名和密码。

7. 在 **myVM1** 中打开 **Internet Explorer**。

8. 在地址栏中输入“https://whatsmyip.com”。

9. 验证显示的 IP 地址与你在上一步中记下的 NAT 网关地址是否匹配：

    :::image type="content" source="./media/tutorial-nat-gateway-load-balancer-public-portal/my-ip.png" alt-text="显示外部出站 IP 的 Internet Explorer 的屏幕截图。" border="true":::

## <a name="clean-up-resources"></a>清理资源

如果你不打算继续使用此应用程序，请按以下步骤删除虚拟网络、虚拟机和 NAT 网关：

1. 从左侧菜单中，选择“资源组”。

2. 选择 **TutorPubLBNAT-rg** 资源组。

3. 选择“删除资源组”。

4. 输入 **TutorPubLBNAT-rg**，然后选择 **删除**。

## <a name="next-steps"></a>后续步骤

有关 Azure 虚拟网络 NAT 的详细信息，请参阅：
> [!div class="nextstepaction"]
> [虚拟网络 NAT 概述](nat-overview.md)