---
title: 将漏洞评估扫描结果存储在可从防火墙和 VNet 后面访问的存储帐户中
description: 提供有关如何将漏洞评估 (VA) 扫描存储在可通过防火墙或 VNet 访问的存储帐户中的说明
services: sql-database
ms.service: sql-db-mi
ms.subservice: security
ms.topic: how-to
author: davidtrigano
ms.author: datrigan
ms.reviewer: vanto
ms.date: 12/01/2020
ms.openlocfilehash: bc2fb5032376f96319d653b17c73596b28033aa8
ms.sourcegitcommit: 079426f4980fadae9f320977533b5be5c23ee426
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 10/04/2021
ms.locfileid: "129418435"
---
# <a name="store-vulnerability-assessment-scan-results-in-a-storage-account-accessible-behind-firewalls-and-vnets"></a>将漏洞评估扫描结果存储在可从防火墙和 VNet 后面访问的存储帐户中
[!INCLUDE[appliesto-sqldb-sqlmi-asa](../includes/appliesto-sqldb-sqlmi-asa.md)]

如果要限制某些 VNet 或服务对 Azure 中的存储帐户的访问，则需要启用相应的配置，以便对 SQL 数据库或托管实例的漏洞评估 (VA) 扫描可以访问该存储帐户。

## <a name="prerequisites"></a>先决条件

SQL 漏洞评估服务需要具有对存储帐户的权限才能保存基线和扫描结果。  有三种方法： 
- 使用存储帐户密钥：Azure 创建并保存 SAS 密钥（但我们不会保存帐户密钥）
- 使用存储 SAS 密钥：SAS 密钥必须具有：写入 | 列出 | 读取 | 删除权限
- 使用 SQL Server 托管标识：SQL Server 必须具有托管标识。 存储帐户必须有 SQL 托管标识的角色分配作为[存储 Blob 数据参与者](https://docs.microsoft.com/azure/role-based-access-control/built-in-roles#storage-blob-data-contributor)。 应用设置时，VA 字段 storageContainerSasKey 和 storageAccountAccessKey 必须为空。 当存储位于防火墙或虚拟网络后面时，需要 SQL 托管标识。 

当你使用 Azure 门户保存 SQL VA 设置时，Azure 会检查你是否有权为托管标识分配一个新的角色分配作为存储上的[存储 Blob 数据参与者](https://docs.microsoft.com/azure/role-based-access-control/built-in-roles#storage-blob-data-contributor)。 如果分配了权限，Azure 将使用 SQL Server 标识，否则将使用密钥方法。 

## <a name="enable-azure-sql-database-va-scanning-access-to-the-storage-account"></a>启用 Azure SQL 数据库 VA 扫描对存储帐户的访问权限

如果已将 VA 存储帐户配置为仅可由某些网络或服务访问，则需要确保 Azure SQL 数据库的 VA 扫描能够在存储帐户上存储扫描。 可以使用现有存储帐户，也可以创建新的存储帐户来存储[逻辑 SQL Server](logical-servers.md) 上所有数据库的 VA 扫描结果。

> [!NOTE]
> 漏洞评估服务在存储帐户需要存储访问密钥的情况下，无法访问受防火墙或 VNet 保护的存储帐户。

转到包含存储帐户的“资源组”，然后访问“存储帐户”窗格。 在“设置”下，选择“防火墙和虚拟网络”。

确保已选中“允许受信任的 Microsoft 服务访问此存储帐户”。

:::image type="content" source="media/sql-database-vulnerability-assessment-storage/storage-allow-microsoft-services.png" alt-text="屏幕截图显示了“防火墙和虚拟网络”对话框，其中选中了“允许受信任的 Microsoft 服务访问此存储帐户”。":::

若要找出正在使用的存储帐户，请转到 [Azure 门户](https://portal.azure.com)中的“SQL 服务器”窗格，在“安全性”下选择“安全中心”。

:::image type="content" source="../database/media/azure-defender-for-sql/va-storage.png" alt-text="设置漏洞评估":::

> [!NOTE]
> 可以设置电子邮件警报来通知组织中的用户查看或访问扫描报告。 为此，请确保具有 SQL 安全管理者和存储 Blob 数据读者权限。

## <a name="store-va-scan-results-for-azure-sql-managed-instance-in-a-storage-account-that-can-be-accessed-behind-a-firewall-or-vnet"></a>将 Azure SQL 托管实例的 VA 扫描结果存储在可从防火墙或 VNet 后面访问的存储帐户中

由于托管实例不是受信任的 Microsoft 服务，并且具有与存储帐户不同的 VNet，执行 VA 扫描将导致错误。

若要在托管实例上支持 VA 扫描，请执行以下步骤：

1. 在“SQL 托管实例”窗格的“概述”标题下，单击“虚拟网络/子网”链接。 这会转到“虚拟网络”窗格。

   :::image type="content" source="../managed-instance/media/public-endpoint-configure/mi-overview.png" alt-text="mi-overview2":::

1. 在“设置”下，选择“子网”。 单击新窗格中的“子网”以添加子网，并将其委托给 Microsoft.Sql\managedInstance。 有关详细信息，请参阅[管理子网](../../virtual-network/virtual-network-manage-subnet.md)。

   :::image type="content" source="media/sql-database-vulnerability-assessment-storage/mi-subnets.png" alt-text="屏幕截图显示已被委托了 Microsoft.sql\managedInstance 的子网。":::

1. 在“虚拟网络”窗格的“设置”下，选择“服务终结点”。 在新窗格中单击“添加”，然后将“Microsoft.Storage”服务作为新的服务终结点添加。 确保选择了“ManagedInstance”子网。 单击“添加” 。

   :::image type="content" source="media/sql-database-vulnerability-assessment-storage/mi-service-endpoint.png" alt-text="屏幕截图显示了“添加服务终结点”，可以在其中添加 Microsoft.Storage 服务作为终结点。":::

1. 转到选择用于存储 VA 扫描的“存储帐户”。 在“设置”下，选择“防火墙和虚拟网络”。 单击“添加现有虚拟网络”。 选择托管实例虚拟网络和子网，然后单击“添加”。

   :::image type="content" source="media/sql-database-vulnerability-assessment-storage/storage-firewall.png" alt-text="屏幕截图显示了“防火墙和虚拟网络”窗格，其中包含“添加现有虚拟网络”链接。":::

现在，你应该能够在存储帐户中存储托管实例的 VA 扫描。

## <a name="troubleshoot-vulnerability-assessment-scan-related-issues"></a>排查漏洞评估扫描相关问题 

排查与漏洞评估扫描相关的常见问题。

### <a name="failure-to-save-vulnerability-assessment-settings"></a>无法保存漏洞评估设置

如果存储帐户不满足某些先决条件或你的权限不足，则可能无法保存对漏洞评估设置进行的更改。

#### <a name="storage-account-requirements"></a>存储帐户要求

保存漏洞评估扫描结果的存储帐户必须满足以下要求：

- 类型：StorageV2（常规用途 V2）或存储（常规用途 V1）
- 性能：标准（仅限）
- 区域：存储必须与 Azure SQL Server 实例位于同一区域。

如果未满足这些要求中的任何一项，则无法保存对漏洞评估设置进行的更改。

#### <a name="permissions"></a>权限 

保存对漏洞评估设置进行的更改需要以下权限：

- SQL 安全管理器
- 存储 Blob 数据读取者

设置新的角色分配需要所有者或用户管理员对存储帐户的访问权限以及以下权限：

- 存储 Blob 数据所有者

### <a name="storage-account-isnt-visible-for-selection-in-vulnerability-assessment-settings"></a>存储帐户在漏洞评估设置中不可见，无法进行选择

由于以下原因，存储帐户可能不会在存储帐户选取器中显示：

- 要查找的存储帐户不在所选订阅中。
- 要查找的存储帐户与 Azure SQL Server 实例不在同一区域。
- 存储帐户没有 Microsoft.Storage/storageAccounts/read 权限。

### <a name="failure-to-open-an-email-link-for-scan-results-or-cant-view-scan-results"></a>无法打开扫描结果的电子邮件链接，或不能查看扫描结果

如果没有所需的权限，或者使用不支持打开或显示扫描结果的浏览器，则可能无法打开通知电子邮件中有关扫描结果的链接或查看扫描结果。

#### <a name="permissions"></a>权限

需要以下权限才可打开电子邮件通知中有关扫描结果的链接或查看扫描结果：

- SQL 安全管理器
- 存储 Blob 数据读取者

#### <a name="browser-requirements"></a>浏览器要求

Firefox 浏览器不支持打开或显示扫描结果视图。 建议使用 Chrome 或 Microsoft Edge 查看漏洞评估扫描结果。

## <a name="next-steps"></a>后续步骤

- [漏洞评估](sql-vulnerability-assessment.md)
- [创建 Azure 存储帐户](../../storage/common/storage-account-create.md)
- [Azure Defender for SQL](azure-defender-for-sql.md)
