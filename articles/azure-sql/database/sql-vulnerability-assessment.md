---
title: SQL 漏洞评估
titleSuffix: Azure SQL Database & SQL Managed Instance & Azure Synapse Analytics
description: 了解如何在 Azure SQL 数据库、Azure SQL 托管实例和 Azure Synapse Analytics 上配置 SQL 漏洞评估并解释评估报告。
services: sql-database
ms.service: sql-db-mi
ms.subservice: security
ms.custom: sqldbrb=3
ms.devlang: ''
ms.topic: how-to
author: davidtrigano
ms.author: datrigan
ms.reviewer: vanto
ms.date: 04/09/2021
tags: azure-synapse
ms.openlocfilehash: f8869917d1e17c2c95a96466c8c953672b1667a2
ms.sourcegitcommit: 87de14fe9fdee75ea64f30ebb516cf7edad0cf87
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 10/01/2021
ms.locfileid: "129352485"
---
# <a name="sql-vulnerability-assessment-helps-you-identify-database-vulnerabilities"></a>SQL 漏洞评估可帮助识别数据库漏洞
[!INCLUDE[appliesto-sqldb-sqlmi-asa](../includes/appliesto-sqldb-sqlmi-asa.md)]

SQL 漏洞评估是一项易于配置的服务，可发现、跟踪并帮助修正潜在的数据库漏洞。 可以使用此工具积极提升数据库安全性。

漏洞评估是 [Azure Defender for SQL](azure-defender-for-sql.md) 产品/服务（高级 SQL 安全功能的统一包）的一部分。 可通过中心 Azure Defender for SQL 门户访问和管理漏洞评估。

> [!NOTE]
> Azure SQL 数据库、Azure SQL 托管实例和 Azure Synapse Analytics 支持漏洞评估。 本文其余部分将 Azure SQL 数据库、Azure SQL 托管实例和 Azure Synapse 中的数据库统称为数据库，并且服务器指的是为 Azure SQL 数据库和 Azure Synapse 托管数据库的[服务器](logical-servers.md)。

## <a name="what-is-sql-vulnerability-assessment"></a>什么是 SQL 漏洞评估？

SQL 漏洞评估是一种提供对于安全状态的可见性的服务。 漏洞评估包括用于解决安全问题和增强数据库安全性的可操作步骤。 它可帮助监视难以跟踪更改的动态数据库环境，并改善 SQL 安全状况。

漏洞评估是一种内置于 Azure SQL 数据库中的扫描服务。 该服务采用一个可以标记安全漏洞的规则知识库。 它会重点列出违背最佳做法的情况，例如配置不当、权限过度分配以及敏感数据未受保护。

这些规则基于 Microsoft 的最佳做法，并专注于对数据库及其重要数据有最大风险的安全问题。 它们涵盖了数据库级别的问题以及服务器级别的安全问题，例如服务器防火墙设置和服务器级别的权限。

扫描结果包括旨在解决每个问题的可操作步骤，并提供自定义修正脚本（若适用）。 可以通过设置以下各项的可接受基线，来为环境自定义评估报告：

- 权限配置
- 功能配置
- 数据库设置

## <a name="configure-vulnerability-assessment"></a>配置漏洞评估

执行以下步骤可配置漏洞评估：

1. 在 [Azure 门户](https://portal.azure.com)中打开 Azure SQL 数据库、SQL 托管实例数据库或 Azure Synapse 中的特定资源。

1. 在“安全性”标题下，选择“安全中心” 。

1. 选择“配置”，打开整个服务器或托管实例的 Azure Defender for SQL 设置窗格。

    :::image type="content" source="media/sql-vulnerability-assessment/opening-sql-configuration.png" alt-text="打开 Defender for SQL 配置页":::

    > [!NOTE]
    > SQL 漏洞评估要求 Azure Defender for SQL 计划能够运行扫描。 有关如何启用 Azure Defender for SQL 的详细信息，请参阅 [Azure Defender for SQL](azure-defender-for-sql.md)。

1. 在“服务器设置”页中，定义 Azure Defender for SQL 设置：

    :::image type="content" source="media/sql-vulnerability-assessment/sql-vulnerability-scan-settings.png" alt-text="配置 SQL 漏洞评估扫描":::

    1. 配置一个存储帐户，以在其中存储针对服务器或托管实例上所有数据库的扫描结果。 有关存储帐户的详细信息，请参阅[关于 Azure 存储帐户](../../storage/common/storage-account-create.md)。

        > [!TIP]
        > 有关在防火墙和 VNet 后面存储漏洞评估扫描的详细信息，请参阅[将漏洞评估扫描存储在可从防火墙和 Vnet 后面访问的存储帐户中](sql-database-vulnerability-assessment-storage.md)。

    1. 若要将漏洞评估配置为每周自动运行，以检测安全错误配置，请将“定期扫描”设置为“开” 。 结果会发送到你在“发送扫描报告到”中提供的电子邮件地址。 你还可通过启用“向管理员和订阅所有者发送电子邮件通知”，将电子邮件通知发送给管理员和订阅所有者。

1. SQL 漏洞评估扫描也可按需运行：

    1. 在资源的“安全中心”页上，选择“查看漏洞评估中的其他发现”，访问上一次扫描的扫描结果。

        :::image type="content" source="media/sql-vulnerability-assessment/view-additional-findings-link.png" alt-text="打开“扫描结果”和“手动扫描”选项":::

    1. 若要运行按需扫描以扫描数据库中的漏洞，请从工具栏中选择“扫描”：

        :::image type="content" source="media/sql-vulnerability-assessment/on-demand-vulnerability-scan.png" alt-text="将扫描选为运行 SQL 资源的按需运行漏洞评估扫描":::


  > [!NOTE]
  > 扫描是轻型的安全功能。 运行扫描只需花费几秒时间，并且完全是只读操作。 此操作不会对数据库做出任何更改。

## <a name="remediate-vulnerabilities"></a>修正漏洞

漏洞扫描完成时，报告会显示在 Azure 门户中。 报告会显示：

- 安全状态概述
- 发现的问题数，以及
- 根据风险的严重性整理的摘要
- 供进一步调查使用的结果列表

:::image type="content" source="media/sql-vulnerability-assessment/sample-sql-vulnerabilities-report.png" alt-text="SQL 漏洞评估扫描仪中的 Sampl 扫描报告":::

若要修正发现的漏洞：

1. 查看结果并确定报告中发现的哪些问题是环境中真正存在的安全问题。

1. 选择每个失败的结果以了解其影响，以及安全检查失败的原因。

    > [!TIP]
    > 结果详细信息页包括了说明如何解决该问题的可操作的修正信息。

    :::image type="content" source="media/sql-vulnerability-assessment/examining-vulnerability-findings.gif" alt-text="检查漏洞扫描的结果":::

1. 在查看评估结果时，可将特定结果标记为环境中可接受的基线。 基线本质上是对结果报告方式的自定义。 在后续扫描中，与基线相匹配的结果被视为通过。 建立基线安全状态后，漏洞评估仅报告与基线的偏差。 这样，你可以专注于处理相关问题。

    :::image type="content" source="media/sql-vulnerability-assessment/baseline-approval.png" alt-text="批准查找作为基线以便将来进行扫描":::

1. 如果更改基线，请使用“扫描”按钮来运行按需扫描并查看自定义报告。 添加到基线的任何发现将会出现在“通过”中，其中指示了它们因基线更改而通过。

    :::image type="content" source="media/sql-vulnerability-assessment/passed-per-custom-baseline.png" alt-text="通过的评估表明它们已通过每个自定义基线":::

你的漏洞评估扫描现可用于确保数据库维持高级别的安全性，并满足组织策略。

## <a name="advanced-capabilities"></a>高级功能

### <a name="export-an-assessment-report"></a>导出评估报告

选择“导出扫描结果”，创建可供下载的扫描结果 Excel 报表。 此报告包含显示了评估摘要的摘要选项卡。 此报告包括所有失败的检查。 它还包括一个“结果”选项，其中包含全部扫描结果。 结果包括运行的所有检查，以及每项检查的结果详细信息。

### <a name="view-scan-history"></a>查看扫描历史记录

选择漏洞评估窗格中的“扫描历史记录”，查看以前对此数据库运行的所有扫描的历史记录。 选择列表中某个特定扫描，查看该扫描的详细结果。

### <a name="disable-specific-findings-from-azure-security-center-preview"></a>禁用 Azure 安全中心内的特定发现结果（预览）

如果组织需要忽略发现结果，而不是修正漏洞，则可以选择禁用发现结果。 禁用发现结果不会影响安全分数，也不会产生有害的噪音。

当发现结果与在禁用规则中定义的条件相匹配时，它不会显示在发现结果列表中。 典型方案包括：

- 禁用严重性低于中等的结果
- 禁用不可修补的发现结果
- 禁用与定义的范围无关的基准的发现结果

> [!IMPORTANT]
> 若要禁用特定发现结果，你需要拥有在 Azure Policy 中编辑策略的权限。 若要了解详细信息，请参阅 [Azure Policy 中的 Azure RBAC 权限](../../governance/policy/overview.md#azure-rbac-permissions-in-azure-policy)。

若要创建规则，请执行以下操作：

1. 在“应修正关于计算机上 SQL Server 的漏洞评估结果”的建议详细信息页中，选择“禁用规则” 。

1. 选择相关范围。

1. 定义你的条件。 可以使用以下任一条件：
    - 发现结果 ID
    - 严重性
    - 基准

    :::image type="content" source="../../security-center/media/defender-for-sql-on-machines-vulnerability-assessment/disable-rule-vulnerability-findings-sql.png" alt-text="针对在计算机中 SQL Server 上检测到的漏洞评估结果创建禁用规则":::

1. 选择“应用规则”。 更改可能最多需要 24 小时才能生效。

1. 若要查看、替代或删除规则，请执行以下操作： 

    1. 选择“禁用规则”。

    1. 在范围列表中，具有有效规则的订阅显示为“已应用规则”。

        :::image type="content" source="../../security-center/media/remediate-vulnerability-findings-vm/modify-rule.png" alt-text="修改或删除现有规则":::

    1. 若要查看或删除规则，请选择省略号菜单（“...”）。

## <a name="manage-vulnerability-assessments-programmatically"></a>以编程方式管理漏洞评估

# <a name="azure-powershell"></a>[Azure PowerShell](#tab/azure-powershell)

[!INCLUDE [updated-for-az](../../../includes/updated-for-az.md)]
> [!IMPORTANT]
> 仍然支持 PowerShell Azure 资源管理器模块，但是所有未来的开发都是针对 Az.Sql 模块。 若要了解这些 cmdlet，请参阅 [AzureRM.Sql](/powershell/module/AzureRM.Sql/)。 Az 模块和 AzureRm 模块中的命令参数大体上是相同的。

可以使用 Azure PowerShell cmdlet 以编程方式管理漏洞评估。 受支持的 cmdlet 如下：

| Cmdlet 名称（链接） | 说明 |
| :-------------------- | :---------- |
| [Clear-AzSqlDatabaseVulnerabilityAssessmentRuleBaseline](/powershell/module/az.sql/Clear-azSqlDatabaseVulnerabilityAssessmentRuleBaseline) | 清除漏洞评估规则基线。<br/>在使用此 cmdlet 清除基线之前请先设置基线。 |
| [Clear-AzSqlDatabaseVulnerabilityAssessmentSetting](/powershell/module/az.sql/Clear-azSqlDatabaseVulnerabilityAssessmentSetting) | 清除数据库的漏洞评估设置。 |
| [Clear-AzSqlInstanceDatabaseVulnerabilityAssessmentRuleBaseline](/powershell/module/az.sql/Clear-AzSqlInstanceDatabaseVulnerabilityAssessmentRuleBaseline) | 清除托管数据库的漏洞评估规则基线。<br/>在使用此 cmdlet 清除基线之前请先设置基线。 |
| [Clear-AzSqlInstanceDatabaseVulnerabilityAssessmentSetting](/powershell/module/az.sql/Clear-AzSqlInstanceDatabaseVulnerabilityAssessmentSetting) | 清除托管数据库的漏洞评估设置。 |
| [Clear-AzSqlInstanceVulnerabilityAssessmentSetting](/powershell/module/az.sql/Clear-AzSqlInstanceVulnerabilityAssessmentSetting) | 清除托管实例的漏洞评估设置。 |
| [Convert-AzSqlDatabaseVulnerabilityAssessmentScan](/powershell/module/az.sql/Convert-azSqlDatabaseVulnerabilityAssessmentScan) | 将数据库的漏洞评估扫描结果转换为 Excel 文件。 |
| [Convert-AzSqlInstanceDatabaseVulnerabilityAssessmentScan](/powershell/module/az.sql/Convert-AzSqlInstanceDatabaseVulnerabilityAssessmentScan) | 将托管数据库的漏洞评估扫描结果转换为 Excel 文件。 |
| [Get-AzSqlDatabaseVulnerabilityAssessmentRuleBaseline](/powershell/module/az.sql/Get-azSqlDatabaseVulnerabilityAssessmentRuleBaseline) | 获取给定规则的数据库漏洞评估规则基线。 |
| [Get-AzSqlInstanceDatabaseVulnerabilityAssessmentRuleBaseline](/powershell/module/az.sql/Get-AzSqlInstanceDatabaseVulnerabilityAssessmentRuleBaseline) | 获取给定规则的托管数据库漏洞评估规则基线。 |
| [Get-AzSqlDatabaseVulnerabilityAssessmentScanRecord](/powershell/module/az.sql/Get-azSqlDatabaseVulnerabilityAssessmentScanRecord) | 获取与给定数据库关联的所有漏洞评估扫描记录。 |
| [Get-AzSqlInstanceDatabaseVulnerabilityAssessmentScanRecord](/powershell/module/az.sql/Get-AzSqlInstanceDatabaseVulnerabilityAssessmentScanRecord) | 获取与给定托管数据库关联的所有漏洞评估扫描记录。 |
| [Get-AzSqlDatabaseVulnerabilityAssessmentSetting](/powershell/module/az.sql/Get-azSqlDatabaseVulnerabilityAssessmentSetting) | 返回数据库的漏洞评估设置。 |
| [Get-AzSqlInstanceDatabaseVulnerabilityAssessmentSetting](/powershell/module/az.sql/Get-AzSqlInstanceDatabaseVulnerabilityAssessmentSetting) | 返回托管数据库的漏洞评估设置。 |
| [Set-AzSqlDatabaseVulnerabilityAssessmentRuleBaseline](/powershell/module/az.sql/Set-azSqlDatabaseVulnerabilityAssessmentRuleBaseline) | 设置漏洞评估规则基线。 |
| [Set-AzSqlInstanceDatabaseVulnerabilityAssessmentRuleBaseline](/powershell/module/az.sql/Set-AzSqlInstanceDatabaseVulnerabilityAssessmentRuleBaseline) | 设置托管数据库的漏洞评估规则基线。 |
| [Start-AzSqlDatabaseVulnerabilityAssessmentScan](/powershell/module/az.sql/Start-azSqlDatabaseVulnerabilityAssessmentScan) | 触发对于数据库的漏洞评估扫描的启动。 |
| [Start-AzSqlInstanceDatabaseVulnerabilityAssessmentScan](/powershell/module/az.sql/Start-AzSqlInstanceDatabaseVulnerabilityAssessmentScan) | 触发对于托管数据库的漏洞评估扫描的启动。 |
| [Update-AzSqlDatabaseVulnerabilityAssessmentSetting](/powershell/module/az.sql/Update-azSqlDatabaseVulnerabilityAssessmentSetting) | 更新数据库的漏洞评估设置。 |
| [Update-AzSqlInstanceDatabaseVulnerabilityAssessmentSetting](/powershell/module/az.sql/Update-AzSqlInstanceDatabaseVulnerabilityAssessmentSetting) | 更新托管数据库的漏洞评估设置。 |
| [Update-AzSqlInstanceVulnerabilityAssessmentSetting](/powershell/module/az.sql/Update-AzSqlInstanceVulnerabilityAssessmentSetting) | 更新托管实例的漏洞评估设置。 |
| &nbsp; | &nbsp; |

有关脚本示例，请参阅 [Azure SQL 漏洞评估 PowerShell 支持](/archive/blogs/sqlsecurity/azure-sql-vulnerability-assessment-now-with-powershell-support)。

# <a name="azure-cli"></a>[Azure CLI](#tab/azure-cli)

> [!IMPORTANT]
> 以下 Azure CLI 命令适用于在 VM 或本地计算机上托管的 SQL 数据库。 有关涉及 Azure SQL 数据库的漏洞评估，请参阅“Azure 门户”或“PowerShell”部分。

可以使用 Azure CLI 以编程方式管理漏洞评估。 支持的命令为：

| 链接形式的命令名称 | 说明 |
| :-------------------- | :---------- |
| [az security va sql baseline delete](/cli/azure/security/va/sql/baseline#az_security_va_sql_baseline_delete) | 删除 SQL 漏洞评估规则基线。 |
| [az security va sql baseline list](/cli/azure/security/va/sql/baseline#az_security_va_sql_baseline_list) | 查看所有规则的 SQL 漏洞评估基线。 |
| [az security va sql baseline set](/cli/azure/security/va/sql/baseline#az_security_va_sql_baseline_set) | 获取 SQL 漏洞评估基线。 替换当前基线。 |
| [az security va sql baseline show](/cli/azure/security/va/sql/baseline#az_security_va_sql_baseline_show) | 查看 SQL 漏洞评估规则基线。 |
| [az security va sql baseline update](/cli/azure/security/va/sql/baseline#az_security_va_sql_baseline_update) | 更新 SQL 漏洞评估规则基线。 替换当前规则基线。 |
| [az security va sql results list](/cli/azure/security/va/sql/results#az_security_va_sql_results_list) | 查看所有 SQL 漏洞评估扫描结果。 |
| [az security va sql results show](/cli/azure/security/va/sql/results#az_security_va_sql_results_show) | 查看 SQL 漏洞评估扫描结果。 |
| [az security va sql scans list](/cli/azure/security/va/sql/scans#az_security_va_sql_scans_list) | 列出所有 SQL 漏洞评估扫描摘要。 |
| [az security va sql scans show](/cli/azure/security/va/sql/scans#az_security_va_sql_scans_show) | 查看 SQL 漏洞评估扫描摘要。 |
| &nbsp; | &nbsp; |

---

### <a name="using-resource-manager-templates"></a>使用资源管理器模板

若要使用 Azure 资源管理器模板配置漏洞评估基线，请使用 `Microsoft.Sql/servers/databases/vulnerabilityAssessments/rules/baselines` 类型。

在添加基线之前，请确保已启用 `vulnerabilityAssessments`。

下面是一个示例，演示了如何将 `master` 数据库的基线规则 VA2065 和 `user` 数据库的基线规则 VA1143 定义为资源管理器模板中的资源：

```json
   "resources": [
      {
         "type": "Microsoft.Sql/servers/databases/vulnerabilityAssessments/rules/baselines",
         "apiVersion": "2018-06-01-preview",
         "name": "[concat(parameters('server_name'),'/', parameters('database_name') , '/default/VA2065/master')]",
         "properties": {
            "baselineResults": [
               {
                  "result": [
                     "FirewallRuleName3",
                     "StartIpAddress",
                     "EndIpAddress"
                  ]
               },
               {
                  "result": [
                     "FirewallRuleName4",
                     "62.92.15.68",
                     "62.92.15.68"
                  ]
               }
            ]
         },
         "type": "Microsoft.Sql/servers/databases/vulnerabilityAssessments/rules/baselines",
         "apiVersion": "2018-06-01-preview",
         "name": "[concat(parameters('server_name'),'/', parameters('database_name'), '/default/VA2130/Default')]",
         "dependsOn": [
            "[resourceId('Microsoft.Sql/servers/vulnerabilityAssessments', parameters('server_name'), 'Default')]"
         ],
         "properties": {
            "baselineResults": [
               {
                  "result": [
                     "dbo"
                  ]
               }
            ]
         }
      }
   ]
```

对于 `master` 数据库和 `user` 数据库，资源名称的定义方式不同：

- Master 数据库 - "name": "[concat(parameters('server_name'),'/', parameters('database_name') , '/default/VA2065/<b>master</b>')]",
- 用户数据库 - "name": "[concat(parameters('server_name'),'/', parameters('database_name') , '/default/VA2065/<b>default</b>')]",

若要将布尔类型处理为 true/false，请使用二进制输入（例如 "1"/"0"）设置基线结果。

```json
   {
      "type": "Microsoft.Sql/servers/databases/vulnerabilityAssessments/rules/baselines",
      "apiVersion": "2018-06-01-preview",
      "name": "[concat(parameters('server_name'),'/', parameters('database_name'), '/default/VA1143/Default')]",

      "dependsOn": [
         "[resourceId('Microsoft.Sql/servers/vulnerabilityAssessments', parameters('server_name'), 'Default')]"
      ],

      "properties": {
         "baselineResults": [
            {
               "result": [
                  "1"
               ]
            }
         ]
      }

   }
```

## <a name="data-residency"></a>数据驻留

SQL 漏洞评估使用安全中心 SQL 漏洞评估建议下的公开可用查询来查询 SQL 服务器，并存储查询结果。 数据存储在已配置的用户拥有的存储帐户中。 

SQL 漏洞评估允许通过选择存储帐户的位置来指定存储数据的区域。 用户负责存储帐户的安全性和数据复原能力。

## <a name="next-steps"></a>后续步骤  

- 详细了解 [Azure Defender for SQL](azure-defender-for-sql.md)。
- 详细了解[数据发现和分类](data-discovery-and-classification-overview.md)。
- 了解关于[将漏洞评估扫描结果存储在可从防火墙和 VNet 后面访问的存储帐户中](sql-database-vulnerability-assessment-storage.md)的详细信息。
