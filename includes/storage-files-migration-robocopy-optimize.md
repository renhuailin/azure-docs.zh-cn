---
title: include 文件
description: include 文件
services: storage
author: fauhse
ms.service: storage
ms.topic: include
ms.date: 4/05/2021
ms.author: fauhse
ms.custom: include file
ms.openlocfilehash: 12a11fadaa7a98b9a5d2d9f81cf91dfa26680f56
ms.sourcegitcommit: 7d63ce88bfe8188b1ae70c3d006a29068d066287
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 07/22/2021
ms.locfileid: "114462175"
---
给定 RoboCopy 运行的速度和成功率将取决于以下几个因素：

* 源和目标存储上的 IOPS
* 源和目标之间的可用网络带宽
* 快速处理命名空间中的文件和文件夹的能力
* RoboCopy 运行之间的更改数


### <a name="iops-and-bandwidth-considerations"></a>IOPS 和带宽注意事项

在此类别中，你需要考虑源存储、目标存储以及连接这两者的网络的能力  。 可能的最大吞吐量由这三个组成部分中的最慢者决定。 请确保将网络基础结构配置为支持最佳传输速度来达到其最佳性能。

> [!CAUTION]
> 尽管最理想的结果通常是尽可能快地复制，但还要考虑将本地网络和 NAS 设备用于其他（通常是业务关键的）任务。

当存在迁移可能独占可用资源的风险时，尽可能快地复制可能不可取。

* 请考虑在你的环境中最适合运行迁移的时间：白天、非工作时间或周末。
* 还请考虑在 Windows Server 上设立网络 QoS 来限制 RoboCopy 速度。
* 避免迁移工具不必要的工作。

RoboCopy 可通过指定 `/IPG:n` 开关来插入数据包间延迟，其中 `n` 是 RoboCopy 数据包之间的时间间隔（以毫秒为单位）。 使用此开关有助于避免 IO 受限设备和拥堵网络链路上的资源独占。

`/IPG:n` 无法用于将带宽限制精确到特定 Mbps。 请改用 Windows Server 网络 QoS。 RoboCopy 完全依靠 SMB 协议来满足各项网络需求。 使用 SMB 导致 RoboCopy 无法影响网络吞吐量本身，但它可减慢其使用速度。 

类似的思路也适用于在 NAS 上观察到的 IOPS。 NAS 卷上的群集大小、数据包大小和一系列其他因素都会影响 IOPS 观测值。 引入数据包间延迟通常是控制 NAS 上的负载的最简单方法。 测试多个值，例如从大约 20 毫秒 (n=20) 到该数字的倍数。 引入延迟后，可评估其他应用现在是否可按预期方式工作。 通过此优化策略，你可在环境中找到最佳的 RoboCopy 速度。

### <a name="processing-speed"></a>处理速度

RoboCopy 将遍历它指向的命名空间，并评估每个文件和文件夹是否适合复制。 在初始复制和追加复制期间将评估每个文件。 例如，对相同的源和目标存储位置重复运行 RoboCopy/MIR。 这些重复运行有助于最大程度地减少用户和应用的停机时间，同时提高迁移文件的总体成功率。

我们通常默认带宽是迁移过程中的最大限制因素，也可能的确如此。 但枚举命名空间的能力可能会影响复制的总时间，对于包含更小文件的更大命名空间来说，复制总时间甚至更长。 思考一下，与复制总大小 1 TiB，但数量更少的更大文件相比，复制 1 TiB 的小文件所耗时间要长得多。 假设其他所有变量都保持不变。

导致这种差异的原因是遍历命名空间所需的处理能力。 RoboCopy 通过 `/MT:n` 参数支持多线程复制，其中 n 表示要使用的线程数。 因此，在专门为 RoboCopy 预配计算机时，请考虑处理器核心的数量及其与提供的线程计数的关系。 最常见的是每个核心两个线程。 计算机的核心和线程计数是一个重要的数据点，可决定应该指定的多线程值 `/MT:n`。 还应考虑计划在给定计算机上并行运行的 RoboCopy 作业的数目。

与更少的线程相比，线程更多可更快地复制 1-TiB 的小文件。 同时，对 1 TiB 更大文件投入额外资源可能不会产生成比例的效益。 如果线程数较高，则会尝试通过网络同时复制更多的大文件。 这种额外的网络活动增加了受吞吐量或存储 IOPS 限制的可能性。

在第一次 RoboCopy 到空目标或使用大量更改文件的差异运行期间，你可能会受到网络吞吐量的限制。 在初始运行时，以较高的线程数开始。 较高的线程数（甚至超过计算机上当前可用的线程）有助于使可用网络带宽饱和。 后续 /MIR 运行会逐渐受到处理项的影响。 差异运行中的更改越少，通过网络传输的数据就越少。 相比于通过网络链接来移动命名空间项，你的速度现在更取决于处理命名空间项的能力。 对于后续运行，请将线程计数值与处理器核心计数和每个核心的线程计数相匹配。 考虑是否需要为生产服务器可能具有的其他任务预留核心。

> [!TIP]
> 经验法则：第一次运行 RoboCopy 时（将移动高延迟网络中的大量数据）受益于过度预配线程计数 (`/MT:n`)。 后续运行将复制较少的差异，更有可能从网络吞吐量受限转变为计算受限。 在这些情况下，通常最好将 robocopy 线程计数与计算机上实际可用的线程数相匹配。 在这种情况下，过度预配可能会导致处理器产生更多与情景相关的波动，从而可能会减慢复制速度。

### <a name="avoid-unnecessary-work"></a>避免不必要的工作

避免在命名空间中进行大规模更改。 例如，在目录之间移动文件、大规模更改属性或更改权限 (NTFS ACL)。 尤其是 ACL 更改可能会产生很大的影响，因为它们通常对文件夹层次结构中位置较低的文件具有级联更改效果。 可能产生如下后果：

* 延长 RoboCopy 作业运行时，因为受 ACL 更改影响的每个文件和文件夹都需要更新
* 重用先前移动的数据可能需要重新复制。 例如，如果在早先复制文件后文件夹结构发生更改，则需要复制更多数据。 RoboCopy 作业无法“回放”命名空间更改。 下一个作业必须清除先前传输到旧文件夹结构中的文件，然后再次将文件上传到新文件夹结构中。

另一个重要方面是有效使用 RoboCopy 工具。 借助推荐的 RoboCopy 脚本，你将创建一个日志文件来放置错误并保存该文件。 可能会发生复制错误，这是正常的。 这些错误通常使得必须运行多轮复制工具，例如 RoboCopy。 有一个初始运行，例如从 NAS 到 DataBox 或从服务器到 Azure 文件共享。 还会使用 /MIR 开关执行一次或多次额外运行，以捕获并重试未复制的文件。

应最好准备来针对给定的命名空间范围运行多轮 RoboCopy。 后续运行将更快完成，因为它们需要复制的内容更少，但会越来越多地受到命名空间的处理速度限制。 运行多轮复制时，可禁止 RoboCopy 尝试在给定的运行中过度复制所有内容来加快每一轮的速度。 这些 RoboCopy 开关可造成很大的差异：

* `/R:n` n = 重试复制失败文件的频率 
* `/W:n` n = 两次重试之间需等待的秒数

`/R:5 /W:5` 是一个合理的设置，你可根据自己的喜好进行调整。 在本例中，失败的文件将重试 5 次，两次重试之间有 5 秒的等待时间。 如果文件仍无法复制，则下一个 RoboCopy 作业将重试。 通常，由于正在使用或超时问题而失败的文件最终可能会以这种方式成功复制。
